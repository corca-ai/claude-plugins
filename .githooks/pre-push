#!/usr/bin/env bash
set -euo pipefail

PROFILE="strict"
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"
CWF_LINK_CHECKER="plugins/cwf/skills/refactor/scripts/check-links.sh"
CWF_INDEX_COVERAGE="plugins/cwf/skills/setup/scripts/check-index-coverage.sh"
CWF_PROVENANCE="plugins/cwf/scripts/provenance-check.sh"
CWF_GROWTH_DRIFT="plugins/cwf/scripts/check-growth-drift.sh"
CWF_SCRIPT_DEPS="plugins/cwf/scripts/check-script-deps.sh"
CWF_README_STRUCTURE="plugins/cwf/scripts/check-readme-structure.sh"

mapfile -t md_files < <(
  git ls-files '*.md' '*.mdx' \
    | grep -Ev '^(\.cwf/projects/|\.cwf/sessions/|\.cwf/prompt-logs/|references/anthropic-skills-guide/)' || true
)

if [ "${#md_files[@]}" -gt 0 ]; then
  echo "[pre-push] markdownlint on tracked markdown files..."
  npx --yes markdownlint-cli2 "${md_files[@]}"
else
  echo "[pre-push] no markdown files found; skipping markdownlint"
fi

if [[ "$PROFILE" != "fast" ]]; then
  echo "[pre-push] local link validation..."
  bash "$CWF_LINK_CHECKER" --local --json

  if [[ -x "$CWF_INDEX_COVERAGE" ]]; then
    echo "[pre-push] index coverage checks..."
    if [[ -f AGENTS.md ]]; then
      bash "$CWF_INDEX_COVERAGE" AGENTS.md --profile repo
    fi
    if [[ -f .cwf/indexes/cwf-index.md ]]; then
      bash "$CWF_INDEX_COVERAGE" .cwf/indexes/cwf-index.md --profile cap
    fi
  else
    echo "[pre-push] $CWF_INDEX_COVERAGE missing or not executable" >&2
    exit 1
  fi
fi

if [[ "$PROFILE" == "strict" ]]; then
  if [[ -x "$CWF_SCRIPT_DEPS" ]]; then
    echo "[pre-push] runtime script dependency checks..."
    bash "$CWF_SCRIPT_DEPS" --strict
  else
    echo "[pre-push] $CWF_SCRIPT_DEPS missing or not executable" >&2
    exit 1
  fi

  if [[ -x "$CWF_README_STRUCTURE" ]]; then
    echo "[pre-push] README structure checks..."
    bash "$CWF_README_STRUCTURE" --strict
  else
    echo "[pre-push] $CWF_README_STRUCTURE missing or not executable" >&2
    exit 1
  fi

  if [[ -x "$CWF_PROVENANCE" ]]; then
    echo "[pre-push] provenance freshness report (inform)..."
    bash "$CWF_PROVENANCE" --level inform
  else
    echo "[pre-push] $CWF_PROVENANCE missing; skipping provenance report" >&2
  fi

  if [[ -x "$CWF_GROWTH_DRIFT" ]]; then
    echo "[pre-push] growth-drift report (inform)..."
    bash "$CWF_GROWTH_DRIFT" --level inform
  else
    echo "[pre-push] $CWF_GROWTH_DRIFT missing; skipping growth-drift report" >&2
  fi
fi
