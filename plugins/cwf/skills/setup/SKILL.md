---
name: setup
description: |
  Initial CWF configuration: hook group selection, external tool detection,
  optional Codex user-scope skill sync, and optional progressive disclosure index generation
  (to cwf-index.md and/or AGENTS.md embedded block).
  Triggers: "cwf:setup", "setup hooks", "configure cwf"
allowed-tools:
  - Read
  - Write
  - Edit
  - Bash
  - Glob
  - Grep
  - AskUserQuestion
---

# Setup

Initial CWF configuration. Interactive hook toggle, external tool detection, optional Codex skill sync, and optional progressive disclosure index generation.

**Language**: Write config files in English. Communicate with the user in their prompt language.

## Quick Start

```text
cwf:setup                # Full setup (hooks + tools + optional index prompt)
cwf:setup --hooks        # Hook group selection only
cwf:setup --tools        # External tool detection only
cwf:setup --codex        # Sync CWF skills into Codex user scope (~/.agents/skills)
cwf:setup --codex-wrapper # Optional Codex wrapper install for session log sync
cwf:setup --index        # Generate/refresh index output (explicit)
cwf:setup --index --target file   # cwf-index.md only (default)
cwf:setup --index --target agents # AGENTS.md managed block only
cwf:setup --index --target both   # cwf-index.md + AGENTS.md block
```

## Mode Routing

Parse input flags and run only the relevant phases:

| Input | Phases |
|-------|--------|
| `cwf:setup` | 1 → 2 → 2.4 (if codex available) → 3 (opt-in) → 4 |
| `cwf:setup --hooks` | 1 → 4 |
| `cwf:setup --tools` | 2 → 4 |
| `cwf:setup --codex` | 2.5 → 4 |
| `cwf:setup --codex-wrapper` | 2.6 → 4 |
| `cwf:setup --index [--target file\|agents\|both]` | 3 → 4 |

When mode is full setup and Codex CLI is available, do not silently skip Codex integration; always run Phase 2.4 and ask the user which integration level to apply.

---

## Phase 1: Hook Group Selection

Configure which hook groups are active. Default: all enabled (hooks work without running cwf:setup).

### 1.1 Read Current State

Read `cwf-state.yaml` `hooks:` section for current toggle state.

### 1.2 Present Selection

Use AskUserQuestion with `multiSelect: true`. Present 7 hook groups with descriptions:

| Group | Description |
|-------|-------------|
| `attention` | Slack notifications on idle/waiting |
| `log` | Auto-log turns + auto-commit transcripts |
| `read` | File-size aware reading guard |
| `lint_markdown` | Markdown validation after Write/Edit |
| `lint_shell` | ShellCheck validation after Write/Edit |
| `websearch_redirect` | Redirect WebSearch to cwf:gather |
| `compact_recovery` | Inject live session state after auto-compact |

Pre-select groups that are currently enabled in `cwf-state.yaml`.

### 1.3 Write Hook Config

Write `~/.claude/cwf-hooks-enabled.sh`:

```bash
# Generated by cwf:setup
export HOOK_ATTENTION_ENABLED="true"
export HOOK_LOG_ENABLED="true"
export HOOK_READ_ENABLED="true"
export HOOK_LINT_MARKDOWN_ENABLED="false"
export HOOK_LINT_SHELL_ENABLED="true"
export HOOK_WEBSEARCH_REDIRECT_ENABLED="true"
export HOOK_COMPACT_RECOVERY_ENABLED="true"
```

- One `export HOOK_{GROUP}_ENABLED` line per group (uppercased)
- Values: `"true"` or `"false"` (quoted strings)
- Must match the variable names expected by `cwf-hook-gate.sh`

### 1.4 Update cwf-state.yaml

Edit `cwf-state.yaml` `hooks:` section to mirror the selections:

```yaml
hooks:
  attention: true
  log: true
  read: true
  lint_markdown: false
  lint_shell: true
  websearch_redirect: true
  compact_recovery: true
```

---

## Phase 2: External Tool Detection

Detect availability of external AI tools and search APIs.

### 2.1 Check Tools

Run the following checks via Bash:

```bash
command -v codex >/dev/null 2>&1     # Codex CLI
command -v gemini >/dev/null 2>&1 || npx @google/gemini-cli --version 2>/dev/null  # Gemini CLI
```

Check environment variables:

```bash
[ -n "${TAVILY_API_KEY:-}" ]         # Tavily search API
[ -n "${EXA_API_KEY:-}" ]            # Exa search API
```

### 2.2 Update cwf-state.yaml

Edit `cwf-state.yaml` `tools:` section with results:

```yaml
tools:
  codex: available      # or "unavailable"
  gemini: available     # or "unavailable"
  tavily: available     # or "unavailable"
  exa: unavailable      # or "available"
```

### 2.3 Report Results

Display results as a table:

```text
Tool Detection Results:
  codex   : available
  gemini  : available
  tavily  : unavailable (TAVILY_API_KEY not set)
  exa     : unavailable (EXA_API_KEY not set)
```

---

## Phase 2.4: Codex Integration on Full Setup

Use this phase when:
- Mode is full setup (`cwf:setup`)
- Phase 2 detected `codex: available`

### 2.4.1 Ask Integration Level

Use AskUserQuestion (single choice):

```text
Codex CLI was detected. How should CWF integrate with Codex?
```

Options:
- `Skills + wrapper (recommended)`:
  - Link CWF skills/references into `~/.agents/*`
  - Install `codex` wrapper and PATH line for automatic session log sync
- `Skills only`:
  - Link skills/references only (no wrapper install)
- `Skip for now`:
  - Do not change Codex integration in this run

### 2.4.2 Execute Selection

If `Skills + wrapper (recommended)`:

```bash
bash {SKILL_DIR}/../../scripts/codex/sync-skills.sh --cleanup-legacy
bash {SKILL_DIR}/../../scripts/codex/install-wrapper.sh --enable --add-path
bash {SKILL_DIR}/../../scripts/codex/install-wrapper.sh --status
```

If `Skills only`:

```bash
bash {SKILL_DIR}/../../scripts/codex/sync-skills.sh --cleanup-legacy
```

If `Skip for now`: no command execution in this phase.

### 2.4.3 Always Print Post-Setup Verification

When wrapper install was selected, always report:

```bash
bash {SKILL_DIR}/../../scripts/codex/install-wrapper.sh --status
type -a codex
```

And include this note in plain language:

```text
Open a new shell (or source ~/.zshrc). After that, running `codex` will auto-sync session logs.
Aliases that call `codex` (for example: codexyolo='codex ...') also inherit this behavior.
```

---

## Phase 2.5: Codex User-Scope Skill Sync (Optional)

Use this phase when:
- User runs `cwf:setup --codex`
- Full setup and user wants Codex to load CWF from local repo via symlink

### 2.5.1 Run Sync Script

Run:

```bash
bash {SKILL_DIR}/../../scripts/codex/sync-skills.sh --cleanup-legacy
```

Expected behavior:
- Link CWF skills from `plugins/cwf/skills/*` into `~/.agents/skills`
- Link shared references into `~/.agents/references`
- Move legacy custom entries from `~/.codex/skills` to backup (`.system` is kept)
- Validate relative skill references via `{SKILL_DIR}/../../scripts/codex/verify-skill-links.sh`

### 2.5.2 Report Results

Report:
- Number of linked skills
- Destination paths (`~/.agents/skills`, `~/.agents/references`)
- Whether legacy `~/.codex/skills` was moved and backup path
- Quick verification command:

```bash
ls -la ~/.agents/skills
```

---

## Phase 2.6: Codex Wrapper Opt-In (Optional)

Use this phase when:
- User runs `cwf:setup --codex-wrapper`
- Full setup and user wants Codex session logs auto-synced into repo artifacts

### 2.6.1 Ask for Opt-In

Use AskUserQuestion before making shell-level changes:

```text
Enable Codex wrapper for automatic session log sync?
```

If user declines, skip this phase.

### 2.6.2 Install Wrapper (Approved Only)

Run:

```bash
bash {SKILL_DIR}/../../scripts/codex/install-wrapper.sh --enable --add-path
```

This installs a wrapper symlink at `~/.local/bin/codex` pointing to:

```text
{SKILL_DIR}/../../scripts/codex/codex-with-log.sh
```

The wrapper preserves normal Codex behavior and runs:

```bash
bash {SKILL_DIR}/../../scripts/codex/sync-session-logs.sh --cwd "$PWD"
```

after each Codex run to persist markdown logs under `prompt-logs/sessions/` as `*.codex.md` (legacy `sessions-codex/` remains readable during migration; `raw` JSONL copy is opt-in via `--raw`).

### 2.6.3 Report and Reversal

Report current status:

```bash
bash {SKILL_DIR}/../../scripts/codex/install-wrapper.sh --status
```

Provide rollback command:

```bash
bash {SKILL_DIR}/../../scripts/codex/install-wrapper.sh --disable
```

Include activation note:

```text
If wrapper is active, restart shell (or source ~/.zshrc) before testing `codex`.
```

---

## Phase 3: Generate Progressive Disclosure Index

Create a progressive disclosure index for the project: pointers to key areas, not content summaries.

### 3.0 Entry and Safety Rules

When mode is full setup (`cwf:setup`):

1. Ask with AskUserQuestion (single choice):
   ```text
   Generate progressive disclosure index now?
   ```
2. Options:
   - `Yes (Recommended)`:
     - Continue to output-target question (3.0.2).
   - `No`:
     - Skip Phase 3.

### 3.0.2 Output Target Selection

When generating index output (full setup opted-in, or `--index` mode), choose target:

- `file` (recommended): write [cwf-index.md](../../../../cwf-index.md)
- `agents`: update managed index block in [AGENTS.md](../../../../AGENTS.md)
- `both`: write [cwf-index.md](../../../../cwf-index.md) and update [AGENTS.md](../../../../AGENTS.md) block

Target resolution:

1. If command includes `--target file|agents|both`, use it.
2. Otherwise ask AskUserQuestion (single choice):
   ```text
   Where should the generated index be written?
   ```
3. Default to `file` if no explicit preference is available.

Managed AGENTS block markers:

```markdown
<!-- CWF:INDEX:START -->
...generated index body...
<!-- CWF:INDEX:END -->
```

If [AGENTS.md](../../../../AGENTS.md) does not exist and target is `agents` or `both`, create it with a minimal scaffold and the managed block.

### 3.1 Scan Project Structure

Use Glob to find top-level directories. Exclude hidden directories (`.git`, `.claude`), `node_modules`, and `prompt-logs`.

### 3.2 Build Index

For each area, generate:

```markdown
## {area}

- **Role**: {one-line scope statement describing what this area owns and why}
- **Key files**: {2-5 most important files as markdown links}
```

- Keep `Role` as what/why guidance (scope + intent), not procedural trigger text.
- Ensure every internal file/directory path is rendered as `[path](path)`.

### 3.3 Write cwf-index.md

Write to project root [cwf-index.md](../../../../cwf-index.md). Include a header noting it was generated by cwf:setup and can be regenerated.

Write behavior by mode:
- Full setup (`cwf:setup`): if target includes `file`, create only if [cwf-index.md](../../../../cwf-index.md) is missing.
- Explicit index mode (`cwf:setup --index`): if target includes `file`, create or overwrite.

```markdown
# CWF Index

> Generated by `cwf:setup --index`.

{areas}
```

### 3.4 Update AGENTS.md Managed Block (target=agents|both)

When target includes `agents`, write the same generated index body into the managed block in [AGENTS.md](../../../../AGENTS.md):

- If markers exist, replace only the marker-delimited section.
- If markers are absent, append a new managed block at the end of [AGENTS.md](../../../../AGENTS.md).
- In full setup mode, this block update is allowed (managed region) even when avoiding file-level overwrite elsewhere.

---

## Phase 4: Lessons Checkpoint

### 4.1 Ask for Learnings

Ask the user: "Any learnings from the setup process?"

If yes, append to `lessons.md` in the current session's prompt-logs directory using the standard format:

```markdown
### {title}

- **Expected**: {what was anticipated}
- **Actual**: {what was discovered}
- **Takeaway**: {key insight}
```

### 4.2 Update Stage Checkpoints

Add `setup` to `cwf-state.yaml` current session's `stage_checkpoints` list.

---

## Rules

1. **Default-enabled**: Hooks work without cwf:setup. This skill creates config for customizing (disabling specific groups).
2. **cwf-state.yaml is SSOT**: Read before modifying. Edit, do not overwrite.
3. **Index policy**: In full setup, ask first. Default target is `file` ([cwf-index.md](../../../../cwf-index.md)). Do not overwrite existing [cwf-index.md](../../../../cwf-index.md) in full setup. Use `cwf:setup --index` for explicit regeneration/overwrite.
4. **AGENTS block policy**: When target includes `agents`, update only the managed marker block (`CWF:INDEX:START/END`) and preserve all other content.
5. **Index content**: Pointers, not summaries. Include `Role` + `Key files`, keep role text what/why oriented, and avoid content duplication.
6. **Link policy**: Internal files/directories in generated index content must be markdown links (`[path](path)`), not inline literals.
7. **Bash 3.2 compatible output**: `cwf-hooks-enabled.sh` uses only `export` lines with quoted string values.
8. **AskUserQuestion for all choices**: No batch defaults. Always ask.
9. **Idempotent**: Re-running updates existing config, does not duplicate.
10. **All code fences must have language specifier**: Never use bare fences.
11. **Codex sync uses symlink + backup move**: Do not delete user files directly.

## References

- [cwf-hook-gate.sh](../../hooks/scripts/cwf-hook-gate.sh) — hook gate mechanism
- [hooks.json](../../hooks/hooks.json) — hook definitions
- [agent-patterns.md](../../references/agent-patterns.md) — Single pattern
- [sync-skills.sh](../../scripts/codex/sync-skills.sh) — Codex user-scope skill sync
- [verify-skill-links.sh](../../scripts/codex/verify-skill-links.sh) — Codex skill link validation
