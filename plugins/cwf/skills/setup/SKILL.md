---
name: setup
description: "Initial CWF configuration to standardize environment/tool contracts before workflow execution: hook group selection, external tool detection, env migration + project config bootstrap, optional Agent Team mode setup, optional Codex integration, optional git hook gate installation, optional CWF capability index generation, and optional repository index generation. Triggers: \"cwf:setup\", \"setup hooks\", \"configure cwf\""
---

# Setup

Standardize hooks, tool contracts, and environment wiring once so later workflow runs stay reproducible. Includes interactive hook toggles, external tool detection, env migration/bootstrap, optional Agent Team mode setup, optional Codex integration, optional git hook gate installation, optional CWF capability index generation, and optional repository index generation.

**Language**: Write config files in English. Communicate with the user in their prompt language.

## Quick Start

```text
cwf:setup                # Full setup (hooks + tools + env + Agent Team + optional Codex/repo-index prompts)
cwf:setup --hooks        # Hook group selection only
cwf:setup --tools        # External tool detection only
cwf:setup --env          # Environment variable migration/bootstrap only
cwf:setup --agent-teams  # Agent Team mode setup only
cwf:setup --run-mode     # Configure default cwf:run ambiguity mode only
cwf:setup --codex        # Codex integration-only rerun (scope-aware skills/references sync)
cwf:setup --codex-wrapper # Codex wrapper-only rerun (scope-aware wrapper setup)
cwf:setup --git-hooks both --gate-profile balanced  # Install repo git hooks and set gate depth
cwf:setup --git-hooks pre-commit --gate-profile fast # Lightweight local-only git gate
cwf:setup --git-hooks none # Remove repo-managed git hooks
cwf:setup --cap-index    # Generate/refresh CWF capability index only
cwf:setup --repo-index   # Generate/refresh repository index (explicit)
cwf:setup --repo-index --target agents # AGENTS.md managed block (recommended)
```

Operational note:
- Prefer `cwf:setup` first; it is the default entrypoint and asks for optional integrations when relevant.
- Use `--codex` / `--codex-wrapper` when reapplying only Codex-related integration pieces.

## Mode Routing

Parse input flags and run only the relevant phases:

| Input | Phases |
|-------|--------|
| `cwf:setup` | 1 → 2 → 2.8 → 2.9 → 2.10 → 2.4 (if codex available) → 2.7 (always ask) → 4 (opt-in) → 5 |
| `cwf:setup --hooks` | 1 → 5 |
| `cwf:setup --tools` | 2 → 2.8 → 2.9 → 2.10 → 5 |
| `cwf:setup --env` | 2.8 → 2.10 → 5 |
| `cwf:setup --agent-teams` | 2.9 → 5 |
| `cwf:setup --run-mode` | 2.10 → 5 |
| `cwf:setup --codex` | 2.5 → 5 |
| `cwf:setup --codex-wrapper` | 2.6 → 5 |
| `cwf:setup --git-hooks <none\|pre-commit\|pre-push\|both> [--gate-profile <fast\|balanced\|strict>]` | 2.7 → 5 |
| `cwf:setup --cap-index` | 3 → 5 |
| `cwf:setup --repo-index [--target agents]` | 4 → 5 |

When mode is full setup and Codex CLI is available, do not silently skip Codex integration; always run Phase 2.4 and ask the user which integration level to apply.

When mode is full setup, do not expect users to supply optional flags manually. Always ask for git hook installation mode and gate profile in Phase 2.7.

When mode is full setup or tools-only setup, always run Phase 2.8 so legacy env keys are migrated to canonical names and project config files are bootstrapped with explicit user choice.

When mode is full setup or tools-only setup, always run Phase 2.9 so Agent Team mode is explicitly aligned with CWF's multi-agent workflow assumptions.

When mode is full setup, tools-only setup, env-only setup, or run-mode-only setup, always run Phase 2.10 so `cwf:run` default ambiguity policy is explicit and reproducible.

---

## Phase 1: Hook Group Selection

Configure which hook groups are active. Default: all enabled (hooks work without running cwf:setup).

### 1.1 Read Current State

Read `cwf-state.yaml` `hooks:` section for current toggle state.

### 1.2 Present Selection

Use AskUserQuestion with `multiSelect: true`. Present 9 hook groups with descriptions:

| Group | Description |
|-------|-------------|
| `attention` | Slack notifications on idle/waiting |
| `log` | Auto-log turns + auto-commit transcripts |
| `read` | File-size aware reading guard |
| `lint_markdown` | Markdown validation after Write/Edit |
| `lint_shell` | ShellCheck validation after Write/Edit |
| `deletion_safety` | Blocks risky file deletions and requires policy-compliant justification |
| `workflow_gate` | Enforces workflow stage/branch safety rules before edits and commands |
| `websearch_redirect` | Redirect WebSearch to cwf:gather |
| `compact_recovery` | Inject live session state after auto-compact and guard session↔worktree binding on prompts |

Pre-select groups that are currently enabled in `cwf-state.yaml`.

### 1.3 Write Hook Config

Write `~/.claude/cwf-hooks-enabled.sh`:

```bash
# Generated by cwf:setup
export HOOK_ATTENTION_ENABLED="true"
export HOOK_LOG_ENABLED="true"
export HOOK_READ_ENABLED="true"
export HOOK_LINT_MARKDOWN_ENABLED="false"
export HOOK_LINT_SHELL_ENABLED="true"
export HOOK_DELETION_SAFETY_ENABLED="true"
export HOOK_WORKFLOW_GATE_ENABLED="true"
export HOOK_WEBSEARCH_REDIRECT_ENABLED="true"
export HOOK_COMPACT_RECOVERY_ENABLED="true"
```

- One `export HOOK_{GROUP}_ENABLED` line per group (uppercased)
- Values: `"true"` or `"false"` (quoted strings)
- Must match the variable names expected by `cwf-hook-gate.sh`

### 1.4 Update cwf-state.yaml

Edit `cwf-state.yaml` `hooks:` section to mirror the selections:

```yaml
hooks:
  attention: true
  log: true
  read: true
  lint_markdown: false
  lint_shell: true
  deletion_safety: true
  workflow_gate: true
  websearch_redirect: true
  compact_recovery: true
```

---

## Phase 2: External Tool Detection

Detect availability of external AI/search tools and local runtime dependencies used by CWF checks/skills.

### 2.1 Check Tools

Run the following checks via Bash:

```bash
command -v codex >/dev/null 2>&1     # Codex CLI
command -v gemini >/dev/null 2>&1 || npx @google/gemini-cli --version 2>/dev/null  # Gemini CLI
command -v shellcheck >/dev/null 2>&1 # Shell lint gate
command -v jq >/dev/null 2>&1         # JSON parsing for scripts
command -v gh >/dev/null 2>&1         # GitHub CLI for ship
command -v node >/dev/null 2>&1       # Node runtime for gather/review helpers
command -v python3 >/dev/null 2>&1    # Python runtime for gather helpers
```

Check environment variables:

```bash
[ -n "${TAVILY_API_KEY:-}" ]         # Tavily search API
[ -n "${EXA_API_KEY:-}" ]            # Exa search API
```

### 2.2 Update cwf-state.yaml

Edit `cwf-state.yaml` `tools:` section with AI/search results:

```yaml
tools:
  codex: available      # or "unavailable"
  gemini: available     # or "unavailable"
  tavily: available     # or "unavailable"
  exa: unavailable      # or "available"
```

### 2.3 Report Results

Display two result groups:

1) AI/search tools + API keys:

```text
Tool Detection Results:
  codex   : available
  gemini  : available
  tavily  : unavailable (TAVILY_API_KEY not set)
  exa     : unavailable (EXA_API_KEY not set)
```

1) Local runtime dependencies:

```text
Local Dependency Results:
  shellcheck : available|unavailable
  jq         : available|unavailable
  gh         : available|unavailable
  node       : available|unavailable
  python3    : available|unavailable
```

### 2.3.1 Missing Dependency Install Prompt (Required)

If any local runtime dependency is missing, use AskUserQuestion (single choice):

```text
Some CWF runtime dependencies are missing. Install missing tools now?
```

Options:
- `Install missing now (recommended)`:
  - run installer script for missing tools
  - re-check and report unresolved items with exact commands
- `Show commands only`:
  - do not install
  - print exact install commands per missing tool
- `Skip for now`:
  - continue setup without installation

If user selects `Install missing now (recommended)`, run:

```bash
bash {SKILL_DIR}/scripts/install-tooling-deps.sh --install missing
```

If user selects `Show commands only`, run:

```bash
bash {SKILL_DIR}/scripts/install-tooling-deps.sh --check
```

Then print manual install commands for each missing tool from script output.

### 2.3.2 Retry Check (After Install Attempt)

After `Install missing now` path, re-run:

```bash
bash {SKILL_DIR}/scripts/install-tooling-deps.sh --check
```

If still missing, explicitly list unresolved tools and ask whether to continue setup or stop for manual installation.

### 2.3.3 Post-Install Re-Detection + `cwf-state.yaml` Rewrite (Required)

When `Install missing now` was selected, run a full re-detection pass so `cwf-state.yaml` remains the SSOT for tool status:

1. Re-run **all checks in Phase 2.1** (AI/search tools + local runtime dependencies + API key presence).
2. Re-run **Phase 2.2** and rewrite `cwf-state.yaml` `tools:` from the re-detected results.
3. Re-run **Phase 2.3** output reporting and label the second report as post-install results.

This step is mandatory even when some dependencies remain unresolved.

---

## Phase 2.4: Codex Integration on Full Setup (Scope-Aware)

Use this phase when:
- Mode is full setup (`cwf:setup`)
- Phase 2 detected `codex: available`

### 2.4.1 Resolve Active Plugin Scope

Resolve active CWF plugin scope for current cwd first:

```bash
scope_info="$(bash {CWF_PLUGIN_DIR}/scripts/detect-plugin-scope.sh --plugin cwf --cwd "$PWD" 2>/dev/null || true)"
```

If `scope_info` is available, parse:

```bash
eval "$scope_info"
selected_scope="${active_scope:-user}"
selected_project_root="${active_project_path:-}"
if [ "$selected_scope" = "none" ]; then
  selected_scope="user"
fi
```

Deterministic precedence for active scope is:
1. `local` (nearest matching `projectPath`)
2. `project` (nearest matching `projectPath`)
3. `user`
4. `none` (fallback to `user` for setup continuity)

If `selected_scope` is `project`/`local` and `selected_project_root` is empty, resolve fallback root:

```bash
selected_project_root="$(git -C "$PWD" rev-parse --show-toplevel 2>/dev/null || printf '%s' "$PWD")"
```

Always print detected values before asking integration options:
- active scope
- installed scopes
- active install path
- active project path (if any)

### 2.4.2 Ask Integration Scope + Level

When detected scope is `project` or `local`, ask scope target first:

```text
Codex integration target for this setup run?
```

Options:
- `Use active plugin scope (recommended)`:
  - keep Codex integration project-bounded
  - skills/references under `{projectRoot}/.codex/*`
  - wrapper under `{projectRoot}/.codex/bin/codex`
- `Use user-global scope`:
  - skills/references under `~/.agents/*`
  - wrapper under `~/.local/bin/codex`
- `Skip Codex integration for now`:
  - do not change Codex integration in this run

If `Use user-global scope` is selected from non-user context, require a second explicit confirmation:

```text
This run is in {active_scope} scope, but selected target is user-global (~/.agents, ~/.local/bin). Continue?
```

Then ask integration level (single choice):

Use AskUserQuestion (single choice):

```text
Codex CLI was detected. How should CWF integrate with Codex for scope {selected_scope}?
```

Options:
- `Skills + wrapper (recommended)`:
  - Link CWF skills/references into scope-aware destination
  - Install scope-aware `codex` wrapper (`--add-path` only for `user` scope)
- `Skills only`:
  - Link skills/references only (no wrapper install)
- `Skip for now`:
  - Do not change Codex integration in this run

### 2.4.3 Execute Selection

If `Skills + wrapper (recommended)`:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/sync-skills.sh --scope "$selected_scope" ${selected_project_root:+--project-root "$selected_project_root"} --cleanup-legacy
if [ "$selected_scope" = "user" ]; then
  bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --scope "$selected_scope" --enable --add-path
else
  bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --scope "$selected_scope" --project-root "$selected_project_root" --enable
fi
bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --scope "$selected_scope" ${selected_project_root:+--project-root "$selected_project_root"} --status
```

If `Skills only`:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/sync-skills.sh --scope "$selected_scope" ${selected_project_root:+--project-root "$selected_project_root"} --cleanup-legacy
```

If `Skip for now`: no command execution in this phase.

### 2.4.4 Always Print Post-Setup Verification + Rollback

When wrapper install was selected, always report:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --scope "$selected_scope" ${selected_project_root:+--project-root "$selected_project_root"} --status
type -a codex
```

Also print a before-vs-after summary:
- selected scope
- touched paths (skills/references/wrapper)
- rollback commands

Rollback commands:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --scope "$selected_scope" ${selected_project_root:+--project-root "$selected_project_root"} --disable
```

For skills/references rollback, instruct restoring from scope backup roots:
- user: `~/.agents/.skill-sync-backup/*`
- project/local: `{projectRoot}/.codex/.skill-sync-backup/*`

And include this note in plain language:

```text
If scope is user: open a new shell (or source ~/.zshrc). After that, running `codex` will auto-sync session logs.
If scope is project/local: add `{projectRoot}/.codex/bin` to PATH in that shell before running `codex`.
Aliases that call `codex` (for example: codexyolo='codex ...') also inherit this behavior.
Post-run checks run in `warn` mode by default (`CWF_CODEX_POST_RUN_MODE=strict` to enforce non-zero exit on check failures).
Current post-run gates include markdown/shell/link/live-state checks, `apply_patch via exec_command` hygiene detection, and HITL scratchpad sync detection for doc edits.
```

---

## Phase 2.5: Codex Scope-Aware Skill Sync (Optional)

Use this phase when:
- User runs `cwf:setup --codex`
- Full setup and user wants Codex to load CWF from local repo via symlink

### 2.5.1 Resolve Scope

Reuse [Phase 2.4.1](#241-resolve-active-plugin-scope) scope detection.

Default target scope = detected active scope.

When detected scope is `project`/`local`, allow user override to user-global scope only with explicit confirmation:

```text
Apply --codex integration to user-global scope instead of {active_scope} scope?
```

### 2.5.2 Run Sync Script

Run:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/sync-skills.sh --scope "$selected_scope" ${selected_project_root:+--project-root "$selected_project_root"} --cleanup-legacy
```

Expected behavior:
- `user`: link into `~/.agents/skills` and `~/.agents/references`
- project/local scope: link into `{projectRoot}/.codex/skills` and `{projectRoot}/.codex/references`
- Move legacy custom entries from `~/.codex/skills` to backup (`.system` is kept) only for `user` scope
- Validate relative skill references via `{CWF_PLUGIN_DIR}/scripts/codex/verify-skill-links.sh`

### 2.5.3 Report Results

Report:
- Number of linked skills
- Destination paths for selected scope
- Whether legacy `~/.codex/skills` was moved (user scope only) and backup path
- Before-vs-after summary for touched paths
- Rollback guidance from `.skill-sync-backup` for selected scope
- Quick verification command by scope:

```bash
# user
ls -la ~/.agents/skills

# project/local
ls -la "$selected_project_root/.codex/skills"
```

---

## Phase 2.6: Codex Scope-Aware Wrapper Opt-In (Optional)

Use this phase when:
- User runs `cwf:setup --codex-wrapper`
- Full setup and user wants Codex session logs auto-synced into repo artifacts with post-run quality checks

### 2.6.1 Resolve Scope

Reuse [Phase 2.4.1](#241-resolve-active-plugin-scope) scope detection.

Default target scope = detected active scope.

When detected scope is `project`/`local`, allow user override to user-global scope only with explicit confirmation.

### 2.6.2 Ask for Opt-In

Use AskUserQuestion before making shell-level changes:

```text
Enable Codex wrapper for scope {selected_scope} with automatic session log sync and post-run quality checks (including tool-hygiene + HITL sync gates)?
```

If user declines, skip this phase.

### 2.6.3 Install Wrapper (Approved Only)

Run:

```bash
if [ "$selected_scope" = "user" ]; then
  bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --scope "$selected_scope" --enable --add-path
else
  bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --scope "$selected_scope" --project-root "$selected_project_root" --enable
fi
```

This installs a wrapper symlink pointing to:

- user: `~/.local/bin/codex`
- project/local: `{projectRoot}/.codex/bin/codex`

```text
{CWF_PLUGIN_DIR}/scripts/codex/codex-with-log.sh
```

The wrapper preserves normal Codex behavior and runs:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/sync-session-logs.sh --cwd "$PWD"
bash {CWF_PLUGIN_DIR}/scripts/codex/post-run-checks.sh --cwd "$PWD" --mode warn
```

after each Codex run. Logs are persisted under `.cwf/sessions/` by default (legacy fallback: `.cwf/projects/sessions/`) as `*.codex.md` (`raw` JSONL copy is opt-in via `--raw`), and changed-file quality checks are executed in `warn` mode by default.

### 2.6.4 Report and Reversal

Report current status:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --scope "$selected_scope" ${selected_project_root:+--project-root "$selected_project_root"} --status
```

Provide rollback command:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --scope "$selected_scope" ${selected_project_root:+--project-root "$selected_project_root"} --disable
```

Also report:
- before-vs-after wrapper path summary
- whether PATH was auto-updated (`user` only)
- manual PATH export command for project/local scope

Include activation note:

```text
If wrapper is active in user scope, restart shell (or source ~/.zshrc) before testing `codex`.
If wrapper is active in project/local scope, export PATH to include `{projectRoot}/.codex/bin` before testing `codex`.
Post-run behavior can be tuned with:
- `CWF_CODEX_POST_RUN_CHECKS=true|false` (default: true)
- `CWF_CODEX_POST_RUN_MODE=warn|strict` (default: warn)
- `CWF_CODEX_POST_RUN_QUIET=true|false` (default: false)
```

---

## Phase 2.7: Git Hook Gate Installation

Use this phase when:
- Mode is full setup (`cwf:setup`)
- User runs `cwf:setup --git-hooks ...`

### 2.7.1 Resolve Install Mode

Install mode values:
- `none`
- `pre-commit`
- `pre-push`
- `both`

Resolution order:
1. If command includes `--git-hooks <value>`, use it.
2. Otherwise ask AskUserQuestion (single choice):
   ```text
   Configure repository git hook gates as part of setup?
   ```
   Options:
   - `both` (recommended)
   - `pre-commit`
   - `pre-push`
   - `none`

### 2.7.2 Resolve Gate Profile

Gate profile values:
- `fast`: markdownlint only
- `balanced`: markdownlint + local link checks + staged shellcheck + push-time index coverage checks
- `strict`: balanced + provenance freshness and growth-drift reports on push

Resolution order:
1. If command includes `--gate-profile <value>`, use it.
2. Otherwise ask AskUserQuestion (single choice):
   ```text
   Select git gate profile (speed vs coverage).
   ```
   Options:
   - `balanced` (recommended)
   - `fast`
   - `strict`

If install mode is `none`, skip gate profile selection.

### 2.7.3 Apply Configuration

Run:

```bash
bash {SKILL_DIR}/scripts/configure-git-hooks.sh --install <mode> --profile <profile>
```

This script updates repository git hook files (`pre-commit`, `pre-push`) under the configured hooks path and sets `git config core.hooksPath .githooks` when hooks are enabled.

### 2.7.4 Report Effective State

Always report:

```bash
git config --get core.hooksPath
```

And summarize:
- installed hooks (`pre-commit`, `pre-push`)
- selected profile
- what each hook enforces at that profile

---

## Phase 2.8: Environment Migration and Project Config Bootstrap

Use this phase when:
- Mode is full setup (`cwf:setup`)
- User runs `cwf:setup --tools`
- User runs `cwf:setup --env`

### 2.8.1 Scan Existing Environment Config

Run:

```bash
bash {SKILL_DIR}/scripts/migrate-env-vars.sh --scan
```

This scan checks `~/.zshrc`, `~/.bashrc`, and `~/.claude/.env` (if present), and reports:
- legacy-to-canonical migration candidates (`CLAUDE_CORCA_*`/`CLAUDE_ATTENTION_*` → `CWF_*`)
- missing required keys (`SLACK_BOT_TOKEN`, `SLACK_CHANNEL_ID`, `TAVILY_API_KEY`, `EXA_API_KEY`)

### 2.8.2 Ask Apply Strategy

Use AskUserQuestion (single choice):

```text
Apply environment variable migration now?
```

Options:
- `Auto migrate now (recommended)`:
  - apply canonical exports into active shell profile
  - comment legacy assignments in scanned files
  - include commented placeholders for missing required keys
- `Review first`:
  - show scan output and the exact apply command
  - ask one additional confirm question before applying
- `Skip for now`:
  - no file modifications in this phase

### 2.8.3 Apply Migration

When apply is approved, run:

```bash
bash {SKILL_DIR}/scripts/migrate-env-vars.sh --apply --cleanup-legacy --include-placeholders
```

If the user wants a specific target profile, pass:

```bash
bash {SKILL_DIR}/scripts/migrate-env-vars.sh --apply --cleanup-legacy --include-placeholders --target-profile ~/.zshrc
```

### 2.8.4 Report Effective State

Always report:
- applied profile path
- migrated key list
- missing required keys still needing real values

Provide verification command:

```bash
rg -n "CWF_|TAVILY_API_KEY|EXA_API_KEY|SLACK_BOT_TOKEN|SLACK_CHANNEL_ID" ~/.zshrc ~/.bashrc ~/.claude/.env
```

Include activation note:

```text
Open a new shell (or source ~/.zshrc / ~/.bashrc) so updated exports are loaded.
```

### 2.8.5 Bootstrap Project Config Files

Ask whether to create project-level config files (.cwf-config.yaml, .cwf-config.local.yaml) now:

```text
Create project config templates now? (.cwf-config.yaml + .cwf-config.local.yaml)
```

Options:
- `Yes (recommended)`:
  - create missing config templates
  - keep existing files unchanged
  - ensure .cwf-config.local.yaml is listed in `.gitignore`
- `Overwrite templates`:
  - re-write both templates (`--force`)
  - ensure .cwf-config.local.yaml is listed in `.gitignore`
- `Skip for now`:
  - no file changes in this sub-phase

When user selects `Yes (recommended)`, run:

```bash
bash {SKILL_DIR}/scripts/bootstrap-project-config.sh
```

When user selects `Overwrite templates`, run:

```bash
bash {SKILL_DIR}/scripts/bootstrap-project-config.sh --force
```

### 2.8.6 Explain Runtime Priority

After migration/bootstrap decisions, always report the effective CWF config source priority:

1. .cwf-config.local.yaml
2. .cwf-config.yaml
3. Process environment
4. Shell profile exports (`~/.zshenv`, `~/.zprofile`, `~/.zshrc`, `~/.bash_profile`, `~/.bashrc`, `~/.profile`)

Include this operational guidance:

```text
Use .cwf-config.yaml for team-shared, non-secret defaults.
Use .cwf-config.local.yaml for local/secret values.
Keep shell exports as global fallback.
```

---

## Phase 2.9: Agent Team Mode Setup

Use this phase when:
- Mode is full setup (`cwf:setup`)
- User runs `cwf:setup --tools`
- User runs `cwf:setup --agent-teams`

### 2.9.1 Ask Team Mode Policy

Use AskUserQuestion (single choice):

```text
Configure Claude Code Agent Team mode now?
```

Options:
- `Enable Agent Team mode (recommended)`:
  - sets `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1` in `~/.claude/settings.json` `env`
- `Keep current setting`:
  - no modification, status report only
- `Disable Agent Team mode`:
  - removes `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS` from `~/.claude/settings.json` `env`

### 2.9.2 Apply Selection

When user selects `Enable Agent Team mode (recommended)`, run:

```bash
bash {SKILL_DIR}/scripts/configure-agent-teams.sh --enable
```

When user selects `Keep current setting`, run:

```bash
bash {SKILL_DIR}/scripts/configure-agent-teams.sh --status
```

When user selects `Disable Agent Team mode`, run:

```bash
bash {SKILL_DIR}/scripts/configure-agent-teams.sh --disable
```

### 2.9.3 Report Effective State

Always report:

```bash
bash {SKILL_DIR}/scripts/configure-agent-teams.sh --status
```

And include this note in plain language:

```text
Restart Claude Code (or open a new session) so Agent Team mode changes are applied consistently.
```

---

## Phase 2.10: cwf:run Ambiguity Mode Setup

Use this phase when:
- Mode is full setup (`cwf:setup`)
- User runs `cwf:setup --tools`
- User runs `cwf:setup --env`
- User runs `cwf:setup --run-mode`

### 2.10.1 Detect Current Effective Mode

Run:

```bash
source {CWF_PLUGIN_DIR}/hooks/scripts/env-loader.sh
cwf_env_load_vars CWF_RUN_AMBIGUITY_MODE
printf '%s\n' "${CWF_RUN_AMBIGUITY_MODE:-defer-blocking}"
```

If the key is unset anywhere, treat `defer-blocking` as the effective default.

### 2.10.2 Ask Desired Default Mode

Use AskUserQuestion (single choice):

```text
Select default ambiguity handling mode for cwf:run (T3 decisions in clarify).
```

Options:
- `defer-blocking (recommended)`:
  - continue autonomously
  - must record autonomous T3 decisions
  - must carry unresolved decisions to ship as merge-blocking items
- `strict`:
  - stop and ask the user at T3
- `defer-reversible`:
  - continue autonomously with reversible implementation structure
  - still record decisions, but not merge-blocking by default
- `explore-worktrees`:
  - implement alternatives in separate worktrees and compare before finalization

### 2.10.3 Ask Config Scope

Use AskUserQuestion (single choice):

```text
Where should this default mode be saved?
```

Options:
- `Shared config (recommended)`:
  - write to `.cwf-config.yaml`
  - team-wide default for this repository
- `Local config`:
  - write to `.cwf-config.local.yaml`
  - local override only (highest priority)

### 2.10.4 Persist Selection

Run:

```bash
bash {SKILL_DIR}/scripts/configure-run-mode.sh --mode <selected-mode> --scope <shared|local>
```

If config templates are missing, bootstrap first:

```bash
bash {SKILL_DIR}/scripts/bootstrap-project-config.sh
```

Then retry `configure-run-mode.sh`.

### 2.10.5 Report Effective State

Report:
- selected mode
- selected scope
- written config path

Provide verification command:

```bash
rg -n "^CWF_RUN_AMBIGUITY_MODE:" .cwf-config.yaml .cwf-config.local.yaml 2>/dev/null
```

Also report precedence reminder:
- `--ambiguity-mode` flag
- `.cwf-config.local.yaml`
- `.cwf-config.yaml`
- env/shell
- built-in default (`defer-blocking`)

---

## Phase 3: Generate CWF Capability Index (Explicit)

Generate a CWF-focused capability index. This phase runs only when `--cap-index` is explicitly requested.

### 3.1 Scan CWF Structure

Build CWF capability inventories from the repository:

- [plugins/cwf/.claude-plugin/plugin.json](../../.claude-plugin/plugin.json) (if present)
- [plugins/cwf/hooks/hooks.json](../../hooks/hooks.json), [plugins/cwf/hooks/scripts/cwf-hook-gate.sh](../../hooks/scripts/cwf-hook-gate.sh), and [plugins/cwf/hooks/README.md](../../hooks/README.md) (if present)
- `plugins/cwf/skills/*/SKILL.md`
- `plugins/cwf/references/*.md`
- [plugins/cwf/scripts/README.md](../../scripts/README.md) and key operational scripts (for example [plugins/cwf/scripts/check-session.sh](../../scripts/check-session.sh), `plugins/cwf/scripts/codex/*`)

### 3.2 Build CWF Capability Index

Generate concise capability-oriented sections:

```markdown
## {area} — {capability boundary}

- [label](path/to/file): {what this file is}
```

- Keep descriptions file-centric; avoid procedure-heavy wording.
- Use canonical CWF skill order for [plugins/cwf/skills](../../skills): `setup`, `update`, `gather`, `clarify`, `plan`, `review`, `impl`, `retro`, `handoff`, `ship`, `run`, `refactor`.
- Use deterministic alphabetical order for other sections.
- Ensure every internal file/directory reference uses a Markdown link with a relative target.
- Do not enumerate skill-internal files in index bullets; add one concise sentence that skill-local READMEs contain per-skill file maps.
- For hooks/scripts families, prefer linking [plugins/cwf/hooks/README.md](../../hooks/README.md) and [plugins/cwf/scripts/README.md](../../scripts/README.md) over enumerating every script file.

### 3.3 Write Capability Index

Create or overwrite the capability index output file under the artifact index directory:

```markdown
# CWF Capability Index

> Generated by `cwf:setup --cap-index`. Default output file: `.cwf/indexes/cwf-index.md`.

{areas}
```

### 3.4 Capability Coverage Validation (Required)

Run:

```bash
bash {SKILL_DIR}/scripts/check-index-coverage.sh .cwf/indexes/cwf-index.md --profile cap
```

This check applies optional exclusions from repository-root .cwf-cap-index-ignore.

If validation fails, regenerate and fix missing coverage before finishing.

---

## Phase 4: Generate Repository Index (Optional)

Generate a repository-wide progressive disclosure index for the current project.

### 4.0 Entry and Safety Rules

When mode is full setup (`cwf:setup`), ask first:

```text
Generate repository index for this repo as well?
```

If user answers `No`, skip Phase 4.

### 4.0.2 Output Target Selection

In this repository, repository index output is managed in AGENTS.md only.

Target resolution:

1. If command includes `--target agents`, use it.
2. If command includes `--target file` or `--target both`, normalize to `agents` and report that this repository uses AGENTS-managed output only.
3. Otherwise default to `agents`.

Managed AGENTS block markers:

```markdown
<!-- CWF:INDEX:START -->
...generated index body...
<!-- CWF:INDEX:END -->
```

If AGENTS.md does not exist, create it with a minimal scaffold and the managed block.

### 4.1 Scan Project Structure

Use Glob to find top-level directories. Exclude hidden directories (`.git`, `.claude`, `.cwf`), `node_modules`, and `projects`.

Build adaptive file inventories (sorted) from the current repository structure:

- Root entry docs if present: AGENTS.md, CLAUDE.md, README.md, README.ko.md
- `docs/*.md` (when `docs/` exists)
- `references/**/*.md` (when `references/` exists)
- Any `*/skills/*/SKILL.md` (excluding `.git/`, `.cwf/`, `node_modules/`, `projects/`)
- Any non-skill `*/references/*.md` (excluding `.git/`, `.cwf/`, `node_modules/`, `projects/`, and `*/skills/*/references/*`)
- If present: [plugins/cwf/hooks/README.md](../../hooks/README.md), [plugins/cwf/scripts/README.md](../../scripts/README.md)

These discovered inventories are mandatory coverage sets for repository index generation.

Apply optional exclusions from repository-root .cwf-index-ignore (glob patterns, one per line) before finalizing repository index content.

### 4.2 Build Repository Index

For each area, generate:

```markdown
## {area} — {task intent boundary; when this area becomes relevant}

- [label](path/to/file): {one-line description of what this file is}
```

- Keep intent text concise and intent-level.
- Absorb read-intent into section headings; omit separate `When to read`/`Role`/`Key files` labels.
- Prefer concise link labels when local context is clear.
- Ensure every internal file/directory reference uses a Markdown link with a relative target.
- Make descriptions file-centric ("what this file is"), not action scripts.
- Do not enumerate skill-internal files in index bullets; add one concise sentence that skill-local READMEs contain per-skill file maps.
- For hooks/scripts families, prefer linking [plugins/cwf/hooks/README.md](../../hooks/README.md) and [plugins/cwf/scripts/README.md](../../scripts/README.md) over enumerating every script file.
- Do not use representative sampling for coverage sets; include every file in the mandatory inventories.
- Use one stable ordering policy:
  - Root: fixed priority order (`README`, `AGENTS`, `CLAUDE`, `cwf-state`, `README.ko`).
  - When [plugins/cwf/skills](../../skills) exists, use canonical CWF workflow order (`setup`, `update`, `gather`, `clarify`, `plan`, `review`, `impl`, `retro`, `handoff`, `ship`, `run`, `refactor`).
  - For non-CWF skill collections, use deterministic alphabetical order.
  - Other sections: deterministic order (alphabetical unless there is a clear canonical sequence).

### 4.3 Update AGENTS.md Managed Block

Write the generated repository index body into the managed block in AGENTS.md:

- If markers exist, replace only the marker-delimited section.
- If markers are absent, append a new managed block at the end of AGENTS.md.

### 4.4 Repository Coverage Validation (Required)

Run:

```bash
bash {SKILL_DIR}/scripts/check-index-coverage.sh AGENTS.md --profile repo
```

This check applies optional exclusions from repository-root .cwf-index-ignore.

If validation fails, regenerate and fix missing links before finishing.

---

## Phase 5: Lessons Checkpoint

### 5.1 Ask for Learnings

Ask the user: "Any learnings from the setup process?"

If yes, append to `lessons.md` in the current session artifact directory using the standard format:

```markdown
### {title}

- **Expected**: {what was anticipated}
- **Actual**: {what was discovered}
- **Takeaway**: {key insight}
```

### 5.2 Update Stage Checkpoints

Add `setup` to `cwf-state.yaml` current session's `stage_checkpoints` list.

---

## Rules

1. **State SSOT + idempotency**: Read and edit `cwf-state.yaml` (do not overwrite wholesale), and keep reruns safe/idempotent across all phases.
2. **Always explicit user choices**: Use AskUserQuestion for each decision point in [Phase 1](#phase-1-hook-group-selection), [Phase 2.3.1](#231-missing-dependency-install-prompt-required), [Phase 2.4](#phase-24-codex-integration-on-full-setup-scope-aware), [Phase 2.7](#phase-27-git-hook-gate-installation), [Phase 2.8](#phase-28-environment-migration-and-project-config-bootstrap), [Phase 2.9](#phase-29-agent-team-mode-setup), and Phase 2.10 (cwf:run ambiguity mode setup).
3. **Post-install re-detection is mandatory**: After an install attempt, re-run [Phase 2.1](#21-check-tools) → [Phase 2.2](#22-update-cwf-stateyaml) → [Phase 2.3](#23-report-results) per [Phase 2.3.3](#233-post-install-re-detection--cwf-stateyaml-rewrite-required).
4. **Single-entry setup UX**: Full setup (`cwf:setup`) must run optional integration prompts/actions for [Phase 2.4](#phase-24-codex-integration-on-full-setup-scope-aware), [Phase 2.7](#phase-27-git-hook-gate-installation), [Phase 2.8](#phase-28-environment-migration-and-project-config-bootstrap), [Phase 2.9](#phase-29-agent-team-mode-setup), and Phase 2.10 (cwf:run ambiguity mode setup).
5. **Index generation is explicit and deterministic**: Capability index runs only via `--cap-index` ([Phase 3](#phase-3-generate-cwf-capability-index-explicit)); repository index is AGENTS-managed via `--repo-index` ([Phase 4](#phase-4-generate-repository-index-optional)).
6. **Coverage/link policy for generated indexes**: Use Markdown relative links and pass coverage validation via [Phase 3.4](#34-capability-coverage-validation-required) and [Phase 4.4](#44-repository-coverage-validation-required), with ignore files only for intentional exclusions.
7. **File safety**: Codex sync must use symlink + backup move (no direct user file deletion) as defined in [Phase 2.5](#phase-25-codex-scope-aware-skill-sync-optional).
8. **Scope-aware Codex integration**: Always resolve active plugin scope first; non-user context must not mutate user-global Codex paths without explicit user confirmation.
9. **Formatting invariant**: All code fences in this skill must include language specifiers.

## References

- [cwf-hook-gate.sh](../../hooks/scripts/cwf-hook-gate.sh) — hook gate mechanism
- [hooks.json](../../hooks/hooks.json) — hook definitions
- [agent-patterns.md](../../references/agent-patterns.md) — Single pattern
- [detect-plugin-scope.sh](../../scripts/detect-plugin-scope.sh) — active Claude plugin scope detection for cwd
- [sync-skills.sh](../../scripts/codex/sync-skills.sh) — Codex scope-aware skill sync
- [install-wrapper.sh](../../scripts/codex/install-wrapper.sh) — Codex scope-aware wrapper management
- [verify-skill-links.sh](../../scripts/codex/verify-skill-links.sh) — Codex skill link validation
- [scripts/configure-git-hooks.sh](scripts/configure-git-hooks.sh) — installs and profiles repository git hook gates
- [scripts/migrate-env-vars.sh](scripts/migrate-env-vars.sh) — legacy env detection and canonical CWF env migration
- [scripts/bootstrap-project-config.sh](scripts/bootstrap-project-config.sh) — project config template/bootstrap and `.gitignore` sync
- [scripts/configure-agent-teams.sh](scripts/configure-agent-teams.sh) — toggles Claude Agent Team runtime mode in `~/.claude/settings.json`
- [scripts/configure-run-mode.sh](scripts/configure-run-mode.sh) — persists default `cwf:run` ambiguity mode into project config
- [scripts/install-tooling-deps.sh](scripts/install-tooling-deps.sh) — checks/installs missing local runtime dependencies for CWF workflows
- [scripts/check-index-coverage.sh](scripts/check-index-coverage.sh) — deterministic index coverage validation
- .cwf-cap-index-ignore — optional intentional exclusion list for capability index coverage
- .cwf-index-ignore — optional intentional exclusion list for repository index coverage
