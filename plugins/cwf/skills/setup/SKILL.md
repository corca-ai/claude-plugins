---
name: setup
description: |
  Initial CWF configuration: hook group selection, external tool detection,
  optional Codex user-scope skill sync, and progressive disclosure index generation.
  Triggers: "cwf:setup", "setup hooks", "configure cwf"
allowed-tools:
  - Read
  - Write
  - Edit
  - Bash
  - Glob
  - Grep
  - AskUserQuestion
---

# Setup

Initial CWF configuration. Interactive hook toggle, external tool detection,
optional Codex skill sync, and progressive disclosure index generation.

**Language**: Write config files in English. Communicate with the user in their prompt language.

## Quick Start

```text
cwf:setup                # Full setup (hooks + tools + index)
cwf:setup --hooks        # Hook group selection only
cwf:setup --tools        # External tool detection only
cwf:setup --codex        # Sync CWF skills into Codex user scope (~/.agents/skills)
cwf:setup --index        # Generate index.md only
```

---

## Phase 1: Hook Group Selection

Configure which hook groups are active. Default: all enabled (hooks work
without running cwf:setup).

### 1.1 Read Current State

Read `cwf-state.yaml` `hooks:` section for current toggle state.

### 1.2 Present Selection

Use AskUserQuestion with `multiSelect: true`. Present 7 hook groups with
descriptions:

| Group | Description |
|-------|-------------|
| `attention` | Slack notifications on idle/waiting |
| `log` | Auto-log turns + auto-commit transcripts |
| `read` | File-size aware reading guard |
| `lint_markdown` | Markdown validation after Write/Edit |
| `lint_shell` | ShellCheck validation after Write/Edit |
| `websearch_redirect` | Redirect WebSearch to cwf:gather |
| `compact_recovery` | Inject live session state after auto-compact |

Pre-select groups that are currently enabled in `cwf-state.yaml`.

### 1.3 Write Hook Config

Write `~/.claude/cwf-hooks-enabled.sh`:

```bash
# Generated by cwf:setup
export HOOK_ATTENTION_ENABLED="true"
export HOOK_LOG_ENABLED="true"
export HOOK_READ_ENABLED="true"
export HOOK_LINT_MARKDOWN_ENABLED="false"
export HOOK_LINT_SHELL_ENABLED="true"
export HOOK_WEBSEARCH_REDIRECT_ENABLED="true"
export HOOK_PLAN_PROTOCOL_ENABLED="true"
```

- One `export HOOK_{GROUP}_ENABLED` line per group (uppercased)
- Values: `"true"` or `"false"` (quoted strings)
- Must match the variable names expected by `cwf-hook-gate.sh`

### 1.4 Update cwf-state.yaml

Edit `cwf-state.yaml` `hooks:` section to mirror the selections:

```yaml
hooks:
  attention: true
  log: true
  read: true
  lint_markdown: false
  lint_shell: true
  websearch_redirect: true
  compact_recovery: true
```

---

## Phase 2: External Tool Detection

Detect availability of external AI tools and search APIs.

### 2.1 Check Tools

Run the following checks via Bash:

```bash
command -v codex >/dev/null 2>&1     # Codex CLI
command -v gemini >/dev/null 2>&1 || npx @google/gemini-cli --version 2>/dev/null  # Gemini CLI
```

Check environment variables:

```bash
[ -n "${TAVILY_API_KEY:-}" ]         # Tavily search API
[ -n "${EXA_API_KEY:-}" ]            # Exa search API
```

### 2.2 Update cwf-state.yaml

Edit `cwf-state.yaml` `tools:` section with results:

```yaml
tools:
  codex: available      # or "unavailable"
  gemini: available     # or "unavailable"
  tavily: available     # or "unavailable"
  exa: unavailable      # or "available"
```

### 2.3 Report Results

Display results as a table:

```text
Tool Detection Results:
  codex   : available
  gemini  : available
  tavily  : unavailable (TAVILY_API_KEY not set)
  exa     : unavailable (EXA_API_KEY not set)
```

---

## Phase 2.5: Codex User-Scope Skill Sync (Optional)

Use this phase when:
- User runs `cwf:setup --codex`
- Full setup and user wants Codex to load CWF from local repo via symlink

### 2.5.1 Run Sync Script

Run:

```bash
bash {SKILL_DIR}/../../../../scripts/codex/sync-skills.sh --cleanup-legacy
```

Expected behavior:
- Link CWF skills from `plugins/cwf/skills/*` into `~/.agents/skills`
- Link shared references into `~/.agents/references`
- Move legacy custom entries from `~/.codex/skills` to backup (`.system` is kept)
- Validate relative skill references via `scripts/codex/verify-skill-links.sh`

### 2.5.2 Report Results

Report:
- Number of linked skills
- Destination paths (`~/.agents/skills`, `~/.agents/references`)
- Whether legacy `~/.codex/skills` was moved and backup path

---

## Phase 3: Generate index.md

Create a progressive disclosure index for the project — pointers to key
areas, not content summaries.

### 3.1 Scan Project Structure

Use Glob to find top-level directories. Exclude hidden directories (`.git`,
`.claude`), `node_modules`, and `prompt-logs`.

### 3.2 Build Index

For each area, generate:

```markdown
## {area}

- **When to read**: {one-line guidance on when this area is relevant}
- **Entry point**: {primary file or directory to start reading}
- **Key files**: {2-5 most important files}
```

### 3.3 Write index.md

Write to project root `index.md`. Include a header noting it was generated
by cwf:setup and can be regenerated.

```markdown
# Project Index

> Generated by `cwf:setup`. Regenerate with `cwf:setup --index`.

{areas}
```

---

## Phase 4: Lessons Checkpoint

### 4.1 Ask for Learnings

Ask the user: "Any learnings from the setup process?"

If yes, append to `lessons.md` in the current session's prompt-logs directory
using the standard format:

```markdown
### {title}

- **Expected**: {what was anticipated}
- **Actual**: {what was discovered}
- **Takeaway**: {key insight}
```

### 4.2 Update Stage Checkpoints

Add `setup` to `cwf-state.yaml` current session's `stage_checkpoints` list.

---

## Rules

1. **Default-enabled**: Hooks work without cwf:setup. This skill creates
   config for customizing (disabling specific groups).
2. **cwf-state.yaml is SSOT**: Read before modifying. Edit, do not overwrite.
3. **index.md = pointers, not summaries**: "When to read" + "Entry point" +
   "Key files". No content duplication.
4. **Bash 3.2 compatible output**: `cwf-hooks-enabled.sh` uses only `export`
   lines with quoted string values.
5. **AskUserQuestion for all choices**: No batch defaults. Always ask.
6. **Idempotent**: Re-running updates existing config, does not duplicate.
7. **All code fences must have language specifier**: Never use bare fences.
8. **Codex sync uses symlink + backup move**: Do not delete user files directly.

## References

- [cwf-hook-gate.sh](../../hooks/scripts/cwf-hook-gate.sh) — hook gate mechanism
- [hooks.json](../../hooks/hooks.json) — hook definitions
- [agent-patterns.md](../../references/agent-patterns.md) — Single pattern
- [sync-skills.sh](../../../../scripts/codex/sync-skills.sh) — Codex user-scope skill sync
- [verify-skill-links.sh](../../../../scripts/codex/verify-skill-links.sh) — Codex skill link validation
