---
name: setup
description: "Initial CWF configuration: hook group selection, external tool detection, optional Codex integration, optional git hook gate installation, optional CWF capability index generation, and optional repository index generation. Triggers: \"cwf:setup\", \"setup hooks\", \"configure cwf\""
---

# Setup

Initial CWF configuration. Interactive hook toggle, external tool detection, optional Codex integration, optional git hook gate installation, optional CWF capability index generation, and optional repository index generation.

**Language**: Write config files in English. Communicate with the user in their prompt language.

## Quick Start

```text
cwf:setup                # Full setup (hooks + tools + optional repo-index prompt)
cwf:setup --hooks        # Hook group selection only
cwf:setup --tools        # External tool detection only
cwf:setup --codex        # Sync CWF skills into Codex user scope (~/.agents/skills)
cwf:setup --codex-wrapper # Optional Codex wrapper install for session log sync
cwf:setup --git-hooks both --gate-profile balanced  # Install repo git hooks and set gate depth
cwf:setup --git-hooks pre-commit --gate-profile fast # Lightweight local-only git gate
cwf:setup --git-hooks none # Remove repo-managed git hooks
cwf:setup --cap-index    # Generate/refresh CWF capability index only
cwf:setup --repo-index   # Generate/refresh repository index (explicit)
cwf:setup --repo-index --target file   # repo-index.md only (default)
cwf:setup --repo-index --target agents # AGENTS.md managed block only
cwf:setup --repo-index --target both   # repo-index.md + AGENTS.md block
```

## Mode Routing

Parse input flags and run only the relevant phases:

| Input | Phases |
|-------|--------|
| `cwf:setup` | 1 → 2 → 2.4 (if codex available) → 2.7 (always ask) → 4 (opt-in) → 5 |
| `cwf:setup --hooks` | 1 → 5 |
| `cwf:setup --tools` | 2 → 5 |
| `cwf:setup --codex` | 2.5 → 5 |
| `cwf:setup --codex-wrapper` | 2.6 → 5 |
| `cwf:setup --git-hooks <none\|pre-commit\|pre-push\|both> [--gate-profile <fast\|balanced\|strict>]` | 2.7 → 5 |
| `cwf:setup --cap-index` | 3 → 5 |
| `cwf:setup --repo-index [--target file\|agents\|both]` | 4 → 5 |

When mode is full setup and Codex CLI is available, do not silently skip Codex integration; always run Phase 2.4 and ask the user which integration level to apply.

When mode is full setup, do not expect users to supply optional flags manually. Always ask for git hook installation mode and gate profile in Phase 2.7.

---

## Phase 1: Hook Group Selection

Configure which hook groups are active. Default: all enabled (hooks work without running cwf:setup).

### 1.1 Read Current State

Read `cwf-state.yaml` `hooks:` section for current toggle state.

### 1.2 Present Selection

Use AskUserQuestion with `multiSelect: true`. Present 7 hook groups with descriptions:

| Group | Description |
|-------|-------------|
| `attention` | Slack notifications on idle/waiting |
| `log` | Auto-log turns + auto-commit transcripts |
| `read` | File-size aware reading guard |
| `lint_markdown` | Markdown validation after Write/Edit |
| `lint_shell` | ShellCheck validation after Write/Edit |
| `websearch_redirect` | Redirect WebSearch to cwf:gather |
| `compact_recovery` | Inject live session state after auto-compact |

Pre-select groups that are currently enabled in `cwf-state.yaml`.

### 1.3 Write Hook Config

Write `~/.claude/cwf-hooks-enabled.sh`:

```bash
# Generated by cwf:setup
export HOOK_ATTENTION_ENABLED="true"
export HOOK_LOG_ENABLED="true"
export HOOK_READ_ENABLED="true"
export HOOK_LINT_MARKDOWN_ENABLED="false"
export HOOK_LINT_SHELL_ENABLED="true"
export HOOK_WEBSEARCH_REDIRECT_ENABLED="true"
export HOOK_COMPACT_RECOVERY_ENABLED="true"
```

- One `export HOOK_{GROUP}_ENABLED` line per group (uppercased)
- Values: `"true"` or `"false"` (quoted strings)
- Must match the variable names expected by `cwf-hook-gate.sh`

### 1.4 Update cwf-state.yaml

Edit `cwf-state.yaml` `hooks:` section to mirror the selections:

```yaml
hooks:
  attention: true
  log: true
  read: true
  lint_markdown: false
  lint_shell: true
  websearch_redirect: true
  compact_recovery: true
```

---

## Phase 2: External Tool Detection

Detect availability of external AI tools and search APIs.

### 2.1 Check Tools

Run the following checks via Bash:

```bash
command -v codex >/dev/null 2>&1     # Codex CLI
command -v gemini >/dev/null 2>&1 || npx @google/gemini-cli --version 2>/dev/null  # Gemini CLI
```

Check environment variables:

```bash
[ -n "${TAVILY_API_KEY:-}" ]         # Tavily search API
[ -n "${EXA_API_KEY:-}" ]            # Exa search API
```

### 2.2 Update cwf-state.yaml

Edit `cwf-state.yaml` `tools:` section with results:

```yaml
tools:
  codex: available      # or "unavailable"
  gemini: available     # or "unavailable"
  tavily: available     # or "unavailable"
  exa: unavailable      # or "available"
```

### 2.3 Report Results

Display results as a table:

```text
Tool Detection Results:
  codex   : available
  gemini  : available
  tavily  : unavailable (TAVILY_API_KEY not set)
  exa     : unavailable (EXA_API_KEY not set)
```

---

## Phase 2.4: Codex Integration on Full Setup

Use this phase when:
- Mode is full setup (`cwf:setup`)
- Phase 2 detected `codex: available`

### 2.4.1 Ask Integration Level

Use AskUserQuestion (single choice):

```text
Codex CLI was detected. How should CWF integrate with Codex?
```

Options:
- `Skills + wrapper (recommended)`:
  - Link CWF skills/references into `~/.agents/*`
  - Install `codex` wrapper and PATH line for automatic session log sync
- `Skills only`:
  - Link skills/references only (no wrapper install)
- `Skip for now`:
  - Do not change Codex integration in this run

### 2.4.2 Execute Selection

If `Skills + wrapper (recommended)`:

```bash
bash {SKILL_DIR}/../../scripts/codex/sync-skills.sh --cleanup-legacy
bash {SKILL_DIR}/../../scripts/codex/install-wrapper.sh --enable --add-path
bash {SKILL_DIR}/../../scripts/codex/install-wrapper.sh --status
```

If `Skills only`:

```bash
bash {SKILL_DIR}/../../scripts/codex/sync-skills.sh --cleanup-legacy
```

If `Skip for now`: no command execution in this phase.

### 2.4.3 Always Print Post-Setup Verification

When wrapper install was selected, always report:

```bash
bash {SKILL_DIR}/../../scripts/codex/install-wrapper.sh --status
type -a codex
```

And include this note in plain language:

```text
Open a new shell (or source ~/.zshrc). After that, running `codex` will auto-sync session logs.
Aliases that call `codex` (for example: codexyolo='codex ...') also inherit this behavior.
```

---

## Phase 2.5: Codex User-Scope Skill Sync (Optional)

Use this phase when:
- User runs `cwf:setup --codex`
- Full setup and user wants Codex to load CWF from local repo via symlink

### 2.5.1 Run Sync Script

Run:

```bash
bash {SKILL_DIR}/../../scripts/codex/sync-skills.sh --cleanup-legacy
```

Expected behavior:
- Link CWF skills from `plugins/cwf/skills/*` into `~/.agents/skills`
- Link shared references into `~/.agents/references`
- Move legacy custom entries from `~/.codex/skills` to backup (`.system` is kept)
- Validate relative skill references via `{SKILL_DIR}/../../scripts/codex/verify-skill-links.sh`

### 2.5.2 Report Results

Report:
- Number of linked skills
- Destination paths (`~/.agents/skills`, `~/.agents/references`)
- Whether legacy `~/.codex/skills` was moved and backup path
- Quick verification command:

```bash
ls -la ~/.agents/skills
```

---

## Phase 2.6: Codex Wrapper Opt-In (Optional)

Use this phase when:
- User runs `cwf:setup --codex-wrapper`
- Full setup and user wants Codex session logs auto-synced into repo artifacts

### 2.6.1 Ask for Opt-In

Use AskUserQuestion before making shell-level changes:

```text
Enable Codex wrapper for automatic session log sync?
```

If user declines, skip this phase.

### 2.6.2 Install Wrapper (Approved Only)

Run:

```bash
bash {SKILL_DIR}/../../scripts/codex/install-wrapper.sh --enable --add-path
```

This installs a wrapper symlink at `~/.local/bin/codex` pointing to:

```text
{SKILL_DIR}/../../scripts/codex/codex-with-log.sh
```

The wrapper preserves normal Codex behavior and runs:

```bash
bash {SKILL_DIR}/../../scripts/codex/sync-session-logs.sh --cwd "$PWD"
```

after each Codex run to persist markdown logs under `prompt-logs/sessions/` as `*.codex.md` (legacy `sessions-codex/` remains readable during migration; `raw` JSONL copy is opt-in via `--raw`).

### 2.6.3 Report and Reversal

Report current status:

```bash
bash {SKILL_DIR}/../../scripts/codex/install-wrapper.sh --status
```

Provide rollback command:

```bash
bash {SKILL_DIR}/../../scripts/codex/install-wrapper.sh --disable
```

Include activation note:

```text
If wrapper is active, restart shell (or source ~/.zshrc) before testing `codex`.
```

---

## Phase 2.7: Git Hook Gate Installation

Use this phase when:
- Mode is full setup (`cwf:setup`)
- User runs `cwf:setup --git-hooks ...`

### 2.7.1 Resolve Install Mode

Install mode values:
- `none`
- `pre-commit`
- `pre-push`
- `both`

Resolution order:
1. If command includes `--git-hooks <value>`, use it.
2. Otherwise ask AskUserQuestion (single choice):
   ```text
   Configure repository git hook gates as part of setup?
   ```
   Options:
   - `both` (recommended)
   - `pre-commit`
   - `pre-push`
   - `none`

### 2.7.2 Resolve Gate Profile

Gate profile values:
- `fast`: markdownlint only
- `balanced`: markdownlint + local link checks + staged shellcheck + push-time index coverage checks
- `strict`: balanced + provenance freshness report on push

Resolution order:
1. If command includes `--gate-profile <value>`, use it.
2. Otherwise ask AskUserQuestion (single choice):
   ```text
   Select git gate profile (speed vs coverage).
   ```
   Options:
   - `balanced` (recommended)
   - `fast`
   - `strict`

If install mode is `none`, skip gate profile selection.

### 2.7.3 Apply Configuration

Run:

```bash
bash {SKILL_DIR}/scripts/configure-git-hooks.sh --install <mode> --profile <profile>
```

This script updates repository git hook files (`pre-commit`, `pre-push`) under the configured hooks path and sets `git config core.hooksPath .githooks` when hooks are enabled.

### 2.7.4 Report Effective State

Always report:

```bash
git config --get core.hooksPath
```

And summarize:
- installed hooks (`pre-commit`, `pre-push`)
- selected profile
- what each hook enforces at that profile

---

## Phase 3: Generate CWF Capability Index (Explicit)

Generate a CWF-focused capability index. This phase runs only when `--cap-index` is explicitly requested.

### 3.1 Scan CWF Structure

Build CWF capability inventories from the repository:

- [plugins/cwf/.claude-plugin/plugin.json](../../.claude-plugin/plugin.json) (if present)
- [plugins/cwf/hooks/hooks.json](../../hooks/hooks.json), [plugins/cwf/hooks/scripts/cwf-hook-gate.sh](../../hooks/scripts/cwf-hook-gate.sh), and [plugins/cwf/hooks/README.md](../../hooks/README.md) (if present)
- `plugins/cwf/skills/*/SKILL.md`
- `plugins/cwf/references/*.md`
- [plugins/cwf/scripts/README.md](../../scripts/README.md) and key operational scripts (for example [plugins/cwf/scripts/check-session.sh](../../scripts/check-session.sh), `plugins/cwf/scripts/codex/*`)

### 3.2 Build CWF Capability Index

Generate concise capability-oriented sections:

```markdown
## {area} — {capability boundary}

- [label](path/to/file): {what this file is}
```

- Keep descriptions file-centric; avoid procedure-heavy wording.
- Use canonical CWF skill order for [plugins/cwf/skills](../../skills): `setup`, `update`, `gather`, `clarify`, `plan`, `review`, `impl`, `retro`, `handoff`, `ship`, `run`, `refactor`.
- Use deterministic alphabetical order for other sections.
- Ensure every internal file/directory reference uses a Markdown link with a relative target.
- Do not enumerate skill-internal files in index bullets; add one concise sentence that skill-local READMEs contain per-skill file maps.
- For hooks/scripts families, prefer linking [plugins/cwf/hooks/README.md](../../hooks/README.md) and [plugins/cwf/scripts/README.md](../../scripts/README.md) over enumerating every script file.

### 3.3 Write cwf-index.md

Create or overwrite cwf-index.md:

```markdown
# CWF Capability Index

> Generated by `cwf:setup --cap-index`. Default output file: `cwf-index.md`.

{areas}
```

### 3.4 Capability Coverage Validation (Required)

Run:

```bash
bash {SKILL_DIR}/scripts/check-index-coverage.sh cwf-index.md --profile cap
```

This check applies optional exclusions from repository-root .cwf-cap-index-ignore.

If validation fails, regenerate and fix missing coverage before finishing.

---

## Phase 4: Generate Repository Index (Optional)

Generate a repository-wide progressive disclosure index for the current project.

### 4.0 Entry and Safety Rules

When mode is full setup (`cwf:setup`), ask first:

```text
Generate repository index for this repo as well?
```

If user answers `No`, skip Phase 4.

### 4.0.2 Output Target Selection

When generating repository index output (full setup opted-in, or `--repo-index` mode), choose target:

- `file` (recommended): write repo-index.md
- `agents`: update managed index block in AGENTS.md
- `both`: write repo-index.md and update AGENTS.md block

Target resolution:

1. If command includes `--target file|agents|both`, use it.
2. Otherwise ask AskUserQuestion (single choice):
   ```text
   Where should the repository index be written?
   ```
3. Default to `file` if no explicit preference is available.

Managed AGENTS block markers:

```markdown
<!-- CWF:INDEX:START -->
...generated index body...
<!-- CWF:INDEX:END -->
```

If AGENTS.md does not exist and target is `agents` or `both`, create it with a minimal scaffold and the managed block.

### 4.1 Scan Project Structure

Use Glob to find top-level directories. Exclude hidden directories (`.git`, `.claude`), `node_modules`, and `prompt-logs`.

Build adaptive file inventories (sorted) from the current repository structure:

- Root entry docs if present: AGENTS.md, CLAUDE.md, README.md, README.ko.md
- `docs/*.md` (when `docs/` exists)
- `references/**/*.md` (when `references/` exists)
- Any `*/skills/*/SKILL.md` (excluding `.git/`, `node_modules/`, `prompt-logs/`)
- Any non-skill `*/references/*.md` (excluding `.git/`, `node_modules/`, `prompt-logs/`, and `*/skills/*/references/*`)
- If present: [plugins/cwf/hooks/README.md](../../hooks/README.md), [plugins/cwf/scripts/README.md](../../scripts/README.md)

These discovered inventories are mandatory coverage sets for repository index generation.

Apply optional exclusions from repository-root .cwf-index-ignore (glob patterns, one per line) before finalizing repository index content.

### 4.2 Build Repository Index

For each area, generate:

```markdown
## {area} — {task intent boundary; when this area becomes relevant}

- [label](path/to/file): {one-line description of what this file is}
```

- Keep intent text concise and intent-level.
- Absorb read-intent into section headings; omit separate `When to read`/`Role`/`Key files` labels.
- Prefer concise link labels when local context is clear.
- Ensure every internal file/directory reference uses a Markdown link with a relative target.
- Make descriptions file-centric ("what this file is"), not action scripts.
- Do not enumerate skill-internal files in index bullets; add one concise sentence that skill-local READMEs contain per-skill file maps.
- For hooks/scripts families, prefer linking [plugins/cwf/hooks/README.md](../../hooks/README.md) and [plugins/cwf/scripts/README.md](../../scripts/README.md) over enumerating every script file.
- Do not use representative sampling for coverage sets; include every file in the mandatory inventories.
- Use one stable ordering policy:
  - Root: fixed priority order (`README`, `AGENTS`, `CLAUDE`, `cwf-state`, `README.ko`).
  - When [plugins/cwf/skills](../../skills) exists, use canonical CWF workflow order (`setup`, `update`, `gather`, `clarify`, `plan`, `review`, `impl`, `retro`, `handoff`, `ship`, `run`, `refactor`).
  - For non-CWF skill collections, use deterministic alphabetical order.
  - Other sections: deterministic order (alphabetical unless there is a clear canonical sequence).

### 4.3 Write repo-index.md

When target includes `file`, create or overwrite repo-index.md:

```markdown
# Repository Index

> Generated by `cwf:setup --repo-index`. Default output file: [repo-index.md](repo-index.md).

{areas}
```

### 4.4 Update AGENTS.md Managed Block (target=agents|both)

When target includes `agents`, write the generated repository index body into the managed block in AGENTS.md:

- If markers exist, replace only the marker-delimited section.
- If markers are absent, append a new managed block at the end of AGENTS.md.

### 4.5 Repository Coverage Validation (Required)

If target includes `file`, run:

```bash
bash {SKILL_DIR}/scripts/check-index-coverage.sh repo-index.md --profile repo
```

If target includes `agents`, also run:

```bash
bash {SKILL_DIR}/scripts/check-index-coverage.sh AGENTS.md --profile repo
```

This check applies optional exclusions from repository-root .cwf-index-ignore.

If validation fails, regenerate and fix missing links before finishing.

---

## Phase 5: Lessons Checkpoint

### 5.1 Ask for Learnings

Ask the user: "Any learnings from the setup process?"

If yes, append to `lessons.md` in the current session's prompt-logs directory using the standard format:

```markdown
### {title}

- **Expected**: {what was anticipated}
- **Actual**: {what was discovered}
- **Takeaway**: {key insight}
```

### 5.2 Update Stage Checkpoints

Add `setup` to `cwf-state.yaml` current session's `stage_checkpoints` list.

---

## Rules

1. **Default-enabled**: Hooks work without cwf:setup. This skill creates config for customizing (disabling specific groups).
2. **cwf-state.yaml is SSOT**: Read before modifying. Edit, do not overwrite.
3. **Capability index policy**: CWF capability index generation is explicit-only. `cwf:setup` does not generate it by default; use `cwf:setup --cap-index` when needed.
4. **Repository index policy**: Repository-wide index is optional in full setup (ask first). `cwf:setup --repo-index` explicitly regenerates it.
5. **AGENTS block policy**: When repository target includes `agents`, update only the managed marker block (`CWF:INDEX:START/END`) and preserve all other content.
6. **Index content**: Pointers, not summaries. Use section heading intent + link bullets with file-level descriptions. Avoid separate `When to read`/`Role`/`Key files` labels.
7. **Link policy**: Internal files/directories in generated index content must use Markdown links with relative targets, not inline literals.
8. **Coverage policy**: For capability index, cover CWF inventories (skills + plugin references + hooks/scripts READMEs when present). For repository index, cover discovered repository inventories (root/docs/references + skill entry docs + hooks/scripts READMEs when present), except intentional exclusions.
9. **Coverage validation**: Run `{SKILL_DIR}/scripts/check-index-coverage.sh` with explicit profile (`--profile cap` or `--profile repo`) and fix all missing findings.
10. **Ignore policy**: Use .cwf-cap-index-ignore and .cwf-index-ignore only for intentional exclusions.
11. **Bash 3.2 compatible output**: `cwf-hooks-enabled.sh` uses only `export` lines with quoted string values.
12. **AskUserQuestion for all choices**: No batch defaults. Always ask.
13. **Idempotent**: Re-running updates existing config, does not duplicate.
14. **All code fences must have language specifier**: Never use bare fences.
15. **Codex sync uses symlink + backup move**: Do not delete user files directly.
16. **Single-entry setup UX**: `cwf:setup` must ask and apply optional integrations (Codex mode, git hook mode/profile, repo index target) instead of requiring users to remember flags.

## References

- [cwf-hook-gate.sh](../../hooks/scripts/cwf-hook-gate.sh) — hook gate mechanism
- [hooks.json](../../hooks/hooks.json) — hook definitions
- [agent-patterns.md](../../references/agent-patterns.md) — Single pattern
- [sync-skills.sh](../../scripts/codex/sync-skills.sh) — Codex user-scope skill sync
- [verify-skill-links.sh](../../scripts/codex/verify-skill-links.sh) — Codex skill link validation
- [scripts/configure-git-hooks.sh](scripts/configure-git-hooks.sh) — installs and profiles repository git hook gates
- [scripts/check-index-coverage.sh](scripts/check-index-coverage.sh) — deterministic index coverage validation
- .cwf-cap-index-ignore — optional intentional exclusion list for capability index coverage
- .cwf-index-ignore — optional intentional exclusion list for repository index coverage
