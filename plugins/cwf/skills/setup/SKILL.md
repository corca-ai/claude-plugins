---
name: setup
description: "Initial CWF configuration to standardize environment/tool contracts before workflow execution: hook group selection, external tool detection, env migration + project config bootstrap, optional Agent Team mode setup, optional Codex integration, optional git hook gate installation, optional CWF capability index generation, and optional repository index generation. Triggers: \"cwf:setup\", \"setup hooks\", \"configure cwf\""
---

# Setup

Standardize hooks, tool contracts, and environment wiring once so later workflow runs stay reproducible. Includes interactive hook toggles, external tool detection, env migration/bootstrap, optional Agent Team mode setup, optional Codex integration, optional git hook gate installation, optional CWF capability index generation, and optional repository index generation.

**Language**: Write config files in English. Communicate with the user in their prompt language.

## Quick Start

```text
cwf:setup                # Full setup (hooks + tools + env + Agent Team + optional Codex/repo-index prompts)
cwf:setup --hooks        # Hook group selection only
cwf:setup --tools        # External tool detection only
cwf:setup --env          # Environment variable migration/bootstrap only
cwf:setup --agent-teams  # Agent Team mode setup only
cwf:setup --run-mode     # Configure default cwf:run ambiguity mode only
cwf:setup --codex        # Codex integration-only rerun (skills/references sync)
cwf:setup --codex-wrapper # Codex wrapper-only rerun (session log sync + post-run checks)
cwf:setup --git-hooks both --gate-profile balanced  # Install repo git hooks and set gate depth
cwf:setup --git-hooks pre-commit --gate-profile fast # Lightweight local-only git gate
cwf:setup --git-hooks none # Remove repo-managed git hooks
cwf:setup --cap-index    # Generate/refresh CWF capability index only
cwf:setup --repo-index   # Generate/refresh repository index (explicit)
cwf:setup --repo-index --target agents # AGENTS.md managed block (recommended)
```

Operational note:
- Prefer `cwf:setup` first; it is the default entrypoint and asks for optional integrations when relevant.
- Use `--codex` / `--codex-wrapper` when reapplying only Codex-related integration pieces.

## Mode Routing

Parse input flags and run only the relevant phases:

| Input | Phases |
|-------|--------|
| `cwf:setup` | 1 → 2 → 2.8 → 2.9 → 2.10 → 2.4 (if codex available) → 2.7 (always ask) → 4 (opt-in) → 5 |
| `cwf:setup --hooks` | 1 → 5 |
| `cwf:setup --tools` | 2 → 2.8 → 2.9 → 2.10 → 5 |
| `cwf:setup --env` | 2.8 → 2.10 → 5 |
| `cwf:setup --agent-teams` | 2.9 → 5 |
| `cwf:setup --run-mode` | 2.10 → 5 |
| `cwf:setup --codex` | 2.5 → 5 |
| `cwf:setup --codex-wrapper` | 2.6 → 5 |
| `cwf:setup --git-hooks <none\|pre-commit\|pre-push\|both> [--gate-profile <fast\|balanced\|strict>]` | 2.7 → 5 |
| `cwf:setup --cap-index` | 3 → 5 |
| `cwf:setup --repo-index [--target agents]` | 4 → 5 |

When mode is full setup and Codex CLI is available, do not silently skip Codex integration; always run Phase 2.4 and ask the user which integration level to apply.

When mode is full setup, do not expect users to supply optional flags manually. Always ask for git hook installation mode and gate profile in Phase 2.7.

When mode is full setup or tools-only setup, always run Phase 2.8 so legacy env keys are migrated to canonical names and project config files are bootstrapped with explicit user choice.

When mode is full setup or tools-only setup, always run Phase 2.9 so Agent Team mode is explicitly aligned with CWF's multi-agent workflow assumptions.

When mode is full setup, tools-only setup, env-only setup, or run-mode-only setup, always run Phase 2.10 so `cwf:run` default ambiguity policy is explicit and reproducible.

---

## Phase 1: Hook Group Selection

Configure which hook groups are active. Default: all enabled (hooks work without running cwf:setup).

### 1.1 Read Current State

Read `cwf-state.yaml` `hooks:` section for current toggle state.

### 1.2 Present Selection

Use AskUserQuestion with `multiSelect: true`. Present 9 hook groups with descriptions:

| Group | Description |
|-------|-------------|
| `attention` | Slack notifications on idle/waiting |
| `log` | Auto-log turns + auto-commit transcripts |
| `read` | File-size aware reading guard |
| `lint_markdown` | Markdown validation after Write/Edit |
| `lint_shell` | ShellCheck validation after Write/Edit |
| `deletion_safety` | Blocks risky file deletions and requires policy-compliant justification |
| `workflow_gate` | Enforces workflow stage/branch safety rules before edits and commands |
| `websearch_redirect` | Redirect WebSearch to cwf:gather |
| `compact_recovery` | Inject live session state after auto-compact and guard session↔worktree binding on prompts |

Pre-select groups that are currently enabled in `cwf-state.yaml`.

### 1.3 Write Hook Config

Write `~/.claude/cwf-hooks-enabled.sh`:

```bash
# Generated by cwf:setup
export HOOK_ATTENTION_ENABLED="true"
export HOOK_LOG_ENABLED="true"
export HOOK_READ_ENABLED="true"
export HOOK_LINT_MARKDOWN_ENABLED="false"
export HOOK_LINT_SHELL_ENABLED="true"
export HOOK_DELETION_SAFETY_ENABLED="true"
export HOOK_WORKFLOW_GATE_ENABLED="true"
export HOOK_WEBSEARCH_REDIRECT_ENABLED="true"
export HOOK_COMPACT_RECOVERY_ENABLED="true"
```

- One `export HOOK_{GROUP}_ENABLED` line per group (uppercased)
- Values: `"true"` or `"false"` (quoted strings)
- Must match the variable names expected by `cwf-hook-gate.sh`

### 1.4 Update cwf-state.yaml

Edit `cwf-state.yaml` `hooks:` section to mirror the selections:

```yaml
hooks:
  attention: true
  log: true
  read: true
  lint_markdown: false
  lint_shell: true
  deletion_safety: true
  workflow_gate: true
  websearch_redirect: true
  compact_recovery: true
```

---

## Phase 2: External Tool Detection

Detect availability of external AI/search tools and local runtime dependencies used by CWF checks/skills.

### 2.1 Check Tools

Run the following checks via Bash:

```bash
command -v codex >/dev/null 2>&1     # Codex CLI
command -v gemini >/dev/null 2>&1 || npx @google/gemini-cli --version 2>/dev/null  # Gemini CLI
command -v shellcheck >/dev/null 2>&1 # Shell lint gate
command -v jq >/dev/null 2>&1         # JSON parsing for scripts
command -v gh >/dev/null 2>&1         # GitHub CLI for ship
command -v node >/dev/null 2>&1       # Node runtime for gather/review helpers
command -v python3 >/dev/null 2>&1    # Python runtime for gather helpers
```

Check environment variables:

```bash
[ -n "${TAVILY_API_KEY:-}" ]         # Tavily search API
[ -n "${EXA_API_KEY:-}" ]            # Exa search API
```

### 2.2 Update cwf-state.yaml

Edit `cwf-state.yaml` `tools:` section with AI/search results:

```yaml
tools:
  codex: available      # or "unavailable"
  gemini: available     # or "unavailable"
  tavily: available     # or "unavailable"
  exa: unavailable      # or "available"
```

### 2.3 Report Results

Display two result groups:

1) AI/search tools + API keys:

```text
Tool Detection Results:
  codex   : available
  gemini  : available
  tavily  : unavailable (TAVILY_API_KEY not set)
  exa     : unavailable (EXA_API_KEY not set)
```

1) Local runtime dependencies:

```text
Local Dependency Results:
  shellcheck : available|unavailable
  jq         : available|unavailable
  gh         : available|unavailable
  node       : available|unavailable
  python3    : available|unavailable
```

### 2.3.1 Missing Dependency Install Prompt (Required)

If any local runtime dependency is missing, use AskUserQuestion (single choice):

```text
Some CWF runtime dependencies are missing. Install missing tools now?
```

Options:
- `Install missing now (recommended)`:
  - run installer script for missing tools
  - re-check and report unresolved items with exact commands
- `Show commands only`:
  - do not install
  - print exact install commands per missing tool
- `Skip for now`:
  - continue setup without installation

If user selects `Install missing now (recommended)`, run:

```bash
bash {SKILL_DIR}/scripts/install-tooling-deps.sh --install missing
```

If user selects `Show commands only`, run:

```bash
bash {SKILL_DIR}/scripts/install-tooling-deps.sh --check
```

Then print manual install commands for each missing tool from script output.

### 2.3.2 Retry Check (After Install Attempt)

After `Install missing now` path, re-run:

```bash
bash {SKILL_DIR}/scripts/install-tooling-deps.sh --check
```

If still missing, explicitly list unresolved tools and ask whether to continue setup or stop for manual installation.

---

## Phase 2.4: Codex Integration on Full Setup

Use this phase when:
- Mode is full setup (`cwf:setup`)
- Phase 2 detected `codex: available`

### 2.4.1 Ask Integration Level

Use AskUserQuestion (single choice):

```text
Codex CLI was detected. How should CWF integrate with Codex?
```

Options:
- `Skills + wrapper (recommended)`:
  - Link CWF skills/references into `~/.agents/*`
  - Install `codex` wrapper and PATH line for automatic session log sync + post-run quality checks (tool-hygiene + HITL sync gates included)
- `Skills only`:
  - Link skills/references only (no wrapper install)
- `Skip for now`:
  - Do not change Codex integration in this run

### 2.4.2 Execute Selection

If `Skills + wrapper (recommended)`:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/sync-skills.sh --cleanup-legacy
bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --enable --add-path
bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --status
```

If `Skills only`:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/sync-skills.sh --cleanup-legacy
```

If `Skip for now`: no command execution in this phase.

### 2.4.3 Always Print Post-Setup Verification

When wrapper install was selected, always report:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --status
type -a codex
```

And include this note in plain language:

```text
Open a new shell (or source ~/.zshrc). After that, running `codex` will auto-sync session logs.
Aliases that call `codex` (for example: codexyolo='codex ...') also inherit this behavior.
Post-run checks run in `warn` mode by default (`CWF_CODEX_POST_RUN_MODE=strict` to enforce non-zero exit on check failures).
Current post-run gates include markdown/shell/link/live-state checks, `apply_patch via exec_command` hygiene detection, and HITL scratchpad sync detection for doc edits.
```

---

## Phase 2.5: Codex User-Scope Skill Sync (Optional)

Use this phase when:
- User runs `cwf:setup --codex`
- Full setup and user wants Codex to load CWF from local repo via symlink

### 2.5.1 Run Sync Script

Run:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/sync-skills.sh --cleanup-legacy
```

Expected behavior:
- Link CWF skills from `plugins/cwf/skills/*` into `~/.agents/skills`
- Link shared references into `~/.agents/references`
- Move legacy custom entries from `~/.codex/skills` to backup (`.system` is kept)
- Validate relative skill references via `{CWF_PLUGIN_DIR}/scripts/codex/verify-skill-links.sh`

### 2.5.2 Report Results

Report:
- Number of linked skills
- Destination paths (`~/.agents/skills`, `~/.agents/references`)
- Whether legacy `~/.codex/skills` was moved and backup path
- Quick verification command:

```bash
ls -la ~/.agents/skills
```

---

## Phase 2.6: Codex Wrapper Opt-In (Optional)

Use this phase when:
- User runs `cwf:setup --codex-wrapper`
- Full setup and user wants Codex session logs auto-synced into repo artifacts with post-run quality checks

### 2.6.1 Ask for Opt-In

Use AskUserQuestion before making shell-level changes:

```text
Enable Codex wrapper for automatic session log sync and post-run quality checks (including tool-hygiene + HITL sync gates)?
```

If user declines, skip this phase.

### 2.6.2 Install Wrapper (Approved Only)

Run:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --enable --add-path
```

This installs a wrapper symlink at `~/.local/bin/codex` pointing to:

```text
{CWF_PLUGIN_DIR}/scripts/codex/codex-with-log.sh
```

The wrapper preserves normal Codex behavior and runs:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/sync-session-logs.sh --cwd "$PWD"
bash {CWF_PLUGIN_DIR}/scripts/codex/post-run-checks.sh --cwd "$PWD" --mode warn
```

after each Codex run. Logs are persisted under `.cwf/sessions/` by default (legacy fallback: `.cwf/projects/sessions/`) as `*.codex.md` (`raw` JSONL copy is opt-in via `--raw`), and changed-file quality checks are executed in `warn` mode by default.

### 2.6.3 Report and Reversal

Report current status:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --status
```

Provide rollback command:

```bash
bash {CWF_PLUGIN_DIR}/scripts/codex/install-wrapper.sh --disable
```

Include activation note:

```text
If wrapper is active, restart shell (or source ~/.zshrc) before testing `codex`.
Post-run behavior can be tuned with:
- `CWF_CODEX_POST_RUN_CHECKS=true|false` (default: true)
- `CWF_CODEX_POST_RUN_MODE=warn|strict` (default: warn)
- `CWF_CODEX_POST_RUN_QUIET=true|false` (default: false)
```

---

## Phase 2.7: Git Hook Gate Installation

Use this phase when:
- Mode is full setup (`cwf:setup`)
- User runs `cwf:setup --git-hooks ...`

### 2.7.1 Resolve Install Mode

Install mode values:
- `none`
- `pre-commit`
- `pre-push`
- `both`

Resolution order:
1. If command includes `--git-hooks <value>`, use it.
2. Otherwise ask AskUserQuestion (single choice):
   ```text
   Configure repository git hook gates as part of setup?
   ```
   Options:
   - `both` (recommended)
   - `pre-commit`
   - `pre-push`
   - `none`

### 2.7.2 Resolve Gate Profile

Gate profile values:
- `fast`: markdownlint only
- `balanced`: markdownlint + local link checks + staged shellcheck + push-time index coverage checks
- `strict`: balanced + provenance freshness and growth-drift reports on push

Resolution order:
1. If command includes `--gate-profile <value>`, use it.
2. Otherwise ask AskUserQuestion (single choice):
   ```text
   Select git gate profile (speed vs coverage).
   ```
   Options:
   - `balanced` (recommended)
   - `fast`
   - `strict`

If install mode is `none`, skip gate profile selection.

### 2.7.3 Apply Configuration

Run:

```bash
bash {SKILL_DIR}/scripts/configure-git-hooks.sh --install <mode> --profile <profile>
```

This script updates repository git hook files (`pre-commit`, `pre-push`) under the configured hooks path and sets `git config core.hooksPath .githooks` when hooks are enabled.

### 2.7.4 Report Effective State

Always report:

```bash
git config --get core.hooksPath
```

And summarize:
- installed hooks (`pre-commit`, `pre-push`)
- selected profile
- what each hook enforces at that profile

---

## Phase 2.8: Environment Migration and Project Config Bootstrap

Use this phase when:
- Mode is full setup (`cwf:setup`)
- User runs `cwf:setup --tools`
- User runs `cwf:setup --env`

### 2.8.1 Scan Existing Environment Config

Run:

```bash
bash {SKILL_DIR}/scripts/migrate-env-vars.sh --scan
```

This scan checks `~/.zshrc`, `~/.bashrc`, and `~/.claude/.env` (if present), and reports:
- legacy-to-canonical migration candidates (`CLAUDE_CORCA_*`/`CLAUDE_ATTENTION_*` → `CWF_*`)
- missing required keys (`SLACK_BOT_TOKEN`, `SLACK_CHANNEL_ID`, `TAVILY_API_KEY`, `EXA_API_KEY`)

### 2.8.2 Ask Apply Strategy

Use AskUserQuestion (single choice):

```text
Apply environment variable migration now?
```

Options:
- `Auto migrate now (recommended)`:
  - apply canonical exports into active shell profile
  - comment legacy assignments in scanned files
  - include commented placeholders for missing required keys
- `Review first`:
  - show scan output and the exact apply command
  - ask one additional confirm question before applying
- `Skip for now`:
  - no file modifications in this phase

### 2.8.3 Apply Migration

When apply is approved, run:

```bash
bash {SKILL_DIR}/scripts/migrate-env-vars.sh --apply --cleanup-legacy --include-placeholders
```

If the user wants a specific target profile, pass:

```bash
bash {SKILL_DIR}/scripts/migrate-env-vars.sh --apply --cleanup-legacy --include-placeholders --target-profile ~/.zshrc
```

### 2.8.4 Report Effective State

Always report:
- applied profile path
- migrated key list
- missing required keys still needing real values

Provide verification command:

```bash
rg -n "CWF_|TAVILY_API_KEY|EXA_API_KEY|SLACK_BOT_TOKEN|SLACK_CHANNEL_ID" ~/.zshrc ~/.bashrc ~/.claude/.env
```

Include activation note:

```text
Open a new shell (or source ~/.zshrc / ~/.bashrc) so updated exports are loaded.
```

### 2.8.5 Bootstrap Project Config Files

Ask whether to create project-level config files (.cwf/config.yaml, .cwf/config.local.yaml) now:

```text
Create project config templates now? (.cwf/config.yaml + .cwf/config.local.yaml)
```

Options:
- `Yes (recommended)`:
  - create missing config templates
  - keep existing files unchanged
  - ensure .cwf/config.local.yaml is listed in `.gitignore`
- `Overwrite templates`:
  - re-write both templates (`--force`)
  - ensure .cwf/config.local.yaml is listed in `.gitignore`
- `Skip for now`:
  - no file changes in this sub-phase

When user selects `Yes (recommended)`, run:

```bash
bash {SKILL_DIR}/scripts/bootstrap-project-config.sh
```

When user selects `Overwrite templates`, run:

```bash
bash {SKILL_DIR}/scripts/bootstrap-project-config.sh --force
```

### 2.8.6 Explain Runtime Priority

After migration/bootstrap decisions, always report the effective CWF config source priority:

1. .cwf/config.local.yaml
2. .cwf/config.yaml
3. Process environment
4. Shell profile exports (`~/.zshenv`, `~/.zprofile`, `~/.zshrc`, `~/.bash_profile`, `~/.bashrc`, `~/.profile`)

Include this operational guidance:

```text
Use .cwf/config.yaml for team-shared, non-secret defaults.
Use .cwf/config.local.yaml for local/secret values.
Keep shell exports as global fallback.
```

---

## Phase 2.9: Agent Team Mode Setup

Use this phase when:
- Mode is full setup (`cwf:setup`)
- User runs `cwf:setup --tools`
- User runs `cwf:setup --agent-teams`

### 2.9.1 Ask Team Mode Policy

Use AskUserQuestion (single choice):

```text
Configure Claude Code Agent Team mode now?
```

Options:
- `Enable Agent Team mode (recommended)`:
  - sets `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1` in `~/.claude/settings.json` `env`
- `Keep current setting`:
  - no modification, status report only
- `Disable Agent Team mode`:
  - removes `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS` from `~/.claude/settings.json` `env`

### 2.9.2 Apply Selection

When user selects `Enable Agent Team mode (recommended)`, run:

```bash
bash {SKILL_DIR}/scripts/configure-agent-teams.sh --enable
```

When user selects `Keep current setting`, run:

```bash
bash {SKILL_DIR}/scripts/configure-agent-teams.sh --status
```

When user selects `Disable Agent Team mode`, run:

```bash
bash {SKILL_DIR}/scripts/configure-agent-teams.sh --disable
```

### 2.9.3 Report Effective State

Always report:

```bash
bash {SKILL_DIR}/scripts/configure-agent-teams.sh --status
```

And include this note in plain language:

```text
Restart Claude Code (or open a new session) so Agent Team mode changes are applied consistently.
```

---

## Phase 2.10: cwf:run Ambiguity Mode Setup

Use this phase when:
- Mode is full setup (`cwf:setup`)
- User runs `cwf:setup --tools`
- User runs `cwf:setup --env`
- User runs `cwf:setup --run-mode`

### 2.10.1 Detect Current Effective Mode

Run:

```bash
source {CWF_PLUGIN_DIR}/hooks/scripts/env-loader.sh
cwf_env_load_vars CWF_RUN_AMBIGUITY_MODE
printf '%s\n' "${CWF_RUN_AMBIGUITY_MODE:-defer-blocking}"
```

If the key is unset anywhere, treat `defer-blocking` as the effective default.

### 2.10.2 Ask Desired Default Mode

Use AskUserQuestion (single choice):

```text
Select default ambiguity handling mode for cwf:run (T3 decisions in clarify).
```

Options:
- `defer-blocking (recommended)`:
  - continue autonomously
  - must record autonomous T3 decisions
  - must carry unresolved decisions to ship as merge-blocking items
- `strict`:
  - stop and ask the user at T3
- `defer-reversible`:
  - continue autonomously with reversible implementation structure
  - still record decisions, but not merge-blocking by default
- `explore-worktrees`:
  - implement alternatives in separate worktrees and compare before finalization

### 2.10.3 Ask Config Scope

Use AskUserQuestion (single choice):

```text
Where should this default mode be saved?
```

Options:
- `Shared config (recommended)`:
  - write to `.cwf/config.yaml`
  - team-wide default for this repository
- `Local config`:
  - write to `.cwf/config.local.yaml`
  - local override only (highest priority)

### 2.10.4 Persist Selection

Run:

```bash
bash {SKILL_DIR}/scripts/configure-run-mode.sh --mode <selected-mode> --scope <shared|local>
```

If config templates are missing, bootstrap first:

```bash
bash {SKILL_DIR}/scripts/bootstrap-project-config.sh
```

Then retry `configure-run-mode.sh`.

### 2.10.5 Report Effective State

Report:
- selected mode
- selected scope
- written config path

Provide verification command:

```bash
rg -n "^CWF_RUN_AMBIGUITY_MODE:" .cwf/config.yaml .cwf/config.local.yaml 2>/dev/null
```

Also report precedence reminder:
- `--ambiguity-mode` flag
- `.cwf/config.local.yaml`
- `.cwf/config.yaml`
- env/shell
- built-in default (`defer-blocking`)

---

## Phase 3: Generate CWF Capability Index (Explicit)

Generate a CWF-focused capability index. This phase runs only when `--cap-index` is explicitly requested.

### 3.1 Scan CWF Structure

Build CWF capability inventories from the repository:

- [plugins/cwf/.claude-plugin/plugin.json](../../.claude-plugin/plugin.json) (if present)
- [plugins/cwf/hooks/hooks.json](../../hooks/hooks.json), [plugins/cwf/hooks/scripts/cwf-hook-gate.sh](../../hooks/scripts/cwf-hook-gate.sh), and [plugins/cwf/hooks/README.md](../../hooks/README.md) (if present)
- `plugins/cwf/skills/*/SKILL.md`
- `plugins/cwf/references/*.md`
- [plugins/cwf/scripts/README.md](../../scripts/README.md) and key operational scripts (for example [plugins/cwf/scripts/check-session.sh](../../scripts/check-session.sh), `plugins/cwf/scripts/codex/*`)

### 3.2 Build CWF Capability Index

Generate concise capability-oriented sections:

```markdown
## {area} — {capability boundary}

- [label](path/to/file): {what this file is}
```

- Keep descriptions file-centric; avoid procedure-heavy wording.
- Use canonical CWF skill order for [plugins/cwf/skills](../../skills): `setup`, `update`, `gather`, `clarify`, `plan`, `review`, `impl`, `retro`, `handoff`, `ship`, `run`, `refactor`.
- Use deterministic alphabetical order for other sections.
- Ensure every internal file/directory reference uses a Markdown link with a relative target.
- Do not enumerate skill-internal files in index bullets; add one concise sentence that skill-local READMEs contain per-skill file maps.
- For hooks/scripts families, prefer linking [plugins/cwf/hooks/README.md](../../hooks/README.md) and [plugins/cwf/scripts/README.md](../../scripts/README.md) over enumerating every script file.

### 3.3 Write Capability Index

Create or overwrite the capability index output file under the artifact index directory:

```markdown
# CWF Capability Index

> Generated by `cwf:setup --cap-index`. Default output file: `.cwf/indexes/cwf-index.md`.

{areas}
```

### 3.4 Capability Coverage Validation (Required)

Run:

```bash
bash {SKILL_DIR}/scripts/check-index-coverage.sh .cwf/indexes/cwf-index.md --profile cap
```

This check applies optional exclusions from repository-root .cwf-cap-index-ignore.

If validation fails, regenerate and fix missing coverage before finishing.

---

## Phase 4: Generate Repository Index (Optional)

Generate a repository-wide progressive disclosure index for the current project.

### 4.0 Entry and Safety Rules

When mode is full setup (`cwf:setup`), ask first:

```text
Generate repository index for this repo as well?
```

If user answers `No`, skip Phase 4.

### 4.0.2 Output Target Selection

In this repository, repository index output is managed in AGENTS.md only.

Target resolution:

1. If command includes `--target agents`, use it.
2. If command includes `--target file` or `--target both`, normalize to `agents` and report that this repository uses AGENTS-managed output only.
3. Otherwise default to `agents`.

Managed AGENTS block markers:

```markdown
<!-- CWF:INDEX:START -->
...generated index body...
<!-- CWF:INDEX:END -->
```

If AGENTS.md does not exist, create it with a minimal scaffold and the managed block.

### 4.1 Scan Project Structure

Use Glob to find top-level directories. Exclude hidden directories (`.git`, `.claude`, `.cwf`), `node_modules`, and `projects`.

Build adaptive file inventories (sorted) from the current repository structure:

- Root entry docs if present: AGENTS.md, CLAUDE.md, README.md, README.ko.md
- `docs/*.md` (when `docs/` exists)
- `references/**/*.md` (when `references/` exists)
- Any `*/skills/*/SKILL.md` (excluding `.git/`, `.cwf/`, `node_modules/`, `projects/`)
- Any non-skill `*/references/*.md` (excluding `.git/`, `.cwf/`, `node_modules/`, `projects/`, and `*/skills/*/references/*`)
- If present: [plugins/cwf/hooks/README.md](../../hooks/README.md), [plugins/cwf/scripts/README.md](../../scripts/README.md)

These discovered inventories are mandatory coverage sets for repository index generation.

Apply optional exclusions from repository-root .cwf-index-ignore (glob patterns, one per line) before finalizing repository index content.

### 4.2 Build Repository Index

For each area, generate:

```markdown
## {area} — {task intent boundary; when this area becomes relevant}

- [label](path/to/file): {one-line description of what this file is}
```

- Keep intent text concise and intent-level.
- Absorb read-intent into section headings; omit separate `When to read`/`Role`/`Key files` labels.
- Prefer concise link labels when local context is clear.
- Ensure every internal file/directory reference uses a Markdown link with a relative target.
- Make descriptions file-centric ("what this file is"), not action scripts.
- Do not enumerate skill-internal files in index bullets; add one concise sentence that skill-local READMEs contain per-skill file maps.
- For hooks/scripts families, prefer linking [plugins/cwf/hooks/README.md](../../hooks/README.md) and [plugins/cwf/scripts/README.md](../../scripts/README.md) over enumerating every script file.
- Do not use representative sampling for coverage sets; include every file in the mandatory inventories.
- Use one stable ordering policy:
  - Root: fixed priority order (`README`, `AGENTS`, `CLAUDE`, `cwf-state`, `README.ko`).
  - When [plugins/cwf/skills](../../skills) exists, use canonical CWF workflow order (`setup`, `update`, `gather`, `clarify`, `plan`, `review`, `impl`, `retro`, `handoff`, `ship`, `run`, `refactor`).
  - For non-CWF skill collections, use deterministic alphabetical order.
  - Other sections: deterministic order (alphabetical unless there is a clear canonical sequence).

### 4.3 Update AGENTS.md Managed Block

Write the generated repository index body into the managed block in AGENTS.md:

- If markers exist, replace only the marker-delimited section.
- If markers are absent, append a new managed block at the end of AGENTS.md.

### 4.4 Repository Coverage Validation (Required)

Run:

```bash
bash {SKILL_DIR}/scripts/check-index-coverage.sh AGENTS.md --profile repo
```

This check applies optional exclusions from repository-root .cwf-index-ignore.

If validation fails, regenerate and fix missing links before finishing.

---

## Phase 5: Lessons Checkpoint

### 5.1 Ask for Learnings

Ask the user: "Any learnings from the setup process?"

If yes, append to `lessons.md` in the current session artifact directory using the standard format:

```markdown
### {title}

- **Expected**: {what was anticipated}
- **Actual**: {what was discovered}
- **Takeaway**: {key insight}
```

### 5.2 Update Stage Checkpoints

Add `setup` to `cwf-state.yaml` current session's `stage_checkpoints` list.

---

## Rules

1. **Default-enabled**: Hooks work without cwf:setup. This skill creates config for customizing (disabling specific groups).
2. **cwf-state.yaml is SSOT**: Read before modifying. Edit, do not overwrite.
3. **Capability index policy**: CWF capability index generation is explicit-only. `cwf:setup` does not generate it by default; use `cwf:setup --cap-index` when needed.
4. **Repository index policy**: Repository-wide index is AGENTS-managed in this repository. `cwf:setup --repo-index` updates the AGENTS managed block.
5. **AGENTS block policy**: Update only the managed marker block (`CWF:INDEX:START/END`) and preserve all other content.
6. **Index content**: Pointers, not summaries. Use section heading intent + link bullets with file-level descriptions. Avoid separate `When to read`/`Role`/`Key files` labels.
7. **Link policy**: Internal files/directories in generated index content must use Markdown links with relative targets, not inline literals.
8. **Coverage policy**: For capability index, cover CWF inventories (skills + plugin references + hooks/scripts READMEs when present). For repository index, cover discovered repository inventories (root/docs/references + skill entry docs + hooks/scripts READMEs when present), except intentional exclusions.
9. **Coverage validation**: Run `{SKILL_DIR}/scripts/check-index-coverage.sh` with explicit profile (`--profile cap` or `--profile repo`) and fix all missing findings.
10. **Ignore policy**: Use .cwf-cap-index-ignore and .cwf-index-ignore only for intentional exclusions.
11. **Bash 3.2 compatible output**: `cwf-hooks-enabled.sh` uses only `export` lines with quoted string values.
12. **AskUserQuestion for all choices**: No batch defaults. Always ask.
13. **Idempotent**: Re-running updates existing config, does not duplicate.
14. **All code fences must have language specifier**: Never use bare fences.
15. **Codex sync uses symlink + backup move**: Do not delete user files directly.
16. **Single-entry setup UX**: `cwf:setup` must ask and apply optional integrations (Codex mode, git hook mode/profile) instead of requiring users to remember flags.
17. **Env/project-config UX**: `cwf:setup` must detect and offer migration of legacy env keys to canonical `CWF_*` names, then offer project config bootstrap (.cwf/config.yaml, .cwf/config.local.yaml) with explicit user choice.
18. **Agent Team UX**: `cwf:setup` must include explicit Agent Team mode setup so multi-agent skills do not silently depend on an unset runtime flag.
19. **Dependency install UX**: When local runtime dependencies are missing, `cwf:setup` must ask whether to install now and run [scripts/install-tooling-deps.sh](scripts/install-tooling-deps.sh) on approval.
20. **No passive missing-only report**: Missing prerequisites must end with either an install attempt or explicit manual install commands plus continue/stop choice.
21. **Run ambiguity default must be explicit**: `cwf:setup` must expose and persist `CWF_RUN_AMBIGUITY_MODE` via Phase 2.10.

## References

- [cwf-hook-gate.sh](../../hooks/scripts/cwf-hook-gate.sh) — hook gate mechanism
- [hooks.json](../../hooks/hooks.json) — hook definitions
- [agent-patterns.md](../../references/agent-patterns.md) — Single pattern
- [sync-skills.sh](../../scripts/codex/sync-skills.sh) — Codex user-scope skill sync
- [verify-skill-links.sh](../../scripts/codex/verify-skill-links.sh) — Codex skill link validation
- [scripts/configure-git-hooks.sh](scripts/configure-git-hooks.sh) — installs and profiles repository git hook gates
- [scripts/migrate-env-vars.sh](scripts/migrate-env-vars.sh) — legacy env detection and canonical CWF env migration
- [scripts/bootstrap-project-config.sh](scripts/bootstrap-project-config.sh) — project config template/bootstrap and `.gitignore` sync
- [scripts/configure-agent-teams.sh](scripts/configure-agent-teams.sh) — toggles Claude Agent Team runtime mode in `~/.claude/settings.json`
- [scripts/configure-run-mode.sh](scripts/configure-run-mode.sh) — persists default `cwf:run` ambiguity mode into project config
- [scripts/install-tooling-deps.sh](scripts/install-tooling-deps.sh) — checks/installs missing local runtime dependencies for CWF workflows
- [scripts/check-index-coverage.sh](scripts/check-index-coverage.sh) — deterministic index coverage validation
- .cwf-cap-index-ignore — optional intentional exclusion list for capability index coverage
- .cwf-index-ignore — optional intentional exclusion list for repository index coverage
