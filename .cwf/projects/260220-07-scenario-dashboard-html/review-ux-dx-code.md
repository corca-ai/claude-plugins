## UX/DX Review

### Concerns (blocking)

- **[C1]** `classify_case_result` uses global-style variables (`RUN_RESULT`, `RUN_REASON`) to return values instead of a structured approach.
  Severity: moderate
  File: `scripts/runtime-residual-smoke.sh`, lines 170-191 (full file)
  The function `classify_case_result` sets two "output" variables `RUN_RESULT` and `RUN_REASON` that callers must read immediately after invocation (lines 250-252). This is a fragile calling convention that is not documented in any comment on the function itself. A new contributor reading `run_case()` has to scan backward to discover that `classify_case_result` silently sets globals. At minimum, a brief comment on `classify_case_result` should state: "Sets RUN_RESULT and RUN_REASON as output variables." The convention is acceptable in Bash but the current lack of documentation makes the contract invisible.

- **[C2]** Inconsistent session title naming in `cwf-state.yaml` erodes predictability.
  Severity: moderate
  File: `.cwf/cwf-state.yaml`, diff lines 22-63
  Six new session entries are registered with inconsistent titles: `retro-light`, `retro-light-2`, `retro-light` (again, same title for a different session), `retro-light-4`, `retro-light-5`, `retro-light` (third occurrence). The alternation between suffixed (`retro-light-2`) and unsuffixed (`retro-light`) names for distinct sessions makes it difficult to correlate session IDs to directories at a glance. While this is likely auto-generated by the bootstrap process, the inconsistency suggests the naming heuristic in `next-prompt-dir.sh --bootstrap` is nondeterministic for the title field, which may confuse tooling or developers reading state. The underlying generator should ensure title uniqueness or at least consistent suffix application.

- **[C3]** The `--k46-timeout-retries` and `--s10-no-output-retries` option names use case-specific prefixes that couple the option semantics to particular test case IDs rather than expressing generic intent.
  Severity: moderate
  File: `scripts/runtime-residual-smoke.sh`, help text lines 24-29 and argument parsing lines 69-86
  These option names (`--k46-timeout-retries`, `--s10-no-output-retries`) are tightly coupled to the internal case identifiers `K46` and `S10`. If new cases are added (e.g., a `P20` case), the naming pattern would require more case-specific flags, leading to a flag explosion. A more extensible design might use `--retry-on-timeout <n>` and `--retry-on-no-output <n>` as generic policies that apply to any case exhibiting that failure mode, or a generic `--retries <case>:<count>` syntax. This is flagged as moderate because the script currently has only two cases, but the naming sets a poor precedent for extension.

- **[C4]** Error message for retry validation is less specific than other validation messages in the same script.
  Severity: moderate
  File: `scripts/runtime-residual-smoke.sh`, lines 116-121
  The error message `"Error: retry options must be zero or positive integers"` does not name which option failed. Compare this to the earlier numeric validation (lines 109-113) which also gives a generic message `"numeric options must be positive integers"`. Both would benefit from naming the offending variable, but the retry validation is worse because it combines two unrelated options (`K46_TIMEOUT_RETRIES` and `S10_NO_OUTPUT_RETRIES`) in one loop and the user cannot tell which value is invalid. The error should report which option was invalid and what value was provided.

### Suggestions (non-blocking)

- **[S1]** Double blank lines between session entries in `cwf-state.yaml` add unnecessary vertical spacing.
  File: `.cwf/cwf-state.yaml`, diff lines 22-63
  Each session entry is separated by two blank lines instead of one. Existing entries elsewhere in the file use single blank-line separation. This creates visual inconsistency and bloats the file. The `append_session_entry` AWK logic in `next-prompt-dir.sh` (line 5168 in diff) prints an explicit empty line `print ""` before each entry; consider whether the calling code is also adding a blank line, resulting in double spacing.

- **[S2]** The HITL SKILL.md removes the old rule 11 ("comment-driven doc HITL" `Before/After/After Intent` flow) from its prominent numbered position and tucks it into rule 14 with reduced visibility.
  File: `plugins/cwf/skills/hitl/SKILL.md`, diff lines 5254-5259
  The original rule 11 described a specific, high-value workflow for comment-driven doc HITL. The new rule 14 rephrases it as "keep the same chunk contract and include `Before`, `After`, `After Intent` within the `Primary Chunk` section." This is functionally equivalent but the reordering buries it deeper in the rules list. Consider adding a cross-reference or a note in the Phase 2 chunk output template (items 1-7) indicating that doc-HITL comment-driven reviews use the `Before/After/After Intent` substructure within `Primary Chunk`.

- **[S3]** The `context_refs` YAML schema example in `hitl-state-model.md` uses a pipe-delimited enum for `kind` and `relation` fields, which is descriptive but could mislead someone into thinking the pipe character is literal YAML syntax.
  File: `plugins/cwf/skills/hitl/references/hitl-state-model.md`, lines 50-56
  The `kind` field shows `"code_call_site|code_definition|code_test|code_adjacent|doc_reference|doc_backlink|doc_policy|doc_adjacent"` as a single string with pipes. A brief comment like `# one of:` before each enum-style field, or splitting onto separate lines, would clarify that these are alternative values, not a single concatenated string.

- **[S4]** The `run_case` function in `runtime-residual-smoke.sh` has grown to approximately 100 lines with retry logic, fallback probing, and result classification. Consider extracting the S10 fallback probe into a separate function (e.g., `run_s10_fallback`) to reduce cognitive load when reading the main loop.
  File: `scripts/runtime-residual-smoke.sh`, lines 203-308

- **[S5]** The `setup/SKILL.md` routing guard update ("anywhere in input" vs. "starts with") is a good DX improvement, but the description could link to the lesson/evidence that motivated the change (e.g., the iter5 scenario or lesson entry) so future maintainers understand why prefix-only matching was insufficient.
  File: `plugins/cwf/skills/setup/SKILL.md`, lines 64-70

- **[S6]** Massive volume of duplicated log artifacts in the diff.
  Files: `.cwf/runtime-residual-smoke/260220-*/` and `.cwf/projects/260219-01-pre-release-audit-pass2/iter5/artifacts/runtime-residual-smoke/260220-*/`
  Approximately 150+ of the 207 changed files are runtime smoke test log artifacts that appear in two locations: once under `.cwf/runtime-residual-smoke/` (working output) and again copied under `.cwf/projects/.../iter5/artifacts/runtime-residual-smoke/` (evidence archive). Many of these are identical content. The `.retry2`/`.retry3` suffix files are particularly voluminous. Consider whether all retry attempt logs need to be committed to the repository, or whether only the final summary TSV and selected exemplar logs would suffice for evidence. Adding a `.gitignore` rule for `.cwf/runtime-residual-smoke/` working output (keeping only the curated artifacts copy) would reduce commit noise significantly.

- **[S7]** The `next-prompt-dir.sh` inline sessions expansion uses `print ""` in AWK to produce a blank line, but the expanded output (`sessions:` on one line, blank, then `- id: ...`) does not match the block-style formatting used by existing entries which have `sessions:` immediately followed by entries. This minor formatting inconsistency may cause YAML lint warnings or confuse downstream parsers that are whitespace-sensitive.
  File: `plugins/cwf/scripts/next-prompt-dir.sh`, diff line 5168

- **[S8]** The mock Claude script in `runtime-residual-smoke-fixtures.sh` now matches both `"cwf:setup"` and `"cwf:setup --hooks"` (line 109), which correctly mirrors the fallback behavior added to the real smoke script. However, the mock does not distinguish behavior between the two prompts -- both produce identical output. If the fallback is meant to exercise a different code path (as the real `--hooks` flag does), consider having the mock emit slightly different output so the fixture can verify that the fallback path was actually taken, not just that the same output was produced twice.
  File: `scripts/tests/runtime-residual-smoke-fixtures.sh`, line 109

### Behavioral Criteria Assessment

No specific success criteria were provided. The review is based on general best practices for UX/DX quality:

1. **Error message quality**: Error messages in `runtime-residual-smoke.sh` are generally actionable (they state the constraint and print to stderr) but lack specificity about which option triggered the error (see C4). The `is_wait_input_log` pattern-matching grep (line 166) contains a very long regex that is difficult to maintain; adding a comment explaining the detection heuristic would help future contributors.

2. **Naming quality**: Script and function names are descriptive (`classify_case_result`, `invoke_prompt`, `run_case`). Option flags are clear but overly case-specific (see C3). The HITL terminology (`Primary Chunk + Related Context + Causal Lens`) is well-named and self-describing.

3. **Documentation completeness**: The HITL skill update is well-documented with a new "Related Context Resolution" subsection and explicit state model additions. The setup SKILL.md routing guard clarification is concise and correct. The `runtime-residual-smoke.sh` help text accurately reflects the new options. The `classify_case_result` function lacks documentation of its output contract (see C1).

4. **Interface complexity**: The retry and fallback additions to `runtime-residual-smoke.sh` add necessary complexity with reasonable defaults (retries default to 1 and 2 respectively). The HITL context_refs contract introduces new required fields but provides clear schema documentation and fallback semantics (`adjacent_fallback`).

5. **Consistency**: The version bump (0.8.3 to 0.8.4) is consistent across both `marketplace.json` and `plugin.json`. The session title naming in `cwf-state.yaml` is inconsistent (see C2). The test fixtures correctly mirror production behavior changes.

6. **Onboarding friction**: The HITL changes are well-structured with a clear principle statement at the top of the file ("Every chunk review must be presented as: Primary Chunk + Related Context + Causal Lens. Do not present isolated chunks.") which provides immediate orientation. The iteration 5 progress and scenario documentation provides good breadcrumbs for understanding why changes were made.

### Provenance
source: REAL_EXECUTION
tool: claude-task
reviewer: UX/DX
duration_ms: --
command: --
<!-- AGENT_COMPLETE -->
