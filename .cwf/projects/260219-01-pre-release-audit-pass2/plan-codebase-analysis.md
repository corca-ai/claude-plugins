# Codebase Execution Analysis

## Requested Workflow Execution Paths

### Refactor (`cwf:refactor --codebase` / `--codebase --deep`)
- Bootstrap the repository-local contract before scanning so that the quick scan (and the deep-review expert configuration) read the pre-populated scope/checks/deep settings; the shell-strict-mode clause also communicates the require-contract-and-pragma rule for specific files (`plugins/cwf/skills/refactor/scripts/bootstrap-codebase-contract.sh:4-381`).
- Run the contract-driven quick scan via `plugins/cwf/skills/refactor/scripts/codebase-quick-scan.sh` (which enumerates git-index files, resolves the artifact root, and shells out to the Python backend) and write `{session_dir}/refactor-codebase-scan.json`, then summarize and gate with `plugins/cwf/scripts/check-run-gate-artifacts.sh` once `refactor-summary.md` is persisted (`plugins/cwf/skills/refactor/SKILL.md:201-236`, `plugins/cwf/skills/refactor/scripts/codebase-quick-scan.sh:16-131`, `plugins/cwf/scripts/check-run-gate-artifacts.sh:73-203`).
- For `--codebase --deep`, chain the scan with the expert-selection+deep agent flow in `plugins/cwf/skills/refactor/references/codebase-deep-review-flow.md:1-44`; run `plugins/cwf/skills/refactor/scripts/select-codebase-experts.sh` to produce `{session_dir}/refactor-codebase-experts.json`, spawn four expert agents (Fowler, Beck, two contextual contractors), write their sentinel-marked outputs, then merge everything into the same `refactor-summary.md` before re-running the same gate (`plugins/cwf/skills/refactor/references/codebase-deep-review-flow.md:1-52`, `plugins/cwf/skills/refactor/scripts/select-codebase-experts.sh:4-376`).

### Deep review for each skill (`cwf:refactor --skill <name>`)
- Locate the target SKILL.md per the deep-review flow, read its `references/`, `scripts/`, and `assets/`, verify `review-criteria.provenance.yaml` via `plugins/cwf/scripts/provenance-check.sh`, and let two Task agents (structural vs. quality/concept) run in parallel with session files `refactor-deep-structural-<skill>.md` and `refactor-deep-quality-<skill>.md` (`plugins/cwf/skills/refactor/SKILL.md:255-265`, `plugins/cwf/skills/refactor/references/deep-review-flow.md:3-97`).
- Persist the two sentinel-appended outputs, merge them into the unified report shown in the reference template, and respect the same `check-run-gate` invocation that watches `refactor-summary.md` plus deep-run artifacts (`plugins/cwf/skills/refactor/references/deep-review-flow.md:69-97`, `plugins/cwf/scripts/check-run-gate-artifacts.sh:111-203`).

### Docs review (`cwf:refactor --docs`)
- Bootstrap the docs contract, run the deterministic tool pass (markdownlint + `plugins/cwf/skills/refactor/scripts/check-links.sh` + `plugins/cwf/skills/refactor/scripts/doc-graph.mjs`), verify docs criteria provenance, and iterate on entry-doc/project-context/README consistency before synthesizing the narrative (`plugins/cwf/skills/refactor/SKILL.md:283-294`, `plugins/cwf/skills/refactor/scripts/check-links.sh:4-107`, `plugins/cwf/skills/refactor/scripts/doc-graph.mjs:1-548`).
- Exercise `plugins/cwf/skills/refactor/scripts/check-docs-contract-runtime.sh` as the regression gate for Bootstrap/Force/Fallback outcomes before relying on the docs contract content (`plugins/cwf/skills/refactor/scripts/check-docs-contract-runtime.sh:4-77`).

### SoT and repository-agnostic checks
- Treat `README.ko.md` as the user-facing SoT and use `plugins/cwf/scripts/check-readme-structure.sh --strict` to keep the English/Korean heading tree paired before calling the others (`README.md:1-5`, `plugins/cwf/contracts/claims.json:5-104`, `plugins/cwf/scripts/check-readme-structure.sh:4-161`).
- Respect the repository-agnostic requirement documented in `docs/project-context.md` (skills must detect host structure and degrade gracefully) and enforce the complementary claim `repo_agnostic_execution` that executes the contract-driven portability gates listed in `plugins/cwf/contracts/claims.json:27-71`.
- Run `plugins/cwf/scripts/check-portability-contract.sh` for the portable/authoring-context constraints and the host/authoring fixture smoke tests in `plugins/cwf/scripts/check-portability-fixtures.sh` so that the portable baseline remains the default and the authoring profile only layered when needed (`plugins/cwf/scripts/check-portability-contract.sh:4-174`, `plugins/cwf/scripts/check-portability-fixtures.sh:4-90`).

### Review (`/review`)
- Determine the review mode (`code`, `plan`, or `clarify`), resolve the target diff/plan/clarify artifact (upstream detection, staged diff, plan lookup), and build the six-slot prompts; each slot writes `{session_dir}/review-*-{mode}.md` with `<!-- AGENT_COMPLETE -->` while external slots fall back to Task agents on CLI failures (`plugins/cwf/skills/review/SKILL.md:200-345`).
- After aggregating the six outputs, synthesize the verdict plus provenance and run `plugins/cwf/scripts/check-run-gate-artifacts.sh` with `--stage review-code` when in code mode so the run gate asserts session-log fields, review synthesis template, and the same 6 outputs (`plugins/cwf/skills/review/SKILL.md:374-419`, `plugins/cwf/scripts/check-run-gate-artifacts.sh:73-203`).

### Retro (`/retro` deep path)
- Update live state (`plugins/cwf/scripts/cwf-live-state.sh set`), determine the session directory, sync Codex logs, and capture evidence via `plugins/cwf/scripts/retro-collect-evidence.sh` before reading `plan.md`, `lessons.md`, AGENTS.md, project context, and cwf-state (`plugins/cwf/skills/retro/SKILL.md:24-90`, `plugins/cwf/scripts/cwf-live-state.sh:1-175`, `plugins/cwf/scripts/retro-collect-evidence.sh:1-267`).
- In deep mode, launch the CDM Analysis + Learning Resources batch (critical hard gate on `retro-cdm-analysis.md`) followed by the two expert agents, then draft Sections 1â€‘7 and run the run-gate script so the retro stage must prove the sentinel outputs before completion (`plugins/cwf/skills/retro/SKILL.md:91-204`, `plugins/cwf/scripts/check-run-gate-artifacts.sh:204-230`).

## Key Scripts and Files to Touch or Validate
- `plugins/cwf/skills/refactor/scripts/bootstrap-codebase-contract.sh:4-381` (contract creation, scope, shell-strict overrides) and `plugins/cwf/skills/refactor/scripts/codebase-quick-scan.sh:16-131` + its Python backend for scanning + candidate cleanup.
- `plugins/cwf/skills/refactor/scripts/select-codebase-experts.sh:4-376` (deterministic expert roster), `plugins/cwf/scripts/check-run-gate-artifacts.sh:73-235` (refactor/review/retro stage gate), and the deep-review references mentioned above for sentinel outputs.
- Documentation tooling: `plugins/cwf/skills/refactor/scripts/check-links.sh:4-107`, `plugins/cwf/skills/refactor/scripts/doc-graph.mjs:1-548`, and `plugins/cwf/skills/refactor/scripts/check-docs-contract-runtime.sh:4-77` cover the deterministic docs contract check.
- Repository-agnostic/SoT scripts: `plugins/cwf/scripts/check-portability-contract.sh:4-174`, `plugins/cwf/scripts/check-portability-fixtures.sh:4-90`, and `plugins/cwf/scripts/check-readme-structure.sh:4-161`.
- State/evidence helpers: `plugins/cwf/scripts/cwf-live-state.sh:1-175` (resolve/set live state) and `plugins/cwf/scripts/retro-collect-evidence.sh:1-267` (retro evidence snapshot).

## Risk Hotspots & Deterministic Gates
| Risk Hotspot | Gate / Script | Impact | Evidence |
|--------------|---------------|--------|----------|
| Missing `refactor-summary.md`/quick-scan or deep expert outputs (or their sentinel) trips the `refactor` gate that inspects summary headings, quick-scan JSON schema, expert roster, deep/tidy artifacts, and records `PERSISTENCE_GATE=HARD_FAIL` on failure. | `plugins/cwf/scripts/check-run-gate-artifacts.sh:111-203` | High | Gate body enumerates required files, JSON patterns, and sentinel checks for the refactor stage (`plugins/cwf/scripts/check-run-gate-artifacts.sh:111-198`). |
| The docs toolchain (`markdownlint`, `lychee` via `check-links.sh`, and `doc-graph.mjs`) must succeed before moving on; missing `lychee` or broken refs causes immediate non-zero exit because the scripts fail fast, blocking the docs flow. | `plugins/cwf/skills/refactor/scripts/check-links.sh:4-107`, `plugins/cwf/skills/refactor/scripts/doc-graph.mjs:1-548` | Medium | Each script reports failure on missing dependencies/refs and refuses to exit cleanly until the issues are fixed (`plugins/cwf/skills/refactor/scripts/check-links.sh:60-107`, `plugins/cwf/skills/refactor/scripts/doc-graph.mjs:456-548`). |
| Shell strict mode is enforced via the contract `shell_strict_mode.require_contract_and_pragma`, so any modified shell helper still needs the contract allowance and `cwf: shell-strict-mode relax` pragma or the scan flags it as a violation during the quick scan. | `plugins/cwf/skills/refactor/scripts/bootstrap-codebase-contract.sh:189-245` | High | The contract lists the strict-mode check and file-specific overrides, making contract/pragma metadata mandatory before the quick scan accepts the file (`plugins/cwf/skills/refactor/scripts/bootstrap-codebase-contract.sh:189-245`). |
| SoT/repo-agnostic claims are enforced through the unified gate runner plus portability fixtures; if `check-portability-contract.sh` or `check-portability-fixtures.sh` fail, the `repo_agnostic_execution` claim cannot be satisfied. | `plugins/cwf/scripts/check-portability-contract.sh:4-174`, `plugins/cwf/scripts/check-portability-fixtures.sh:4-90` | High | Both scripts exit non-zero on missing contract paths or failing pre-push behaviors, so the portable baseline remains the gatekeeper (`plugins/cwf/scripts/check-portability-contract.sh:4-174`, `plugins/cwf/scripts/check-portability-fixtures.sh:34-90`). |
| The `/retro --deep` flow treats `retro-cdm-analysis.md` as a hard gate, while expert files are tracked as non-critical soft gates; missing or sentinel-less files block the retro stage because the gate never transitions out of deep mode. | `plugins/cwf/scripts/check-run-gate-artifacts.sh:204-230` | Medium | The retro section of the gate explicitly checks for the `- Mode:` line and the CDM file before allowing completion (`plugins/cwf/scripts/check-run-gate-artifacts.sh:205-230`). |

## Impact Levels
- **High**: Stage/gate failures (refactor summary, SoT contracts, shell strict contract, review/retro critical outputs) halt the run and drive `PERSISTENCE_GATE=HARD_FAIL`, so missing artifacts or tooling violations must be resolved before progressing.
- **Medium**: Tool dependencies (link checker, retro expert files) require manual setup or retries but do not block other stages unless repeated failures accumulate; successful reruns clear the gate because `check-run-gate-artifacts.sh` records soft warnings only when non-critical files are missing (`plugins/cwf/scripts/check-run-gate-artifacts.sh:43-230`, `plugins/cwf/skills/refactor/scripts/check-links.sh:60-107`).
- **Low**: Single-source-of-truth alignment between README.md and README.ko.md is fast to re-run via `check-readme-structure.sh` and only fails when heading counts diverge, so it is not a blocking gate unless a mismatch persists (`plugins/cwf/scripts/check-readme-structure.sh:4-161`).

<!-- AGENT_COMPLETE -->
