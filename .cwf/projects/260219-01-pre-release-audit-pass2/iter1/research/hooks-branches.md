## Hooks 런타임 매트릭스

`hooks.json[은 SessionStart/PreToolUse/PostToolUse 등 이벤트별로 실행 스크립트를 나열하고, 모든 스크립트는 ](은 SessionStart/PreToolUse/PostToolUse 등 이벤트별로 실행 스크립트를 나열하고, 모든 스크립트는 )cwf-hook-gate`를 통해 `HOOK_{GROUP}_ENABLED` 플래그(기본 `true`)를 [~/.claude/cwf-hooks-enabled.sh](~/.claude/cwf-hooks-enabled.sh)에서 읽으므로 사용자가 `false`로 설정하지 않는 한 그룹이 작동한다는 점을 보장한다.([plugins/cwf/hooks/hooks.json:2](plugins/cwf/hooks/hooks.json:2) [plugins/cwf/hooks/scripts/cwf-hook-gate.sh:10](plugins/cwf/hooks/scripts/cwf-hook-gate.sh:10))
- `attention`: `Notification` `idle_prompt`과 `AskUserQuestion` 전후 훅이 `attention.sh`로 슬랙 대기 메시지를 보내고 `start-timer.sh[/](/)cancel-timer.sh`가 타이머를 만들었다가 응답 시 정리하며 `track-user-input.sh`이 첫 프롬프트 쓰레드를 만들고 마지막 사용자 타임스탬프를 기록하고 `heartbeat.sh`이 쓰레드 존재와 idle 임계를 확인한 뒤만 상태를 보낸다. `track-user-input.sh --guard-only`는 `compact_recovery` 블록으로 worktree 바인딩을 검사해 mismatch이면 block 응답을 리턴하고 `HOOK_ATTENTION_ENABLED`이 `false`면 `cwf-hook-gate`가 실행을 끝내며 `CWF_ATTENTION_DELAY[/](/)CWF_ATTENTION_HEARTBEAT_*`으로 타이머·idle 경계를 조정할 수 있다; `attention.sh`은 `parse-transcript.sh` 포맷 변경에 민감하다고 경고하므로 관련 스크립트를 동기화해야 한다.([plugins/cwf/hooks/hooks.json:45](plugins/cwf/hooks/hooks.json:45) [plugins/cwf/hooks/hooks.json:57](plugins/cwf/hooks/hooks.json:57) [plugins/cwf/hooks/hooks.json:105](plugins/cwf/hooks/hooks.json:105) [plugins/cwf/hooks/scripts/attention.sh:3](plugins/cwf/hooks/scripts/attention.sh:3) [plugins/cwf/hooks/scripts/attention.sh:11](plugins/cwf/hooks/scripts/attention.sh:11) [plugins/cwf/hooks/scripts/start-timer.sh:3](plugins/cwf/hooks/scripts/start-timer.sh:3) [plugins/cwf/hooks/scripts/start-timer.sh:35](plugins/cwf/hooks/scripts/start-timer.sh:35) [plugins/cwf/hooks/scripts/cancel-timer.sh:3](plugins/cwf/hooks/scripts/cancel-timer.sh:3) [plugins/cwf/hooks/scripts/track-user-input.sh:1](plugins/cwf/hooks/scripts/track-user-input.sh:1) [plugins/cwf/hooks/scripts/track-user-input.sh:109](plugins/cwf/hooks/scripts/track-user-input.sh:109) [plugins/cwf/hooks/scripts/heartbeat.sh:1](plugins/cwf/hooks/scripts/heartbeat.sh:1) [plugins/cwf/hooks/scripts/cwf-hook-gate.sh:10](plugins/cwf/hooks/scripts/cwf-hook-gate.sh:10))
- `log[: Stop/SessionEnd 이벤트에서 ](: Stop/SessionEnd 이벤트에서 )log-turn.sh`가 비동기로 대화를 `.claude` 세션 로그로 쓰고, `CWF_SESSION_LOG_ENABLED`가 false일 때는 건너뛰고 `HOOK_LOG_ENABLED`가 false면 gate가 실행 자체를 막으며 `CWF_SESSION_LOG_AUTO_COMMIT[이 true/SessionEnd이면 수집된 로그를 ](이 true/SessionEnd이면 수집된 로그를 )git add`+`git commit`으로 자동화한다.([plugins/cwf/hooks/hooks.json:133](plugins/cwf/hooks/hooks.json:133) [plugins/cwf/hooks/hooks.json:145](plugins/cwf/hooks/hooks.json:145) [plugins/cwf/hooks/scripts/log-turn.sh:52](plugins/cwf/hooks/scripts/log-turn.sh:52) [plugins/cwf/hooks/scripts/log-turn.sh:60](plugins/cwf/hooks/scripts/log-turn.sh:60) [plugins/cwf/hooks/scripts/log-turn.sh:194](plugins/cwf/hooks/scripts/log-turn.sh:194))
- `read`: PreToolUse Read에서는 `read-guard.sh`가 `CWF_READ_WARN_LINES[/](/)CWF_READ_DENY_LINES[ 선을 기준으로 offset/limit이 이미 있으면 바로 허용, 작은 파일은 조용히 통과, 중간 파일은 ]( 선을 기준으로 offset/limit이 이미 있으면 바로 허용, 작은 파일은 조용히 통과, 중간 파일은 )hookSpecificOutput.additionalContext`로 안내한 뒤 허용, 큰 파일(기본 2000줄 초과)은 `permissionDecision: deny[를 반환해 offset/limit 혹은 Grep/Explore를 유도한다.(](를 반환해 offset/limit 혹은 Grep/Explore를 유도한다.()plugins/cwf/hooks/hooks.json:77` [plugins/cwf/hooks/scripts/read-guard.sh:1](plugins/cwf/hooks/scripts/read-guard.sh:1) [plugins/cwf/hooks/scripts/read-guard.sh:25](plugins/cwf/hooks/scripts/read-guard.sh:25) [plugins/cwf/hooks/scripts/read-guard.sh:37](plugins/cwf/hooks/scripts/read-guard.sh:37) [plugins/cwf/hooks/scripts/read-guard.sh:57](plugins/cwf/hooks/scripts/read-guard.sh:57))
- `lint_markdown[: Write/Edit 후 ](: Write/Edit 후 )check-markdown.sh`이 `.md` 파일을 `markdownlint-cli2`로 검증하고, 도구가 없다면 block하며 실패 출력(최대 20줄)을 `reason`으로 반환하고, 프로젝트 또는 플러그인 설정을 적용한 다음 lint하며, 이어서 `check-links-local.sh`이 `lychee`와 `check-links.sh`를 찾지 못하거나 링크 깨짐을 감지하면 `Broken links detected` 메시지로 block한다.([plugins/cwf/hooks/hooks.json:116](plugins/cwf/hooks/hooks.json:116) [plugins/cwf/hooks/scripts/check-markdown.sh:1](plugins/cwf/hooks/scripts/check-markdown.sh:1) [plugins/cwf/hooks/scripts/check-markdown.sh:157](plugins/cwf/hooks/scripts/check-markdown.sh:157) [plugins/cwf/hooks/scripts/check-markdown.sh:172](plugins/cwf/hooks/scripts/check-markdown.sh:172) [plugins/cwf/hooks/scripts/check-markdown.sh:186](plugins/cwf/hooks/scripts/check-markdown.sh:186) [plugins/cwf/hooks/scripts/check-links-local.sh:1](plugins/cwf/hooks/scripts/check-links-local.sh:1) [plugins/cwf/hooks/scripts/check-links-local.sh:188](plugins/cwf/hooks/scripts/check-links-local.sh:188) [plugins/cwf/hooks/scripts/check-links-local.sh:220](plugins/cwf/hooks/scripts/check-links-local.sh:220) [plugins/cwf/hooks/scripts/check-links-local.sh:233](plugins/cwf/hooks/scripts/check-links-local.sh:233))
- `lint_shell[: 같은 Write/Edit 훅에서 ](: 같은 Write/Edit 훅에서 )check-shell.sh`이 `.sh` 파일을 `shellcheck -f gcc`로 검사하고, `shellcheck`가 없으면 quiet하게 통과하며 위반 시 truncated 출력을 reason으로 block한다.([plugins/cwf/hooks/hooks.json:116](plugins/cwf/hooks/hooks.json:116) [plugins/cwf/hooks/scripts/check-shell.sh:1](plugins/cwf/hooks/scripts/check-shell.sh:1) [plugins/cwf/hooks/scripts/check-shell.sh:156](plugins/cwf/hooks/scripts/check-shell.sh:156) [plugins/cwf/hooks/scripts/check-shell.sh:162](plugins/cwf/hooks/scripts/check-shell.sh:162))
- `deletion_safety`: PreToolUse Bash 커맨드에서 `rm|git rm|unlink` 인자를 추출해 `.cwf[/runtime 경로를 제외하고 grep으로 callers를 찾고, 와일드카드/검색 실패/복수 호출자가 있으면 block하며 ](/runtime 경로를 제외하고 grep으로 callers를 찾고, 와일드카드/검색 실패/복수 호출자가 있으면 block하며 )jq`가 없거나 parsing에 문제가 있으면 동일하게 block 사유를 보낸다.([plugins/cwf/hooks/hooks.json:57](plugins/cwf/hooks/hooks.json:57) [plugins/cwf/hooks/scripts/check-deletion-safety.sh:1](plugins/cwf/hooks/scripts/check-deletion-safety.sh:1) [plugins/cwf/hooks/scripts/check-deletion-safety.sh:25](plugins/cwf/hooks/scripts/check-deletion-safety.sh:25) [plugins/cwf/hooks/scripts/check-deletion-safety.sh:269](plugins/cwf/hooks/scripts/check-deletion-safety.sh:269))
- `workflow_gate`: UserPromptSubmit에서 `workflow-gate.sh`가 `jq`와 [scripts/cwf-live-state.sh](scripts/cwf-live-state.sh)로 live state를 읽고, `active_pipeline[/](/)phase[/](/)remaining_gates`를 상태 메시지로 붙여 전달하며, `review-code|refactor|retro|ship` 같은 run-closing gate가 남은 상태에서 `git push` 등 금지 명령이 들어오면 block하고, `jq[나 live-state 파일이 없으면 Protected action만 block/그 외 경고, session mismatch 시 ](나 live-state 파일이 없으면 Protected action만 block/그 외 경고, session mismatch 시 )bash plugins/cwf/scripts/cwf-live-state.sh set . active_pipeline=""`로 청소하라는 WARN을 출력한다.([plugins/cwf/hooks/hooks.json:14](plugins/cwf/hooks/hooks.json:14) [plugins/cwf/hooks/scripts/workflow-gate.sh:1](plugins/cwf/hooks/scripts/workflow-gate.sh:1) [plugins/cwf/hooks/scripts/workflow-gate.sh:183](plugins/cwf/hooks/scripts/workflow-gate.sh:183) [plugins/cwf/hooks/scripts/workflow-gate.sh:190](plugins/cwf/hooks/scripts/workflow-gate.sh:190) [plugins/cwf/hooks/scripts/workflow-gate.sh:221](plugins/cwf/hooks/scripts/workflow-gate.sh:221) [plugins/cwf/hooks/scripts/workflow-gate.sh:235](plugins/cwf/hooks/scripts/workflow-gate.sh:235) [plugins/cwf/hooks/scripts/workflow-gate.sh:255](plugins/cwf/hooks/scripts/workflow-gate.sh:255) [plugins/cwf/hooks/scripts/workflow-gate.sh:262](plugins/cwf/hooks/scripts/workflow-gate.sh:262))
- `websearch_redirect`: PreToolUse WebSearch 훅은 builtin WebSearch를 `deny`하고 `cwf:gather --search`(또는 `--search code`) 사용을 안내한다.([plugins/cwf/hooks/hooks.json:86](plugins/cwf/hooks/hooks.json:86) [plugins/cwf/hooks/scripts/redirect-websearch.sh:2](plugins/cwf/hooks/scripts/redirect-websearch.sh:2))
- `compact_recovery`: SessionStart compact 매처에서 `compact-context.sh`가 [.cwf/cwf-state.yaml](.cwf/cwf-state.yaml)의 live 섹션과 `cwf-session-worktree-map.tsv[를 읽어 session/branch/key files/decision journal을 ](를 읽어 session/branch/key files/decision journal을 )hookSpecificOutput.additionalContext`로 주입하며, live가 비어 있거나 state 파일이 없으면 아무 출력 없이 종료하고, `track-user-input.sh --guard-only`는 worktree mismatch를 block하며 일반 모드는 맵을 갱신해 다음 compact에서 예상 worktree를 보여준다.([plugins/cwf/hooks/hooks.json:3](plugins/cwf/hooks/hooks.json:3) [plugins/cwf/hooks/scripts/compact-context.sh:1](plugins/cwf/hooks/scripts/compact-context.sh:1) [plugins/cwf/hooks/scripts/compact-context.sh:9](plugins/cwf/hooks/scripts/compact-context.sh:9) [plugins/cwf/hooks/scripts/compact-context.sh:100](plugins/cwf/hooks/scripts/compact-context.sh:100) [plugins/cwf/hooks/scripts/compact-context.sh:194](plugins/cwf/hooks/scripts/compact-context.sh:194) [plugins/cwf/hooks/scripts/track-user-input.sh:1](plugins/cwf/hooks/scripts/track-user-input.sh:1) [plugins/cwf/hooks/scripts/track-user-input.sh:109](plugins/cwf/hooks/scripts/track-user-input.sh:109))

## 최초 사용자 흐름 영향

- `cwf:setup` 1단계는 기본적으로 9개 훅 그룹을 모두 활성화하고(`setup SKILL:65` `setup SKILL:67`), [bash {SKILL_DIR}/scripts/sync-hook-state.sh --enable ...](bash {SKILL_DIR}/scripts/sync-hook-state.sh --enable ...) 명령으로 [~/.claude/cwf-hooks-enabled.sh](~/.claude/cwf-hooks-enabled.sh)에 `HOOK_{GROUP}_ENABLED` export와 [.cwf/cwf-state.yaml](.cwf/cwf-state.yaml)의 `hooks:` 블록을 동시에 갱신하며(`setup SKILL:95` `setup SKILL:118` `sync-hook-state.sh:22` `sync-hook-state.sh:166`), `--check` 옵션은 두 상태가 일치하는지 검증하여 불일치가 있으면 잡아낸다(`setup SKILL:135` `sync-hook-state.sh:285`). 이후 `cwf-hook-gate`는 이 env를 읽어 그룹별 실행 여부를 결정한다([plugins/cwf/hooks/scripts/cwf-hook-gate.sh:10](plugins/cwf/hooks/scripts/cwf-hook-gate.sh:10)).

## 알려진 실패 모드 및 재현 명령

- `workflow_gate`는 `jq`나 [scripts/cwf-live-state.sh](scripts/cwf-live-state.sh)가 없으면 Protected action을 차단하고, run-closing gate가 남은 상태에서 `git push` 같은 명령을 들여보내면 block하며, stale pipeline이 발견되면 [bash plugins/cwf/scripts/cwf-live-state.sh set . active_pipeline=""](bash plugins/cwf/scripts/cwf-live-state.sh set . active_pipeline="")를 실행하거나 남은 gate를 완료해야 해제된다.([plugins/cwf/hooks/scripts/workflow-gate.sh:183](plugins/cwf/hooks/scripts/workflow-gate.sh:183) [plugins/cwf/hooks/scripts/workflow-gate.sh:190](plugins/cwf/hooks/scripts/workflow-gate.sh:190) [plugins/cwf/hooks/scripts/workflow-gate.sh:221](plugins/cwf/hooks/scripts/workflow-gate.sh:221) [plugins/cwf/hooks/scripts/workflow-gate.sh:235](plugins/cwf/hooks/scripts/workflow-gate.sh:235) [plugins/cwf/hooks/scripts/workflow-gate.sh:262](plugins/cwf/hooks/scripts/workflow-gate.sh:262))
- `deletion_safety`는 `rm[/](/)git rm[/](/)unlink` 명령 대상에 다른 파일에서 callers가 존재하면 block하고, 와일드카드·검색 실패·`jq` 부재도 block하며, `cwf:setup --tools`로 `jq` 같은 런타임 도구를 확보해야 재현 없이 통과한다.([plugins/cwf/hooks/scripts/check-deletion-safety.sh:1](plugins/cwf/hooks/scripts/check-deletion-safety.sh:1) [plugins/cwf/hooks/scripts/check-deletion-safety.sh:25](plugins/cwf/hooks/scripts/check-deletion-safety.sh:25) [plugins/cwf/hooks/scripts/check-deletion-safety.sh:269](plugins/cwf/hooks/scripts/check-deletion-safety.sh:269) [plugins/cwf/skills/setup/SKILL.md:12](plugins/cwf/skills/setup/SKILL.md:12))
- `lint_markdown[/](/)check-links-local`은 `markdownlint-cli2` 또는 `lychee[/](/)check-links.sh`가 없으면 `.md` 수정 시 즉시 block하며, 의존성 설치는 `cwf:setup --tools`로 처리해야 한다.([plugins/cwf/hooks/scripts/check-markdown.sh:157](plugins/cwf/hooks/scripts/check-markdown.sh:157) [plugins/cwf/hooks/scripts/check-links-local.sh:188](plugins/cwf/hooks/scripts/check-links-local.sh:188) [plugins/cwf/hooks/scripts/check-links-local.sh:220](plugins/cwf/hooks/scripts/check-links-local.sh:220) [plugins/cwf/skills/setup/SKILL.md:12](plugins/cwf/skills/setup/SKILL.md:12))
- `attention` 알림은 `parse-transcript.sh` 내부 구조에 의존하므로 Claude 업데이트로 transcript JSON이 바뀌면 알림이 중단되고, 이 경우 [hooks/scripts/parse-transcript.sh](hooks/scripts/parse-transcript.sh)를 현행화해야 한다.([plugins/cwf/hooks/scripts/attention.sh:11](plugins/cwf/hooks/scripts/attention.sh:11))
- `read-guard`는 기본 `CWF_READ_DENY_LINES[(2000줄)를 넘는 큰 파일에 대해 offset/limit 없이 ]((2000줄)를 넘는 큰 파일에 대해 offset/limit 없이 )permissionDecision: deny`를 반환하므로 `Read` 도구에 큰 파일을 넣으면 재현되고, `offset[/](/)limit`을 주거나 `CWF_READ_DENY_LINES`를 낮추면 우회할 수 있다.([plugins/cwf/hooks/scripts/read-guard.sh:37](plugins/cwf/hooks/scripts/read-guard.sh:37) [plugins/cwf/hooks/scripts/read-guard.sh:53](plugins/cwf/hooks/scripts/read-guard.sh:53) [plugins/cwf/hooks/scripts/read-guard.sh:57](plugins/cwf/hooks/scripts/read-guard.sh:57))

<!-- AGENT_COMPLETE -->
