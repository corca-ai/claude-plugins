## Correctness Review

### Concerns (blocking)
- **[C1] Run-level idempotency and resume semantics are not defined for side effects.** `Known Constraints` requires restart recovery from files, but `Implementation Steps > Step 2 — cwf run Core Orchestration` and `Step 4 — GitHub Integration in run` introduce side effects (issue creation, comments, commits) without a persisted run-state contract (run ID, stage/substep checkpoint, linked issue/PR IDs, posted comment IDs). A retry after partial failure can duplicate issues/comments or replay commits inconsistently. Severity: critical. References: `Known Constraints`, `Implementation Steps > Step 2`, `Implementation Steps > Step 3`, `Implementation Steps > Step 4`.
- **[C2] Branch/worktree transition policy is incomplete against stated deterministic safety goals.** The plan states deterministic branch/worktree safety, but `Implementation Steps > Step 2` only defines a high-level classifier and branch creation on base branch. It does not define deterministic outcomes for dirty index, untracked files, detached HEAD, branch divergence, existing stage branch collisions, or rerun from a partially advanced branch. This creates correctness risk of mixing unrelated diffs or advancing on the wrong base. Severity: critical. References: `Scope Summary > Known Constraints`, `Implementation Steps > Step 2`, `Implementation Steps > Step 3`.
- **[C3] Deterministic gate authority is under-specified at stage/substep level.** `Migration Principle` says deterministic scripts remain authoritative, and `Implementation Steps > Step 3` requires gate pass/fail before stage advance, but there is no explicit stage-to-gate mapping (exact script, required artifacts, strict/soft conditions, exit-code contract). `Step 6 — Remove cwf:run Skill and Slim Gates` further changes gates without defining equivalence criteria. This can yield inconsistent pass/fail decisions across environments. Severity: critical. References: `Architecture Direction > Migration Principle`, `Implementation Steps > Step 3`, `Implementation Steps > Step 6`, `Validation Plan`.
- **[C4] `cwf watch` behavioral core is deferred while direct automation is mandated.** The plan commits to immediate automatic GitHub handling, but the actual routing heuristic and cost guardrails are explicitly unresolved. Without deterministic classification rules and execution budget limits, event handling can be non-deterministic and can over-run resources under bursty issue/comment traffic. Severity: critical. References: `Scope Summary > Key Decisions`, `Evidence Gap List`, `Implementation Steps > Step 5 — cwf watch Automatic Handling`, `Deferred Actions`.
- **[C5] Failure propagation for execute/review/refactor timeouts is not fully specified.** `Step 0` introduces timeout fields, but `Step 3` does not define deterministic retry/cancel policy, partial-output handling, or compensation when a substep fails after mutating files. This leaves ambiguity about whether the runner should rollback, checkpoint-and-stop, or continue, which can violate stage correctness and commit-cap guarantees. Severity: critical. References: `Implementation Steps > Step 0 — Runner Contract and Safety Baseline`, `Implementation Steps > Step 3 — Six-Stage Loop with 4 Internal Substeps`, `Commit Strategy`.

### Suggestions (non-blocking)
- **[S1] Add a persisted run-state schema before Step 2 implementation.** Include `run_id`, current `stage/substep`, branch/base SHA, created issue/PR IDs, posted comment IDs, and last successful gate artifact hash to make reruns idempotent and resumable. References: `Known Constraints`, `Implementation Steps > Step 2`, `Implementation Steps > Step 4`.
- **[S2] Add an explicit branch/worktree transition table.** Define entry conditions, action, and exit code for each state (`clean base`, `clean feature`, `dirty`, `detached HEAD`, `diverged`, `existing run branch`) and include whether auto-fix is allowed. References: `Implementation Steps > Step 2`, `Implementation Steps > Step 3`.
- **[S3] Define a deterministic gate matrix per stage.** For each of the six stages, list exact gate scripts, required artifacts, failure messages, and whether retries are allowed; then use that matrix in `Validation Plan` tests. References: `Implementation Steps > Step 3`, `Implementation Steps > Step 6`, `Validation Plan`.
- **[S4] Move watch classifier/cost policies out of Deferred Actions into required Step 5 deliverables.** Include deterministic routing examples and hard limits (max retries, per-item concurrency, total runtime budget). References: `Evidence Gap List`, `Implementation Steps > Step 5`, `Deferred Actions`.
- **[S5] Expand validation with failure-mode and idempotency replay tests.** Add scenarios for crash between issue creation and stage loop, crash after comment post, substep timeout with dirty tree, and rerun-from-checkpoint behavior. References: `Validation Plan`, `Success Criteria > Behavioral (BDD)`.

### Behavioral Criteria Assessment
- [ ] **Given a prepared repository with setup readiness, when `cwf run "<prompt>"` is executed, then it creates an initial issue, writes `initial-req.md`, and executes six stages with stage progress comments.** Partial: high-level flow exists, but restart/idempotency and side-effect deduplication are unspecified (`Step 2`, `Step 4`).
- [ ] **Given an existing GitHub issue URL, when `cwf run "<issue-url>"` is executed, then it uses the issue as initial request source and executes the same six-stage flow without creating a duplicate issue.** Partial: duplicate-avoidance intent exists, but deterministic URL normalization/replay handling is not defined (`Step 2`, `Step 4`).
- [ ] **Given a stage is running, when execute/review/refactor substeps complete, then no more than 3 commits are created for that stage and each commit has non-empty diff.** Partial: commit cap is stated, but partial-failure and dirty-tree transitions are not specified enough to prove invariant preservation (`Step 3`, `Commit Strategy`).
- [ ] **Given stage gate checks fail, when gate step runs, then `cwf run` stops with deterministic failure output and does not advance to next stage.** Partial: stop intent exists, but gate matrix and failure-output contract are not explicit (`Step 3`, `Step 6`, `Validation Plan`).
- [ ] **Given `cwf watch` is enabled, when a new issue is opened or PR comment is created, then the workflow automatically routes the event to question-response or implementation flow and records actions in comments.** Fail until clarified: routing heuristic and cost/concurrency policy are deferred (`Evidence Gap List`, `Step 5`, `Deferred Actions`).
- [x] **Given run-skill migration is complete, when interactive users invoke other CWF skills directly, then those skills still operate normally without dependency on `cwf:run`.** Pass at plan level: this requirement is explicitly stated and represented in regression validation scope (`Scope Summary > Key Decisions`, `Validation Plan > Regression`).

### Provenance
- Reviewed file: `/home/hwidong/codes/claude-plugins/.cwf/projects/260224-02-cwf-cli-run-watch-orchestration/plan.md`
- Review mode: `cwf:review --mode plan`, Slot 3 (Correctness)
- Focus areas: logic correctness, branch/worktree state transitions, deterministic gate completeness, idempotency, failure modes, and performance-risk controls
- Referenced plan headings: `Scope Summary`, `Evidence Gap List`, `Architecture Direction`, `Implementation Steps (0-7)`, `Commit Strategy`, `Validation Plan`, `Success Criteria`, `Deferred Actions`
<!-- AGENT_COMPLETE -->
