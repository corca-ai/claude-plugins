# Plan: S19 Resolve Top Open Gaps (BL-001/002/003)

## Context
S18 identified 7 open gaps and marked BL-001/002/003 as highest impact. Decision anchors already fixed in DEC-001/002/005. The implementation surface is mostly CWF skill contracts plus runtime session-log scripts and operator-facing docs.

## Goal
Resolve BL-001 (holdout scenarios), BL-002 (umbrella-safe base selection), and BL-003 (runtime log source discovery) with deterministic, auditable behavior and migration-compatible runtime log handling.

## Scope
In scope:
- `cwf:review` contract updates for `--scenarios` and `--base`
- `cwf:retro`/`cwf:handoff` source-discovery contract updates for runtime logs
- Codex/Claude runtime log naming/path migration contract (`sessions/*.codex.md`, `sessions/*.claude.md`) and docs alignment
- Smoke checks + session artifact/state updates

Out of scope:
- GAP-003/004/006/014 implementation work
- New external tooling or architectural redesign

## Commit Strategy
- **Per change pattern**: 
  1) review contract hardening, 
  2) runtime-log migration + source-discovery contract, 
  3) docs/session artifacts.

## Steps
1. Implement BL-001/002 in `plugins/cwf/skills/review/SKILL.md`.
2. Implement BL-003 source-discovery updates in `plugins/cwf/skills/retro/SKILL.md` and `plugins/cwf/skills/handoff/SKILL.md`.
3. Apply DEC-005 runtime-log migration to scripts and aligned docs:
   - `scripts/codex/sync-session-logs.sh`
   - `scripts/codex/redact-session-logs.sh`
   - `plugins/cwf/hooks/scripts/log-turn.sh`
   - `plugins/cwf/skills/setup/SKILL.md`
   - `README.md`, `README.ko.md`
4. Run smoke validations and record evidence.
5. Write lessons/retro/next-session and register S19 in `cwf-state.yaml`, then run `scripts/check-session.sh --impl`.

## Success Criteria

### Behavioral (BDD)

```gherkin
Given /review --scenarios <valid-path>
When review runs
Then holdout checks are explicitly parsed and included in synthesis/provenance

Given /review --scenarios <missing-or-invalid-path>
When review runs
Then review fails explicitly instead of silently proceeding

Given /review --mode code without --base and branch upstream exists
When review target is resolved
Then upstream branch is used as the base and strategy is recorded

Given /review --mode code --base <branch>
When <branch> exists locally or on origin
Then <branch> is used deterministically and strategy is recorded as explicit override

Given runtime logs are generated by Claude and Codex wrappers
When artifacts are written/read for retro/handoff
Then canonical path `prompt-logs/sessions/` with suffixes is used and legacy `sessions-codex` remains readable during migration
```

### Qualitative
- Migration behavior is explicit and reversible.
- Skill contracts avoid silent fallback for critical validation inputs.
- Documentation and scripts stay consistent with each other.

## Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `plugins/cwf/skills/review/SKILL.md` | Edit | Implement executable `--scenarios` and deterministic `--base` contract |
| `plugins/cwf/skills/retro/SKILL.md` | Edit | Add canonical+legacy runtime log discovery contract |
| `plugins/cwf/skills/handoff/SKILL.md` | Edit | Add runtime log source discovery contract |
| `scripts/codex/sync-session-logs.sh` | Edit | Switch default output path/name to canonical `sessions/*.codex.md` |
| `scripts/codex/redact-session-logs.sh` | Edit | Align default directory with canonical path |
| `plugins/cwf/hooks/scripts/log-turn.sh` | Edit | Normalize Claude log filename suffix to `.claude.md` with legacy compatibility |
| `plugins/cwf/skills/setup/SKILL.md` | Edit | Update setup guidance for new Codex log location/name |
| `README.md` | Edit | User-facing Codex sync behavior update |
| `README.ko.md` | Edit | Korean user-facing Codex sync behavior update |
| `prompt-logs/260211-06-s19-resolve-top-open-gaps/*` | Create/Edit | Session pipeline artifacts |
| `cwf-state.yaml` | Edit | Register S19 and update live state |

## Don't Touch
- Existing historical `prompt-logs/*` artifacts (except creating the new S19 folder)
- GAP tracks outside BL-001/002/003 implementation scope

## Deferred Actions
- [ ] Trace and close GAP-003 Unknown class (DEC-003)
- [ ] Re-evaluate GAP-006/014 semantic-gate expansion beyond first-wave minimal set
