# cwf-state.yaml — Corca Workflow Framework project state
# Git-tracked, per-project. Read/written by cwf skills.

workflow:
  current_stage: harden
  started_at: "2026-02-08"
  stages:
    clarify: "S0"
    refactor: "S1–S2"
    scaffold: "S3–S4.6"
    review: "S5a–S5b"
    build: "S6a–S10"
    harden: "S11–S13"
    launch: "S14–S15"

# Default artifact expectations for sessions
session_defaults:
  artifacts:
    impl_complete: [plan.md, lessons.md, next-session.md]
    always: [plan.md, lessons.md, retro.md]
    milestone: [next-session.md]

# Session history (populated by cwf:retro and cwf:handoff)
sessions:
  - id: S0
    title: "Clarify + master plan"
    dir: prompt-logs/260208-03-cwf-v3-master-plan
    branch: main
    completed_at: "2026-02-08"
    summary: "Designed CWF v3 architecture with 15-session plan and single-plugin approach"
    artifacts: [master-plan.md, initial-plan-req.md, lessons.md, retro.md, next-session.md, session.md]

  - id: S1
    title: "Refactor critical issues"
    dir: prompt-logs/260208-04-refactor-critical
    branch: main
    completed_at: "2026-02-08"
    summary: "Fixed shebang/strict-mode/eval issues across 6 plugins, established JSON safety patterns"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md, session.md]

  - id: S2
    title: "Refactor session 2"
    dir: prompt-logs/260208-05-refactor-s2
    branch: main
    completed_at: "2026-02-08"
    summary: "Aligned env var naming to CLAUDE_CORCA_{PLUGIN}_{SETTING} across attention-hook"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md]

  - id: S3
    title: "Ship skill"
    dir: prompt-logs/260208-06-ship-skill
    branch: main
    completed_at: "2026-02-08"
    summary: "Built /ship local skill for GitHub workflow automation with templating system"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md, session.md]

  - id: S4
    title: "CWF scaffold"
    dir: prompt-logs/260208-04-cwf-scaffold
    branch: main
    completed_at: "2026-02-08"
    summary: "Scaffolded CWF plugin with gate mechanism and 13 source/stub files for hooks"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md, session.md]

  - id: S4.5
    title: "Ship skill improvements"
    dir: prompt-logs/260208-07-ship-improve
    branch: main
    completed_at: "2026-02-08"
    summary: "Enhanced /ship with Korean PR templates and 2x2 autonomous-merge decision matrix"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md, session.md]

  - id: S4.6
    title: "SW Factory discussion"
    dir: prompt-logs/260208-08-sw-factory-discussion
    branch: main
    completed_at: "2026-02-08"
    summary: "Applied SW Factory concepts: sernarative review, progressive disclosure, BDD criteria"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md, session.md]

  - id: S5a
    title: "CWF review — internal reviewers"
    dir: prompt-logs/260208-09-cwf-review-internal
    branch: main
    completed_at: "2026-02-08"
    summary: "Implemented /review skill with 2 internal parallel reviewers (Security, UX/DX)"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md]

  - id: S5b
    title: "CWF review — external reviewers"
    dir: prompt-logs/260208-03-s5b-external-reviewers
    branch: main
    completed_at: "2026-02-08"
    summary: "Expanded /review to 4 reviewers with external CLIs (Codex, Gemini) and provenance format"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md, session.md]

  - id: S6a
    title: "CWF infra hooks"
    dir: prompt-logs/260208-11-cwf-infra-hooks
    branch: main
    completed_at: "2026-02-08"
    summary: "Migrated 3 simple hooks (check-markdown, smart-read, log-turn) into CWF plugin"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md, session.md]

  - id: S6b
    title: "CWF hook migration"
    dir: prompt-logs/260208-12-s6b-cwf-migration
    branch: marketplace-v3
    completed_at: "2026-02-08"
    summary: "Migrated attention-hook (5 scripts + 2 utilities) into CWF, added check-shell.sh"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md]

  - id: S7-prep
    title: "Populate cwf-state.yaml + update handoff workflow"
    dir: prompt-logs/260208-13-s7-prep-cwf-state
    branch: marketplace-v3
    completed_at: "2026-02-08"
    summary: "Created machine-readable SSOT for session history, updated handoff template"
    artifacts: [plan.md, lessons.md, next-session.md]

  - id: S7
    title: "Migrate gather-context → cwf:gather"
    dir: prompt-logs/260208-15-s7-cwf-gather-migration
    branch: marketplace-v3
    completed_at: "2026-02-08"
    summary: "Copied gather-context skill into CWF as cwf:gather (8 scripts, 6 references, adapted SKILL.md), activated WebSearch redirect hook"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md, session.md]

  - id: S8
    title: "Migrate clarify → cwf:clarify"
    dir: prompt-logs/260208-16-s8-cwf-clarify-migration
    branch: marketplace-v3
    completed_at: "2026-02-08"
    summary: "Copied clarify skill into CWF as cwf:clarify (SKILL.md + 4 reference files), updated Path A to use cwf:gather search script"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md]

  - id: S9
    title: "Migrate plan-and-lessons → cwf:plan"
    dir: prompt-logs/260208-18-s9-cwf-plan
    branch: marketplace-v3
    completed_at: "2026-02-08"
    summary: "Created cwf:plan skill with 2-agent research + synthesizer pattern, synced plan-protocol.md Handoff Document section"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md]

  - id: S10
    title: "Build cwf:impl"
    dir: prompt-logs/260208-19-s10-cwf-impl
    branch: marketplace-v3
    completed_at: "2026-02-08"
    summary: "Created cwf:impl skill with 4-phase orchestration (Load Plan → Analyze & Decompose → Execute 3a/3b → Verify), adaptive team sizing, domain signal table"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md]

  - id: S11a
    title: "Migrate retro → cwf:retro"
    dir: prompt-logs/260208-20-s11a-cwf-retro
    branch: marketplace-v3
    completed_at: "2026-02-08"
    summary: "Migrated retro v2.0.2 into CWF as cwf:retro with 2-batch parallel sub-agent design for deep mode and eval>state>doc persist hierarchy"

  - id: S11b
    title: "Migrate refactor → cwf:refactor"
    dir: prompt-logs/260208-21-s11b-cwf-refactor
    branch: marketplace-v3
    completed_at: "2026-02-08"
    summary: "Migrated refactor v1.1.2 into CWF as cwf:refactor with 2-agent Deep Review and 3-agent Holistic parallel sub-agents"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md, session.md]

  - id: S12
    title: "Build cwf:setup + cwf:update + cwf:handoff"
    dir: prompt-logs/260208-22-s12-cwf-setup-update-handoff
    branch: marketplace-v3
    completed_at: "2026-02-08"
    summary: "Built cwf:setup (hook toggle + tool detection + index.md), cwf:update (version check), cwf:handoff (state-based handoff generation). Rewrote install.sh and update-all.sh for single cwf plugin."
    artifacts: [plan.md, lessons.md, retro.md, next-session.md]

  - id: S13
    title: "Holistic refactor review on entire CWF plugin"
    dir: prompt-logs/260208-23-s13-holistic-refactor
    branch: marketplace-v3
    completed_at: "2026-02-09"
    summary: "Cross-cutting quality gate on 9 skills + 14 hooks. Fixed broken refs (4 skills), missing Rules (gather), Language inconsistency. Created skill-conventions.md. Deep retro surfaced self-healing criteria need (Meadows/Woods). Hard wrap cleanup on 16 files."
    artifacts: [plan.md, lessons.md, retro.md, next-session.md]

  - id: S13.5-A
    title: "Self-healing provenance system"
    dir: prompt-logs/260209-24-s13.5-feedback-loop-infra
    branch: s13.5-a-provenance
    completed_at: "2026-02-09"
    summary: "Implemented provenance sidecar pattern: 6 .provenance.yaml files, provenance-check.sh script, refactor holistic integration (Phase 1b), handoff unresolved items propagation (Phase 4b), skill-conventions Provenance Rule. Deep retro with Meadows/Woods expert analysis."
    artifacts: [lessons.md, retro.md, next-session.md]

  - id: S13.5-B
    title: "Expert-in-the-loop + phase handoff"
    dir: prompt-logs/260209-25-s13.5-b-expert-loop
    branch: s13.5-b-expert-loop
    completed_at: "2026-02-09"
    summary: "Expert-in-the-loop for clarify (Phase 2.5), review (Slots 5-6), retro (roster maintenance). Shared expert-advisor-guide.md. Phase handoff --phase mode for handoff/impl/clarify skills. Deep retro with Klein RPD + Argyris double-loop."
    artifacts: [plan.md, lessons.md, retro.md, phase-handoff.md, next-session.md]

  - id: S13.5-B2
    title: "Concept distillation + README v3"
    dir: prompt-logs/260209-26-s13.5-b2-concept-distillation
    branch: marketplace-v3
    completed_at: "2026-02-09"
    summary: "Applied Jackson's Essence of Software to analyze CWF into 6 generic + 9 application concepts. Rewrote README.md around CWF single-plugin structure (336→273 lines). Identified 3 refactor integration points for concept-based analysis (unimplemented)."
    artifacts: [concept-distillation.md, lessons.md, retro.md, next-session.md, phase-handoff.md, session.md]

  - id: S13.5-B3
    title: "Concept refactor plan + hook observability fix + implementation"
    dir: prompt-logs/260209-27-s13.5-b3-concept-refactor
    branch: feat/concept-refactor-integration
    completed_at: "2026-02-09"
    summary: "Designed and implemented Form/Meaning/Function restructuring of holistic + deep review frameworks. Created concept-map.md (6 concepts + 9×6 sync map). Restructured holistic-criteria.md (PP/BI/MC → Form/Meaning/Function) and review-criteria.md (merged 4+5, added Concept Integrity). Fixed exit-plan-mode.sh observability. GitHub issue #17."
    artifacts: [plan.md, phase-handoff.md, lessons.md, retro.md, next-session.md, session.md]

  - id: post-B3
    title: "Post S13.5-B3 housekeeping"
    dir: prompt-logs/260209-28-post-b3-housekeeping
    branch: marketplace-v3
    completed_at: "2026-02-09"
    summary: "Provenance hook_count update, expert roster, master-plan B3 row, hook audit, next-prompt-dir script, plan mode protocol"
    artifacts: [plan.md, lessons.md, next-session.md]

  - id: S29
    title: "Plan mode removal + live state + compact recovery"
    dir: prompt-logs/260209-29-live-state-compact-recovery
    branch: marketplace-v3
    completed_at: "2026-02-09"
    summary: "Removed plan mode hooks, added cwf-state.yaml live section, built SessionStart(compact) hook with session log turn injection, deprecated plan-and-lessons plugin"
    artifacts: [plan.md, lessons.md, retro.md, next-session.md, session.md]

  - id: S32-impl
    title: "L1-L3+L9 implementation"
    dir: prompt-logs/260210-03-docs-overhaul-impl
    branch: marketplace-v3
    completed_at: "2026-02-10"
    summary: "Implemented branch gate (impl Phase 0.5), clarify completion gate (Phase 1.0), sub-agent file persistence with context recovery protocol (5 skills), log-turn.sh fix, review error observability. Extracted shared context-recovery-protocol.md. Full pipeline: clarify→plan→review→impl(4 agents)→review(6 reviewers)→fix→commit. Deep retro with Brooks + Ousterhout."
    artifacts: [plan.md, lessons.md, retro.md, next-session.md, session.md]

  - id: S33
    title: "CDM improvements + auto-chaining"
    dir: prompt-logs/260210-04-s33-cdm-auto-chain
    branch: marketplace-v3
    completed_at: "2026-02-10"
    summary: "4 CDM fixes (plan cross-cutting gate, impl commit strategy branching, decision journal + phase-aware compact recovery, review fail-fast for CAPACITY errors) + cwf:run auto-chaining skill + impl gate extraction to shared reference. 6 commits, 5/5 BDD pass."
    artifacts: [plan.md, lessons.md, retro.md, next-session.md]

  - id: S14
    title: "Integration test + agent-browser plan"
    dir: prompt-logs/260211-01-s14-integration-test
    branch: marketplace-v3
    completed_at: "2026-02-11"
    summary: "Integration test: 5/5 CDM items verified, 7/7 run logic checks, 6/6 fail-fast checks, 28/28 cross-refs clean. compact-context.sh 2 bugs fixed (decisions leak, quote stripping). v3-migration-decisions.md written. Web research replay exposed WebFetch 9% success rate → agent-browser integration planned."
    artifacts: [plan.md, lessons.md, next-session.md, agent-browser-plan.md]

# External tool availability (detected by cwf:setup)
tools:
  codex: available
  gemini: available
  agent_browser: available
  tavily: unknown
  exa: unknown

# Hook group toggle state (mirrors ~/.claude/cwf-hooks-enabled.sh)
# Default: all enabled — hooks work without cwf:setup
hooks:
  attention: true
  log: true
  read: true
  lint_markdown: true
  lint_shell: true
  websearch_redirect: true
  compact_recovery: true

# Live session state — updated by CWF skills at phase transitions,
# read by SessionStart(compact) hook for context recovery after auto-compact.
# check-session.sh --live validates required fields are populated.
live:
  session_id: "S14"
  dir: "prompt-logs/260211-01-s14-integration-test"
  branch: "marketplace-v3"
  phase: "done"
  task: "Integration test (E2E, smoke, compact recovery, fail-fast), v3-migration-decisions.md, final cleanup"
  key_files:
    - plugins/cwf/skills/run/SKILL.md
    - plugins/cwf/skills/clarify/SKILL.md
    - plugins/cwf/skills/plan/SKILL.md
    - plugins/cwf/skills/impl/SKILL.md
    - plugins/cwf/skills/review/SKILL.md
    - plugins/cwf/hooks/scripts/compact-context.sh
    - cwf-state.yaml
  decisions:
    - "Merge to main deferred — user has additional pre-merge work"
  decision_journal: []
  clarify_completed_at: ""
  clarify_result_file: ""

# Expert roster for domain expert sub-agents (used by clarify, review, retro)
# Semi-automatic evolution: usage_count auto-incremented, new experts user-approved
expert_roster:
  - name: "Donella Meadows"
    domain: "systems thinking, feedback loops, leverage points"
    source: "Thinking in Systems (2008)"
    rationale: "Applied to provenance system design — feedback loops for self-healing"
    introduced: "S13.5-A"
    usage_count: 1
  - name: "David Woods"
    domain: "resilience engineering, graceful extensibility"
    source: "The Theory of Graceful Extensibility (2018)"
    rationale: "Applied to agent boundary awareness and system resilience"
    introduced: "S13.5-A"
    usage_count: 1
  - name: "David Parnas"
    domain: "information hiding, modular decomposition criteria"
    source: "On the Criteria To Be Used in Decomposing Systems into Modules (CACM, 1972)"
    rationale: "Applied to concept vs principle distinction and directory structure classification"
    introduced: "S13.5-B2"
    usage_count: 1
  - name: "Gary Klein"
    domain: "naturalistic decision-making, recognition-primed decision model"
    source: "Sources of Power: How People Make Decisions (MIT Press, 1998)"
    rationale: "Applied to agreement bias analysis and mental simulation protocols"
    introduced: "S13.5-B2"
    usage_count: 1
  - name: "James Reason"
    domain: "organizational accidents, Swiss cheese model, defense-in-depth"
    source: "Managing the Risks of Organizational Accidents (Ashgate, 1997)"
    rationale: "Applied to hook chain defense layer analysis"
    introduced: "S13.5-B3"
    usage_count: 1
  - name: "Sidney Dekker"
    domain: "drift into failure, local rationality, just culture"
    source: "Drift into Failure (Ashgate, 2011)"
    rationale: "Applied to agent behavioral drift analysis"
    introduced: "S13.5-B3"
    usage_count: 1
  - name: "Frederick P. Brooks Jr."
    domain: "conceptual integrity, communication overhead, plan-to-throw-one-away, essential vs accidental complexity"
    source: "The Mythical Man-Month (1975/1995), No Silver Bullet (1986), The Design of Design (2010)"
    rationale: "Applied to parallel agent conceptual integrity failure, compact recovery as first system, plan over-engineering (second-system effect)"
    introduced: "S32"
    usage_count: 1
  - name: "John Ousterhout"
    domain: "deep vs shallow modules, information leakage, strategic vs tactical programming, interface bloat"
    source: "A Philosophy of Software Design (2018/2021), Always Measure One Level Deeper (CACM, 2018)"
    rationale: "Applied to context recovery protocol depth analysis, SKILL.md interface bloat from tactical accumulation, concept-level vs file-level plan decomposition"
    introduced: "S32"
    usage_count: 1
  - name: "W. Edwards Deming"
    domain: "systems thinking, common cause vs special cause variation, PDCA cycle, build quality into process"
    source: "Out of the Crisis (MIT Press, 1986), Point 3: cease dependence on inspection"
    rationale: "Applied to convention-vs-structure enforcement gap, commit strategy recurrence as common cause variation, check-session.sh as inspection-to-process conversion"
    introduced: "S33"
    usage_count: 1
  - name: "Chris Argyris"
    domain: "espoused theory vs theory-in-use, single-loop vs double-loop learning, defensive routines"
    source: "Organizational Learning: A Theory of Action Perspective (Argyris & Schön, 1978), Teaching Smart People How to Learn (HBR, 1991)"
    rationale: "Applied to teaching-practicing gap analysis, SKILL.md recording vs current behavior gap as espoused/theory-in-use divergence, eval>state>doc as double-loop learning mechanism"
    introduced: "S33"
    usage_count: 1
