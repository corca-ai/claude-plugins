# Session: 590816ce
Model: claude-opus-4-6 | Branch: marketplace-v3
CWD: /home/hwidong/codes/claude-plugins
Started: 2026-02-08 15:15:15 KST | Claude Code v2.1.37

---
## Turn 1 [15:15:15 → 15:19:14] (239s) | Tokens: 4438↑ 3291↓

### User
Implement the following plan:

# S5b Plan: External CLI Reviewers (Codex + Gemini)

## Context

The `/review` skill (S5a) currently runs 2 internal reviewers (Security + UX/DX) via Task sub-agents. The master plan calls for 4 parallel reviewers: 2 internal + 2 external CLI (Codex + Gemini). Phase 4 in SKILL.md is a placeholder that needs full implementation. External CLIs provide diverse model perspectives beyond Claude, and graceful degradation ensures the review always completes even when CLIs are unavailable.

## Files to Modify

| File | Action | Purpose |
|------|--------|---------|
| `.claude/skills/review/SKILL.md` | Modify | Restructure phases 2-4, add external reviewer flow |
| `.claude/skills/review/references/external-review.md` | Create | External reviewer perspectives + CLI invocation templates |
| `.claude/skills/review/references/prompts.md` | Modify | Add `duration_ms` and `command` to provenance format |

**Do NOT touch:** Internal reviewer prompts (Security/UX/DX role text), verdict algorithm logic, Phase 1 (gather target).

## Phase Structure Change

Current:
```text
Phase 1 → Phase 2 (2 internal) → Phase 3 (synthesize 2) → Phase 4 (placeholder)
```

New:
```text
Phase 1 → Phase 2 (launch ALL 4) → Phase 3 (collect + fallback) → Phase 4 (synthesize ALL)
```

Rationale: All 4 reviewers should launch together for maximum parallelism. Single synthesis pass avoids fragmented results.

## External Reviewer Perspectives

| Reviewer | Tool | Perspective | Why |
|----------|------|-------------|-----|
| Security | claude-task | Vulnerabilities, auth, data exposure | (existing) |
| UX/DX | claude-task | API design, errors, developer experience | (existing) |
| Codex | codex CLI | Code correctness, logic errors, edge cases, performance | Complements Security's risk focus |
| Gemini | gemini CLI | Architecture, patterns, consistency, maintainability | Complements UX/DX's usability focus |

Maps to agent-patterns.md's 4-perspective model: Security/risk, Missed opportunities, Content integrity, Structural analysis.

## Implementation Steps

### Step 1: Create `references/external-review.md`

New file with:
- **Codex Reviewer (Correctness & Performance)**: Role + `--mode clarify/plan/code` checklists
- **Gemini Reviewer (Architecture & Patterns)**: Role + `--mode clarify/plan/code` checklists
- **CLI invocation templates** per mode:
  - Codex code: `codex review --base {branch} -c model_reasoning_effort="xhigh" - < prompt.md`
  - Codex plan/clarify: `codex exec --sandbox read-only -c model_reasoning_effort="high" -o output.md - < prompt.md`
  - Gemini all modes: `npx @google/gemini-cli --approval-mode plan -o text -p "$(cat prompt.md)"`
- **Fallback prompt template**: "You are substituting for {tool} which was unavailable. Apply the {perspective}."
- **Output format**: Same as internal reviewers (Concerns/Suggestions/Criteria/Provenance) for uniform synthesis

### Step 2: Update `references/prompts.md` provenance format

Add `duration_ms` and `command` fields to the reviewer output format template:

```text
### Provenance
source: REAL_EXECUTION
tool: claude-task
reviewer: {Security | UX/DX}
duration_ms: —
command: —
```

Minimal change — just expand the provenance block for consistency with external reviewers.

### Step 3: Rewrite SKILL.md Phase 2 → "Launch All Reviewers"

Replace current Phase 2 (lines 99-144) with:

**2.1 Prepare external prompts**
- Create temp dir: `mktemp -d /tmp/claude-review-XXXXXX`
- Read `references/external-review.md` for Codex/Gemini perspective prompts
- Write prompt files: `codex-prompt.md` and `gemini-prompt.md` to temp dir
  - Same prompt template as internal reviewers (role + mode checklist + review target + criteria + output format)

**2.2 Detect CLI availability**
- Single Bash call: `command -v codex && echo CODEX_OK; command -v npx && echo NPX_OK`
- Result determines whether each external slot gets Bash or Task-fallback

**2.3 Launch all 4 in ONE message**
- Slot 1: `Task(name="security-reviewer", ...)` — always Task
- Slot 2: `Task(name="uxdx-reviewer", ...)` — always Task
- Slot 3: If codex available → `Bash(timeout=300000, command="timeout 280 codex review ...")` / else → `Task(name="codex-fallback", ...)`
- Slot 4: If gemini available → `Bash(timeout=300000, command="timeout 280 npx @google/gemini-cli ...")` / else → `Task(name="gemini-fallback", ...)`

### Step 4: Rewrite SKILL.md Phase 3 → "Collect All Outputs"

**3.1 Read all results**
- Internal reviewers: read Task agent return values (as today)
- External Bash: read output files from temp dir

**3.2 Handle external failures**
- Exit code 0 + non-empty output → `source: REAL_EXECUTION`
- Exit code 124 (timeout) → `source: FAILED`, launch Task fallback
- Exit code 127 / "command not found" → `source: FAILED`, launch Task fallback
- Other non-zero (auth error, etc.) → `source: FAILED`, launch Task fallback
- If fallbacks needed, launch them in one message, then read results

**3.3 Assemble 4 review outputs** (mix of REAL_EXECUTION/FALLBACK)

### Step 5: Rewrite SKILL.md Phase 4 → "Synthesize"

Replace placeholder (lines 210-214) with full synthesis:
- Verdict logic: unchanged (reviewer-count-agnostic)
- Provenance table: expand to 4 rows with Source/Tool/Duration columns
- Confidence Note: add "External CLI fallbacks" and "Perspective differences between CLI and fallback" items
- Template handles variable reviewer count (2 internal always present, 0-2 external real/fallback)

### Step 6: Update Error Handling & Rules

Add to error table:

| Situation | Action |
|-----------|--------|
| Codex/Gemini CLI not found | Task agent fallback with same perspective. Mark `FALLBACK`. |
| External CLI timeout (280s) | Mark `FAILED`. Spawn Task agent fallback. |
| External CLI auth error | Mark `FAILED`. Spawn Task agent fallback. Note in Confidence Note. |
| External output malformed | Extract by pattern matching. Note in Confidence Note. |

Add Rule 7: **Graceful degradation** — external CLI failure never blocks the review. Fallback to Task agent with same perspective.

### Step 7: Test

| Scenario | How to test | Expected |
|----------|-------------|----------|
| Happy path | Both CLIs installed + authenticated | 4 REAL_EXECUTION |
| Codex missing | `command -v codex` fails | 3 REAL + 1 FALLBACK |
| Gemini not logged in | Auth error in stderr | 3 REAL + 1 FALLBACK |
| Both CLIs missing | Neither available | 2 REAL + 2 FALLBACK |
| Gemini first-run | Fresh `npx` download | Should complete within 280s |

Test order per handoff: Gemini error handling first (auth) → login → normal flow.

## Success Criteria

```gherkin
Given the /review skill is invoked with --mode code
When both Codex and Gemini CLIs are available
Then all 4 reviewers run in parallel (2 Task + 2 Bash)
And synthesis includes 4 reviewer outputs with REAL_EXECUTION provenance

Given the /review skill is invoked
When Codex CLI is not found (command -v fails)
Then a Task agent fallback launches with the Correctness perspective
And provenance shows source: FALLBACK, tool: claude-task-fallback

Given an external CLI times out (>280s)
When the review is collecting outputs
Then the output is marked source: FAILED
And a Task agent fallback is spawned with the same perspective

Given all 4 reviewer outputs are collected
When synthesis runs
Then the verdict algorithm applies to all 4 reviewers (stricter wins)
And the provenance table shows all 4 with correct source/tool metadata
```

## Deferred Actions

- [ ] Prior art search for external CLI review integration patterns (deferred: niche topic, existing agent-patterns.md is sufficient)


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /home/hwidong/.claude/projects/-home-hwidong-codes-claude-plugins/68512ef5-175e-4ff4-b699-3be1711000d4.jsonl

If this plan can be broken down into multiple independent tasks, consider using the TeamCreate tool to create a team and parallelize the work.

### Assistant (40 lines → truncated)
I'll start by reading the necessary files to understand the current state before implementing the plan.
Good, I've read all the source files. Now let me set up the prompt-logs directory and create the task list.
Now let me create the task list and start implementation. The steps are sequential since each builds on the previous, so I'll execute them in order.
**Step 1: Create `references/external-review.md`**
**Step 2: Update `prompts.md` provenance format**

...(30 lines truncated)...

- **Error table**: 4개 외부 CLI 에러 시나리오 추가
- **Rule 7**: Graceful degradation 원칙 추가
- 기존 Phase 1, 내부 리뷰어 프롬프트, verdict 알고리즘은 변경 없음

다음 단계로 `/retro` 실행 후 커밋 진행할까요?

### Tools
1. Read `/home/hwidong/codes/claude-plugins/docs/plugin-dev-cheatsheet.md`
2. Read `/home/hwidong/codes/claude-plugins/.claude/skills/review/SKILL.md`
3. Read `/home/hwidong/codes/claude-plugins/.claude/skills/review/references/prompts.md`
4. Bash `mkdir -p /home/hwidong/codes/claude-plugins/prompt-logs/260208-03-s5b-external-r`
5. Write `/home/hwidong/codes/claude-plugins/prompt-logs/260208-03-s5b-external-reviewers/plan.md`
6. Write `/home/hwidong/codes/claude-plugins/prompt-logs/260208-03-s5b-external-reviewers/lessons.md`
7. TaskCreate "Create references/external-review.md"
8. TaskCreate "Update prompts.md provenance format"
9. TaskCreate "Rewrite SKILL.md phases 2-4 and error handling"
10. TaskCreate "Verify completeness and update plan"
11. TaskUpdate #1 → in_progress
12. Write `/home/hwidong/codes/claude-plugins/.claude/skills/review/references/external-review.md`
13. TaskUpdate #1 → completed
14. TaskUpdate #2 → in_progress
15. Edit `/home/hwidong/codes/claude-plugins/.claude/skills/review/references/prompts.md`
16. TaskUpdate #2 → completed
17. TaskUpdate #3 → in_progress
18. Edit `/home/hwidong/codes/claude-plugins/.claude/skills/review/SKILL.md`
19. Edit `/home/hwidong/codes/claude-plugins/.claude/skills/review/SKILL.md`
20. Edit `/home/hwidong/codes/claude-plugins/.claude/skills/review/SKILL.md`
21. Edit `/home/hwidong/codes/claude-plugins/.claude/skills/review/SKILL.md`
22. Edit `/home/hwidong/codes/claude-plugins/.claude/skills/review/SKILL.md`
23. Edit `/home/hwidong/codes/claude-plugins/.claude/skills/review/SKILL.md`
24. Edit `/home/hwidong/codes/claude-plugins/.claude/skills/review/SKILL.md`
25. TaskUpdate #3 → completed
26. TaskUpdate #4 → in_progress
27. Read `/home/hwidong/codes/claude-plugins/.claude/skills/review/SKILL.md`
28. Read `/home/hwidong/codes/claude-plugins/.claude/skills/review/references/prompts.md`
29. Read `/home/hwidong/codes/claude-plugins/.claude/skills/review/references/external-review.md`
30. Bash `wc -l /home/hwidong/codes/claude-plugins/.claude/skills/review/SKILL.md /home/hw`
31. Bash `git diff --stat`
32. Write `/home/hwidong/codes/claude-plugins/prompt-logs/260208-03-s5b-external-reviewers/plan.md`
33. Write `/home/hwidong/codes/claude-plugins/prompt-logs/260208-03-s5b-external-reviewers/lessons.md`
34. TaskUpdate #4 → completed

---
## Turn 2 [15:19:29 → 15:21:25] (116s) | Tokens: 236↑ 736↓

### User
yes!

### Assistant (21 lines → truncated)
Let me start by locating the output directory and reading existing artifacts.
Now let me check for project-context, CDM guide, and scan installed skills.
Good. Now I have enough context. This session is straightforward — plan was pre-designed, implementation was clean. Light mode is appropriate.

Let me also check for session log to link.

...(11 lines truncated)...

- `prompts.md` — Provenance에 `duration_ms`/`command` 필드 추가
- `SKILL.md` — 4-phase 구조로 재편 (2→4 리뷰어, graceful degradation, Rule 7)
- `prompt-logs/` — plan, lessons, retro, session symlink

**다음 테스트**: `/review` 실행 시 Codex/Gemini CLI 유무에 따라 4개 리뷰어가 병렬 실행되는지 확인. 현재 환경에서 `command -v codex`와 `command -v npx` 결과에 따라 REAL_EXECUTION 또는 FALLBACK이 결정됩니다.

### Tools
1. Skill `retro`
2. Read `/home/hwidong/codes/claude-plugins/prompt-logs/260208-03-s5b-external-reviewers/plan.md`
3. Read `/home/hwidong/codes/claude-plugins/prompt-logs/260208-03-s5b-external-reviewers/lessons.md`
4. Read `/home/hwidong/codes/claude-plugins/CLAUDE.md`
5. Read `/home/hwidong/codes/claude-plugins/docs/project-context.md`
6. Read `/home/hwidong/.claude/plugins/cache/corca-plugins/retro/2.0.2/skills/retro/references/cdm-guide.md`
7. Glob `~/.claude/plugins/*/skills/*/SKILL.md`
8. Glob `**/skills/*/SKILL.md`
9. Glob `.claude/skills/*/SKILL.md`
10. Bash `ls -la /home/hwidong/codes/claude-plugins/prompt-logs/sessions/260208-*.md 2>/de`
11. Bash `ls -la /home/hwidong/codes/claude-plugins/prompt-logs/sessions/ 2>/dev/null | gr`
12. Read `/home/hwidong/codes/claude-plugins/prompt-logs/sessions/260208-1353-2fa563b5.md`
13. Write `/home/hwidong/codes/claude-plugins/prompt-logs/260208-03-s5b-external-reviewers/retro.md`
14. Bash `ln -s "../sessions/260208-1353-2fa563b5.md" "/home/hwidong/codes/claude-plugins/`
15. Bash `git status -u`
16. Bash `git diff`
17. Bash `git log --oneline -5`
18. Bash `git add .claude/skills/review/SKILL.md .claude/skills/review/references/prompts.`
19. Bash `git push`
