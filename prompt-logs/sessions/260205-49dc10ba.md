# Session: 49dc10ba
Model: claude-opus-4-5-20251101 | Branch: main
CWD: /home/hwidong/codes/claude-plugins
Started: 2026-02-05 22:07:12 KST | Claude Code v2.1.31

---
## Turn 1 [22:07:12 → 22:13:02] (350s) | Tokens: 39418↑ 17512↓

### User
Implement the following plan:

# gather-context v2: Unified Information Acquisition

> Phase 1 of marketplace v2 architecture (analysis: prompt-logs/260205-06-refactor-holistic/analysis.md)

## Branch

`feat/marketplace-v2` (from main) — all v2 marketplace work in one branch

## Summary

Rewrite gather-context from URL-only content gatherer to **unified information acquisition layer**.
Absorb web-search plugin. Three modes: URL auto-detect, `--search`, `--local`.

## Success Criteria

```gherkin
Scenario: URL auto-detect (existing services)
  Given a Google/Slack/Notion URL
  When /gather-context <url>
  Then content is downloaded and saved to OUTPUT_DIR (same as v1)

Scenario: GitHub URL (new)
  Given a github.com PR/issue/repo URL
  When /gather-context <url>
  Then gh CLI extracts content as markdown, saved to OUTPUT_DIR

Scenario: Generic URL with Tavily
  Given a generic URL and TAVILY_API_KEY is set
  When /gather-context <url>
  Then extract.sh fetches content via Tavily API, saved to OUTPUT_DIR

Scenario: Generic URL without Tavily (fallback)
  Given a generic URL and TAVILY_API_KEY is NOT set
  When /gather-context <url>
  Then WebFetch fetches content, saved to OUTPUT_DIR

Scenario: Web search (Tavily)
  Given a general search query
  When /gather-context --search <query>
  Then query intelligence routes to search.sh (Tavily API), results displayed

Scenario: Code search (Exa)
  Given a code/technical query (explicit "code" prefix or auto-detected)
  When /gather-context --search code <query>
  Then code-search.sh calls Exa API with appropriate token allocation, results displayed

Scenario: Graceful degradation (missing API keys)
  Given TAVILY_API_KEY is not set
  When /gather-context --search <query>
  Then error message with setup instructions (link to app.tavily.com)
  Given EXA_API_KEY is not set
  When /gather-context --search code <query>
  Then error message with setup instructions (link to dashboard.exa.ai)

Scenario: Local codebase exploration
  Given a topic query
  When /gather-context --local <query>
  Then sub-agent explores codebase, structured summary saved to OUTPUT_DIR

Scenario: WebSearch hook
  Given gather-context v2 is installed
  When any tool tries to use built-in WebSearch
  Then hook denies and redirects to /gather-context --search

Scenario: No args / help
  When /gather-context (no args) or /gather-context help
  Then usage message is displayed

Scenario: Language adaptation
  Given user communicates in Korean
  When /gather-context produces any user-facing output
  Then output language matches user's language
```

## File Changes

### New files
| File | Description |
|------|-------------|
| `plugins/gather-context/hooks/hooks.json` | PreToolUse WebSearch redirect |
| `plugins/gather-context/hooks/scripts/redirect-websearch.sh` | Deny WebSearch, point to /gather-context |
| `plugins/gather-context/skills/gather-context/references/search-api-reference.md` | Tavily/Exa API docs (from web-search api-reference.md, expanded) |
| `plugins/gather-context/skills/gather-context/references/query-intelligence.md` | Search routing logic (temporal, topic, code detection) |
| `plugins/gather-context/skills/gather-context/scripts/search.sh` | Copy from web-search (Tavily search) |
| `plugins/gather-context/skills/gather-context/scripts/code-search.sh` | Copy from web-search (Exa code search) |
| `plugins/gather-context/skills/gather-context/scripts/extract.sh` | Copy from web-search (Tavily URL extract) |

### Modified files
| File | Change |
|------|--------|
| `plugins/gather-context/.claude-plugin/plugin.json` | version 1.1.1 → 2.0.0, update description |
| `plugins/gather-context/skills/gather-context/SKILL.md` | **Full rewrite** — unified 3-mode interface |
| `plugins/web-search/skills/web-search/SKILL.md` | Add deprecation notice at top |
| `plugins/web-search/.claude-plugin/plugin.json` | Add `"deprecated": true`, bump to 2.1.0 |
| `.claude-plugin/marketplace.json` | Update gather-context entry; mark web-search deprecated |
| `README.md` | Update gather-context section, add web-search deprecation |
| `README.ko.md` | Same in Korean |

### Unchanged files (keep as-is)
All existing scripts: g-export.sh, slack-api.mjs, slack-to-md.sh, notion-to-md.py, csv-to-toon.sh
All existing references: google-export.md, slack-export.md, notion-export.md, TOON.md

## Implementation Steps

### Step 1: Hook infrastructure
- Create `hooks/hooks.json` (PreToolUse matcher for WebSearch)
- Create `hooks/scripts/redirect-websearch.sh` (deny + redirect message to `/gather-context --search`)
- Source: adapt from `plugins/web-search/hooks/scripts/redirect-websearch.sh`

### Step 2: Copy search scripts from web-search
- Copy `search.sh`, `code-search.sh`, `extract.sh` to gather-context scripts/
- `chmod +x` all three
- Scripts are self-contained (own env loading, own JSON building) — no modifications needed

### Step 3: Create reference files
- `search-api-reference.md`: expand from `plugins/web-search/skills/web-search/references/api-reference.md`
  - Add: graceful degradation rules (missing API keys → fallback behavior)
  - Add: consolidated API key setup instructions
- `query-intelligence.md`: extract from `plugins/web-search/skills/web-search/SKILL.md`
  - Temporal intent detection table
  - Topic detection keywords
  - Code search token allocation
  - Routing decision tree

### Step 4: Rewrite SKILL.md (core work)

Target: ~300 lines (under 500 limit). Structure:

```
Frontmatter (name, description, allowed-tools: Bash, Glob, Grep, Read, Task, WebFetch)
Title + Language rule
Quick Reference (command table with examples)
Workflow (parse → execute → save → suggest)
URL Auto-Detect table (Google > Slack > Notion > GitHub > Generic)
  - Google handler (script call, ref link)
  - Slack handler (script call, thread_ts, ref link)
  - Notion handler (script call, ref link)
  - GitHub handler (gh CLI, prerequisite check, fallthrough)
  - Generic handler (Tavily extract → WebFetch fallback)
--search mode
  - Subcommands: --search <query> (Tavily), --search code <query> (Exa), --search --news/--deep
  - Query intelligence overview → ref link to query-intelligence.md
  - Script calls: search.sh (Tavily) / code-search.sh (Exa)
--local mode (sub-agent launch, prompt template, save to OUTPUT_DIR)
Configuration (env vars table, output dir, API keys)
Usage message (help block)
References (links to all 6 reference files)
```

Key design decisions:
- **GitHub handler**: Use `gh pr view`/`gh issue view`/`gh repo view` directly. Check `command -v gh` first, fallthrough to generic if unavailable.
- **Generic URL**: Try `extract.sh` first (Tavily), fallback to `WebFetch` if no API key or extraction fails.
- **--search routing (2 backends)**:
  - **Tavily** (`search.sh`): General web search, news (`--news`), deep search (`--deep`), finance auto-detect. Requires `TAVILY_API_KEY`.
  - **Exa** (`code-search.sh`): Code/technical search. Triggered by `code` prefix or auto-detected from programming context keywords. Token allocation: 3K (simple) → 15K (deep research). Requires `EXA_API_KEY`.
  - SKILL.md contains routing summary; detail in `query-intelligence.md`. Agent reads the reference when executing search.
- **--local**: Launch Task(subagent_type="general-purpose") to explore codebase. Sub-agent uses Glob/Grep/Read, returns structured markdown. Main agent saves to `{OUTPUT_DIR}/local-{sanitized-query}.md`. Purpose: persist exploration results so clarify v2 can reference them.
- **Supplementary research**: After URL gathering, use search scripts directly via Bash (not WebSearch tool).
- **No-args/help**: Print formatted usage block with examples.

### Step 5: Update plugin.json
- Version: 2.0.0
- Description: "Unified information acquisition: URL auto-detect (Google/Slack/Notion/GitHub/web), web search, and local codebase exploration"

### Step 6: Deprecate web-search
- Add deprecation notice to web-search SKILL.md (first line after frontmatter)
- Add `"deprecated": true` to web-search plugin.json, bump to 2.1.0
- Update marketplace.json (gather-context new desc/keywords; web-search deprecated)

### Step 7: Update README.md / README.ko.md
- gather-context section: new capabilities, examples
- web-search section: deprecation notice, migration path

## Risks

| Risk | Impact | Mitigation |
|------|--------|-----------|
| SKILL.md > 500 lines | High | Heavy extraction to references (query-intelligence.md, search-api-reference.md) |
| Dual-install hook conflict (web-search + gather-context) | Medium | Both deny WebSearch; first wins (harmless). Deprecation notice instructs uninstall. |
| `gh` CLI not installed | Medium | Check `command -v gh`, fallthrough to generic URL handler |
| deep-clarify sub-agent WebSearch blocked | Medium | Phase 2 problem (clarify v2). Current redirect message is informative enough. |
| API cost for Tavily extract vs free WebFetch | Low | WebFetch fallback when no TAVILY_API_KEY. No degradation for free users. |

## Verification Plan

1. **Hook**: `echo '{}' | plugins/gather-context/hooks/scripts/redirect-websearch.sh | jq .`
2. **Scripts**: Run each copied script with test inputs (requires API keys)
3. **Existing scripts**: Run g-export.sh, csv-to-toon.sh to verify no regression
4. **Integration**: `claude --plugin-dir ./plugins/gather-context --dangerously-skip-permissions --resume`
   - Test URL auto-detect (Google, GitHub, generic)
   - Test `--search` with various query types
   - Test `--local` with a topic
   - Test no-args help message
   - Verify WebSearch tool is blocked

## Deferred Actions

- [ ] Update deep-clarify's bestpractice-research-guide.md to use `/gather-context --search` (Phase 2: clarify v2)
- [ ] Remove web-search plugin entirely after deprecation period (Phase 6)
- [ ] prompt-logs directory setup (create at implementation start)


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /home/hwidong/.claude/projects/-home-hwidong-codes-claude-plugins/e1287c60-4881-474f-a1c5-528eb656678a.jsonl

### Assistant (54 lines → truncated)
I'll start by reading the necessary reference files to understand the current state of the codebase before implementing.
Now let me read the web-search hook, scripts, and references that I need to copy/adapt.
Now let me also read the READMEs to understand the current documentation.
Good, I have all the context needed. Let me now read the analysis file referenced in the plan for any additional detail.
Now let me create the task list and start implementing. I'll create all tasks then work through them.

...(44 lines truncated)...

- 복사된 스크립트: 원본과 동일 + 실행 권한 확인
- 모든 JSON 파일: 유효성 검증 통과
- 기존 스크립트(g-export.sh, csv-to-toon.sh 등): 미변경

커밋할까요?

### Tools
1. TaskCreate "Read prerequisite docs and existing files"
2. TaskUpdate #1 → in_progress
3. Read `/home/hwidong/codes/claude-plugins/docs/plugin-dev-cheatsheet.md`
4. Read `/home/hwidong/codes/claude-plugins/plugins/gather-context/.claude-plugin/plugin.json`
5. Read `/home/hwidong/codes/claude-plugins/plugins/gather-context/skills/gather-context/SKILL.md`
6. Read `/home/hwidong/codes/claude-plugins/.claude-plugin/marketplace.json`
7. Read `/home/hwidong/codes/claude-plugins/plugins/web-search/.claude-plugin/plugin.json`
8. Read `/home/hwidong/codes/claude-plugins/plugins/web-search/skills/web-search/SKILL.md`
9. Read `/home/hwidong/codes/claude-plugins/plugins/web-search/hooks/hooks.json`
10. Read `/home/hwidong/codes/claude-plugins/plugins/web-search/hooks/scripts/redirect-websearch.sh`
11. Read `/home/hwidong/codes/claude-plugins/plugins/web-search/skills/web-search/references/api-reference.md`
12. Read `/home/hwidong/codes/claude-plugins/plugins/web-search/skills/web-search/scripts/search.sh`
13. Read `/home/hwidong/codes/claude-plugins/plugins/web-search/skills/web-search/scripts/code-search.sh`
14. Read `/home/hwidong/codes/claude-plugins/plugins/web-search/skills/web-search/scripts/extract.sh`
15. Read `/home/hwidong/codes/claude-plugins/README.md`
16. Read `/home/hwidong/codes/claude-plugins/README.ko.md`
17. TaskUpdate #1 → completed
18. TaskCreate "Create feature branch feat/marketplace-v2"
19. TaskCreate "Step 1: Hook infrastructure (hooks.json + redirect script)"
20. TaskCreate "Step 2: Copy search scripts from web-search"
21. TaskCreate "Step 3: Create reference files"
22. TaskCreate "Step 4: Rewrite SKILL.md (core work)"
23. TaskCreate "Step 5: Update plugin.json to v2.0.0"
24. TaskCreate "Step 6: Deprecate web-search plugin"
25. TaskCreate "Step 7: Update README.md and README.ko.md"
26. TaskCreate "Verify hook script and test copied scripts"
27. TaskUpdate #2 → in_progress
28. Bash `git checkout -b feat/marketplace-v2`
29. TaskUpdate #2 → completed
30. TaskUpdate #3 → in_progress
31. Bash `mkdir -p /home/hwidong/codes/claude-plugins/plugins/gather-context/hooks/scripts`
32. Write `/home/hwidong/codes/claude-plugins/plugins/gather-context/hooks/hooks.json`
33. Write `/home/hwidong/codes/claude-plugins/plugins/gather-context/hooks/scripts/redirect-websearch.sh`
34. Bash `chmod +x /home/hwidong/codes/claude-plugins/plugins/gather-context/hooks/scripts`
35. TaskUpdate #3 → completed
36. TaskUpdate #4 → in_progress
37. Bash `cp /home/hwidong/codes/claude-plugins/plugins/web-search/skills/web-search/scrip`
38. TaskUpdate #4 → completed
39. TaskUpdate #5 → in_progress
40. Write `/home/hwidong/codes/claude-plugins/plugins/gather-context/skills/gather-context/references/search-api-reference.md`
41. Write `/home/hwidong/codes/claude-plugins/plugins/gather-context/skills/gather-context/references/query-intelligence.md`
42. TaskUpdate #5 → completed
43. TaskUpdate #6 → in_progress
44. Write `/home/hwidong/codes/claude-plugins/plugins/gather-context/skills/gather-context/SKILL.md`
45. Bash `wc -l /home/hwidong/codes/claude-plugins/plugins/gather-context/skills/gather-co`
46. TaskUpdate #6 → completed
47. TaskUpdate #7 → in_progress
48. Read `/home/hwidong/codes/claude-plugins/plugins/gather-context/.claude-plugin/plugin.json`
49. Edit `/home/hwidong/codes/claude-plugins/plugins/gather-context/.claude-plugin/plugin.json`
50. TaskUpdate #7 → completed
51. TaskUpdate #8 → in_progress
52. Edit `/home/hwidong/codes/claude-plugins/plugins/web-search/skills/web-search/SKILL.md`
53. Read `/home/hwidong/codes/claude-plugins/plugins/web-search/.claude-plugin/plugin.json`
54. Edit `/home/hwidong/codes/claude-plugins/plugins/web-search/.claude-plugin/plugin.json`
55. Edit `/home/hwidong/codes/claude-plugins/.claude-plugin/marketplace.json`
56. TaskUpdate #8 → completed
57. TaskUpdate #9 → in_progress
58. Edit `/home/hwidong/codes/claude-plugins/README.md`
59. Edit `/home/hwidong/codes/claude-plugins/README.md`
60. Edit `/home/hwidong/codes/claude-plugins/README.md`
61. Edit `/home/hwidong/codes/claude-plugins/README.ko.md`
62. Edit `/home/hwidong/codes/claude-plugins/README.ko.md`
63. Edit `/home/hwidong/codes/claude-plugins/README.ko.md`
64. TaskUpdate #9 → completed
65. TaskUpdate #10 → in_progress
66. Bash `echo '{}' | /home/hwidong/codes/claude-plugins/plugins/gather-context/hooks/scri`
67. Bash `ls -la /home/hwidong/codes/claude-plugins/plugins/gather-context/skills/gather-c`
68. Bash `python3 -m json.tool /home/hwidong/codes/claude-plugins/plugins/gather-context/.`
69. Bash `find /home/hwidong/codes/claude-plugins/plugins/gather-context -type f | sort`
70. Bash `diff /home/hwidong/codes/claude-plugins/plugins/web-search/skills/web-search/scr`
71. TaskUpdate #10 → completed
